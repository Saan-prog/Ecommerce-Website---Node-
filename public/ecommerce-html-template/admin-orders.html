<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShopStyle - Admin Orders</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Source+Code+Pro:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Open Sans", sans-serif;
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      /* Admin Layout */
      .admin-container {
        min-height: 100vh;
      }

      /* Sidebar */
      .admin-sidebar {
        width: 250px;
        background: #2c3e50;
        color: white;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: all 0.3s;
        z-index: 1000;
      }

      .sidebar-brand {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #34495e;
        background: #1a252f;
      }

      .sidebar-brand h2 {
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar-brand i {
        margin-right: 10px;
        color: #e74c3c;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .sidebar-menu li a {
        color: #bdc3c7;
        padding: 15px 20px;
        display: block;
        text-decoration: none;
        transition: all 0.3s;
        border-left: 3px solid transparent;
      }

      .sidebar-menu li a:hover,
      .sidebar-menu li a.active {
        background: #34495e;
        color: white;
        border-left: 3px solid #e74c3c;
      }

      .sidebar-menu li a i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .admin-main {
        flex: 1;
        margin-left: 250px;
        transition: all 0.3s;
      }

      .admin-header {
        background: white;
        padding: 15px 30px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .admin-user {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .admin-user span {
        color: #2c3e50;
        font-weight: 600;
      }

      .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      .logout-btn i {
        margin-right: 5px;
      }

      .admin-content {
        padding: 30px;
      }

      /* Order Summary Cards */
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .summary-icon.pending {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .summary-icon.processing {
        background: linear-gradient(135deg, #3498db, #2980b9);
      }

      .summary-icon.shipped {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
      }

      .summary-icon.delivered {
        background: linear-gradient(135deg, #27ae60, #229954);
      }

      .summary-icon.cancelled {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .summary-info h3 {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .summary-info p {
        color: #7f8c8d;
        font-size: 14px;
      }

      /* Simple Filter Section */
      .simple-filter {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .status-filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .status-filter-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        background: #ecf0f1;
        color: #7f8c8d;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .status-filter-btn:hover {
        background: #d5dbdb;
      }

      .status-filter-btn.active {
        background: #3498db;
        color: white;
      }

      .reset-filter-btn {
        margin-left: auto;
        background: #95a5a6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .reset-filter-btn:hover {
        background: #7f8c8d;
      }

      /* Orders Table Styles */
      .orders-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-top: 20px;
      }

      .orders-table {
        width: 100%;
        border-collapse: collapse;
      }

      .orders-table th {
        background: #34495e;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #2c3e50;
      }

      .orders-table td {
        padding: 15px;
        border-bottom: 1px solid #ecf0f1;
        vertical-align: middle;
      }

      .orders-table tr:hover {
        background: #f8f9fa;
      }

      .orders-table tr:last-child td {
        border-bottom: none;
      }

      /* Order Info */
      .order-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .order-id {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
        cursor: pointer;
        transition: color 0.3s;
      }

      .order-id:hover {
        color: #3498db;
        text-decoration: underline;
      }

      .order-date {
        font-size: 12px;
        color: #7f8c8d;
      }

      /* Customer Info */
      .customer-info {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .customer-name {
        font-weight: 600;
        color: #2c3e50;
      }

      .customer-email {
        font-size: 12px;
        color: #7f8c8d;
      }

      /* Status Badges */
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-processing {
        background: #cce5ff;
        color: #004085;
      }

      .status-shipped {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-delivered {
        background: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .status-refunded {
        background: #e2e3e5;
        color: #383d41;
      }

      /* Payment Status */
      .payment-status {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .payment-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .payment-paid {
        background: #27ae60;
      }

      .payment-pending {
        background: #f39c12;
      }

      .payment-failed {
        background: #e74c3c;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-view {
        background: #3498db;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-view:hover {
        background: #2980b9;
      }

      .btn-update {
        background: #2ecc71;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-update:hover {
        background: #27ae60;
      }

      .btn-print {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-print:hover {
        background: #7f8c8d;
      }

      /* Pagination */
      .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
      }

      .pagination {
        display: flex;
        gap: 5px;
      }

      .page-item {
        display: inline-block;
      }

      .page-link {
        color: #3498db;
        border-radius: 4px;
        padding: 8px 12px;
        text-decoration: none;
        border: 1px solid #ddd;
        display: block;
      }

      .page-item.active .page-link {
        background: #3498db;
        color: white;
        border: 1px solid #3498db;
      }

      .page-item.disabled .page-link {
        color: #bdc3c7;
        cursor: not-allowed;
      }

      .page-link:hover {
        background: #e8f3fc;
      }

      /* Loading and Error States */
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #7f8c8d;
      }

      .error {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #e74c3c;
        background: white;
        border-radius: 8px;
        margin: 20px 0;
      }

      .no-orders {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        background: white;
        border-radius: 8px;
        margin: 20px 0;
      }

      /* Order Details Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 15px;
      }

      .modal-title {
        font-size: 24px;
        color: #2c3e50;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        color: #7f8c8d;
        cursor: pointer;
      }

      .close-modal:hover {
        color: #e74c3c;
      }

      .order-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .detail-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
      }

      .detail-card h4 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 16px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .detail-label {
        color: #7f8c8d;
      }

      .detail-value {
        color: #2c3e50;
        font-weight: 500;
      }

      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      .items-table th {
        background: #34495e;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
      }

      .items-table td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
      }

      .item-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
      }

      .total-section {
        text-align: right;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #ecf0f1;
      }

      .total-row {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 8px;
      }

      .total-label {
        min-width: 120px;
        text-align: right;
        color: #7f8c8d;
      }

      .total-value {
        min-width: 100px;
        text-align: right;
        font-weight: 600;
        color: #2c3e50;
      }

      .grand-total {
        font-size: 20px;
        color: #27ae60;
        font-weight: 700;
      }

      /* Status Update Modal */
      .status-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
      }

      .status-option {
        flex: 1;
        min-width: 120px;
      }

      .status-option input {
        display: none;
      }

      .status-option label {
        display: block;
        padding: 10px;
        text-align: center;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .status-option input:checked + label {
        border-color: #3498db;
        background: #3498db;
        color: white;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .admin-sidebar {
          width: 70px;
        }

        .admin-sidebar .sidebar-brand h2 span,
        .admin-sidebar .sidebar-menu li a span {
          display: none;
        }

        .admin-sidebar .sidebar-menu li a i {
          margin-right: 0;
          font-size: 18px;
        }

        .admin-main {
          margin-left: 70px;
        }

        .orders-table {
          display: block;
          overflow-x: auto;
        }

        .simple-filter {
          flex-direction: column;
          align-items: stretch;
        }

        .status-filter-buttons {
          justify-content: center;
        }

        .reset-filter-btn {
          margin-left: 0;
        }

        .summary-cards {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 2% auto;
          padding: 15px;
        }

        .order-details-grid {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <!-- Sidebar -->
      <div class="admin-sidebar">
        <div class="sidebar-brand">
          <h2>
            <i class="fas fa-user-shield"></i> <span>ShopStyle Admin</span>
          </h2>
        </div>
        <ul class="sidebar-menu">
          <li>
            <a href="admin-dashboard.html"
              ><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a
            >
          </li>
          <li>
            <a href="admin-showusers.html"
              ><i class="fas fa-users"></i> <span>Users</span></a
            >
          </li>
          <li>
            <a href="admin-orders.html" class="active"
              ><i class="fas fa-shopping-cart"></i> <span>Orders</span></a
            >
          </li>
          <li>
            <a href="admin-products.html"
              ><i class="fas fa-box"></i> <span>Products</span></a
            >
          </li>
          <li>
            <a href="admin-categories.html"
              ><i class="fas fa-tags"></i> <span>Categories</span></a
            >
          </li>
          <li>
            <a href="admin-inventory.html"
              ><i class="fas fa-warehouse"></i> <span>Inventory</span></a
            >
          </li>
          <li>
            <a href="admin-reports.html"
              ><i class="fas fa-chart-bar"></i> <span>Reports</span></a
            >
          </li>
          <li>
            <a href="#" id="logoutBtn"
              ><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a
            >
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="admin-main">
        <div class="admin-header">
          <h1>Order Management</h1>
          <div class="admin-user">
            <span id="adminNameDisplay">Admin</span>
            <button class="logout-btn" id="logoutBtnHeader">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>

        <div class="admin-content">
          <!-- Order Summary Cards -->
          <div class="summary-cards" id="summaryCards">
            <div class="summary-card" onclick="loadOrders(1, '')">
              <div class="summary-icon pending">
                <i class="fas fa-clock"></i>
              </div>
              <div class="summary-info">
                <h3 id="pendingCount">0</h3>
                <p>Pending Orders</p>
              </div>
            </div>
            <div class="summary-card" onclick="loadOrders(1, 'processing')">
              <div class="summary-icon processing">
                <i class="fas fa-cog"></i>
              </div>
              <div class="summary-info">
                <h3 id="processingCount">0</h3>
                <p>Processing</p>
              </div>
            </div>
            <div class="summary-card" onclick="loadOrders(1, 'shipped')">
              <div class="summary-icon shipped">
                <i class="fas fa-shipping-fast"></i>
              </div>
              <div class="summary-info">
                <h3 id="shippedCount">0</h3>
                <p>Shipped</p>
              </div>
            </div>
            <div class="summary-card" onclick="loadOrders(1, 'delivered')">
              <div class="summary-icon delivered">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="summary-info">
                <h3 id="deliveredCount">0</h3>
                <p>Delivered</p>
              </div>
            </div>
            <div class="summary-card" onclick="loadOrders(1, 'cancelled')">
              <div class="summary-icon cancelled">
                <i class="fas fa-times-circle"></i>
              </div>
              <div class="summary-info">
                <h3 id="cancelledCount">0</h3>
                <p>Cancelled</p>
              </div>
            </div>
          </div>

          <!-- Simple Status Filter -->
          <div class="simple-filter">
            <div class="status-filter-buttons" id="statusFilterButtons">
              <button class="status-filter-btn active" data-status="">
                All Orders
              </button>
              <button class="status-filter-btn" data-status="pending">
                Pending
              </button>
              <button class="status-filter-btn" data-status="processing">
                Processing
              </button>
              <button class="status-filter-btn" data-status="shipped">
                Shipped
              </button>
              <button class="status-filter-btn" data-status="delivered">
                Delivered
              </button>
              <button class="status-filter-btn" data-status="cancelled">
                Cancelled
              </button>
            </div>
            <button class="reset-filter-btn" id="resetFilterBtn">
              <i class="fas fa-redo"></i> Show All Orders
            </button>
          </div>

          <!-- Orders Table -->
          <div class="orders-table-container">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payment</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="orders-table-body">
                <!-- Orders will be loaded here dynamically -->
                <tr>
                  <td colspan="7" class="loading">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-container">
            <ul class="pagination" id="pagination-container">
              <!-- Pagination will be loaded here dynamically -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Order Details</h2>
          <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div id="orderDetailsContent">
          <!-- Order details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Update Order Status</h2>
          <button class="close-modal" id="closeStatusModal">&times;</button>
        </div>
        <div id="statusUpdateContent">
          <!-- Status update form will be loaded here -->
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Authentication check
      (function checkAuth() {
        const token = localStorage.getItem("adminToken");
        const isLoggedIn = localStorage.getItem("adminLoggedIn") === "true";

        if (!token || !isLoggedIn) {
          window.location.href = "admin-login.html";
          return;
        }
      })();

      let currentPage = 1;
      const ordersPerPage = 10;
      let currentStatus = "";
      let currentOrderId = null;

      // Load orders summary
      async function loadOrdersSummary() {
        try {
          const token = localStorage.getItem("adminToken");
          if (!token) return;

          const response = await fetch("/api/admin/orders/summary", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              document.getElementById("pendingCount").textContent =
                data.summary.pending || 0;
              document.getElementById("processingCount").textContent =
                data.summary.processing || 0;
              document.getElementById("shippedCount").textContent =
                data.summary.shipped || 0;
              document.getElementById("deliveredCount").textContent =
                data.summary.delivered || 0;
              document.getElementById("cancelledCount").textContent =
                data.summary.cancelled || 0;
            }
          }
        } catch (error) {
          console.error("Error loading orders summary:", error);
        }
      }

      // Load orders from API
      async function loadOrders(page = 1, status = "") {
        try {
          const token = localStorage.getItem("adminToken");
          if (!token) {
            window.location.href = "admin-login.html";
            return;
          }

          currentPage = page;
          currentStatus = status;
          
          // Update active filter button
          updateActiveFilterButton(status);
          
          const tableBody = document.getElementById("orders-table-body");
          tableBody.innerHTML =
            '<tr><td colspan="7" class="loading">Loading orders...</td></tr>';

          // Build query parameters
          const params = new URLSearchParams({
            page: page,
            limit: ordersPerPage,
          });

          // Add status filter if specified
          if (status) {
            params.append("status", status);
          }

          console.log("Fetching orders with params:", params.toString());

          const response = await fetch(
            `/api/admin/orders?${params.toString()}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              alert("Session expired. Please login again.");
              window.location.href = "admin-login.html";
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Orders data:", data);

          if (data.success) {
            renderOrdersTable(data.orders);
            setupPagination(data.pagination);
          } else {
            throw new Error(data.message || "Failed to load orders");
          }
        } catch (error) {
          console.error("Error loading orders:", error);
          document.getElementById("orders-table-body").innerHTML =
            '<tr><td colspan="7" class="error">Error loading orders. Please try again.</td></tr>';
        }
      }

      // Update active filter button
      function updateActiveFilterButton(status) {
        const buttons = document.querySelectorAll(".status-filter-btn");
        buttons.forEach(button => {
          const buttonStatus = button.getAttribute("data-status");
          if (buttonStatus === status) {
            button.classList.add("active");
          } else {
            button.classList.remove("active");
          }
        });
      }

      // Render orders table
      function renderOrdersTable(orders) {
        const tableBody = document.getElementById("orders-table-body");
        tableBody.innerHTML = "";

        if (!orders || orders.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" class="no-orders">No orders found for this status.</td></tr>';
          return;
        }

        orders.forEach((order) => {
          // Format date
          const orderDate = new Date(order.createdAt);
          const formattedDate = orderDate.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });

          // Determine status badge class
          let statusClass = "";
          switch (order.status) {
            case "pending":
              statusClass = "status-pending";
              break;
            case "processing":
              statusClass = "status-processing";
              break;
            case "shipped":
              statusClass = "status-shipped";
              break;
            case "delivered":
              statusClass = "status-delivered";
              break;
            case "cancelled":
              statusClass = "status-cancelled";
              break;
            case "refunded":
              statusClass = "status-refunded";
              break;
          }

          // Determine payment status dot
          let paymentDotClass = "";
          switch (order.paymentStatus) {
            case "paid":
              paymentDotClass = "payment-paid";
              break;
            case "pending":
              paymentDotClass = "payment-pending";
              break;
            case "failed":
              paymentDotClass = "payment-failed";
              break;
          }

          const orderRow = `
          <tr>
            <td>
              <div class="order-info">
                <div class="order-id" onclick="viewOrderDetails('${
                  order._id
                }')">
                  ${order.orderId || order._id}
                </div>
              </div>
            </td>
            <td>
              <div class="customer-info">
                <div class="customer-name">${order.userId?.name || "N/A"}</div>
                <div class="customer-email">${order.userId?.email || "N/A"}</div>
              </div>
            </td>
            <td>${formattedDate}</td>
            <td>
              <strong>$${order.totalAmount?.toFixed(2) || "0.00"}</strong>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${order.status}</span>
            </td>
            <td>
              <div class="payment-status">
                <span class="payment-dot ${paymentDotClass}"></span>
                <span>${order.paymentStatus || "N/A"}</span>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-view" onclick="viewOrderDetails('${
                  order._id
                }')">
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-update" onclick="updateOrderStatus('${
                  order._id
                }')">
                  <i class="fas fa-edit"></i> Update
                </button>
              </div>
            </td>
          </tr>
        `;
          tableBody.innerHTML += orderRow;
        });
      }

      // Setup pagination
      function setupPagination(pagination) {
        const paginationContainer = document.getElementById(
          "pagination-container"
        );
        if (!paginationContainer) return;

        paginationContainer.innerHTML = "";

        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${
          !pagination.hasPrevPage ? "disabled" : ""
        }`;
        prevLi.innerHTML = `<a class="page-link" href="#" ${
          pagination.hasPrevPage
            ? 'onclick="loadOrders(' + (currentPage - 1) + ', currentStatus)"'
            : ""
        }>Previous</a>`;
        paginationContainer.appendChild(prevLi);

        // Page numbers
        for (let i = 1; i <= pagination.totalPages; i++) {
          const pageLi = document.createElement("li");
          pageLi.className = `page-item ${i === currentPage ? "active" : ""}`;
          pageLi.innerHTML = `<a class="page-link" href="#" onclick="loadOrders(${i}, currentStatus)">${i}</a>`;
          paginationContainer.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${
          !pagination.hasNextPage ? "disabled" : ""
        }`;
        nextLi.innerHTML = `<a class="page-link" href="#" ${
          pagination.hasNextPage
            ? 'onclick="loadOrders(' + (currentPage + 1) + ', currentStatus)"'
            : ""
        }>Next</a>`;
        paginationContainer.appendChild(nextLi);
      }

      // View order details
      async function viewOrderDetails(orderId) {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/orders/${orderId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              displayOrderDetails(data.order);
              showModal("orderDetailsModal");
            }
          }
        } catch (error) {
          console.error("Error loading order details:", error);
          alert("Error loading order details");
        }
      }

      // Display order details in modal
      function displayOrderDetails(order) {
        const content = document.getElementById("orderDetailsContent");
        
        // Format dates
        const orderDate = new Date(order.createdAt);
        const formattedOrderDate = orderDate.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        // Build order items table
        let itemsTable = "";
        if (order.items && order.items.length > 0) {
          itemsTable = `
            <table class="items-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${order.items
                  .map(
                    (item) => `
                  <tr>
                    <td>
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${
                          item.productId?.images?.[0]
                            ? `/uploads/${item.productId.images[0].replace(/\\/g, "/")}`
                            : "https://via.placeholder.com/50x50?text=No+Image"
                        }" 
                             alt="${item.productId?.name || "Product"}" 
                             class="item-image">
                        <div>
                          <strong>${item.productId?.name || "Unknown Product"}</strong><br>
                          <small>${item.productId?.brand || "No Brand"}</small>
                        </div>
                      </div>
                    </td>
                    <td>$${item.price?.toFixed(2) || "0.00"}</td>
                    <td>${item.quantity || 0}</td>
                    <td>$${((item.price || 0) * (item.quantity || 0)).toFixed(
                      2
                    )}</td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
        }

        content.innerHTML = `
          <div class="order-details-grid">
            <div class="detail-card">
              <h4>Order Information</h4>
              <div class="detail-item">
                <span class="detail-label">Order ID:</span>
                <span class="detail-value">${order.orderId || order._id}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Date:</span>
                <span class="detail-value">${formattedOrderDate}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Status:</span>
                <span class="detail-value">
                  <span class="status-badge status-${order.status}">
                    ${order.status}
                  </span>
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Payment Status:</span>
                <span class="detail-value">
                  <div class="payment-status">
                    <span class="payment-dot payment-${order.paymentStatus}"></span>
                    ${order.paymentStatus}
                  </div>
                </span>
              </div>
            </div>

            <div class="detail-card">
              <h4>Customer Information</h4>
              <div class="detail-item">
                <span class="detail-label">Name:</span>
                <span class="detail-value">${order.userId?.name || "N/A"}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Email:</span>
                <span class="detail-value">${order.userId?.email || "N/A"}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Phone:</span>
                <span class="detail-value">${order.shippingAddress?.phone || "N/A"}</span>
              </div>
            </div>

            <div class="detail-card">
              <h4>Shipping Address</h4>
              <div class="detail-item">
                <span class="detail-label">Address:</span>
                <span class="detail-value">${
                  order.shippingAddress?.street || "N/A"
                }</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">City:</span>
                <span class="detail-value">${
                  order.shippingAddress?.city || "N/A"
                }</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">State:</span>
                <span class="detail-value">${
                  order.shippingAddress?.state || "N/A"
                }</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ZIP Code:</span>
                <span class="detail-value">${
                  order.shippingAddress?.zipCode || "N/A"
                }</span>
              </div>
            </div>

            <div class="detail-card">
              <h4>Payment Information</h4>
              <div class="detail-item">
                <span class="detail-label">Method:</span>
                <span class="detail-value">${
                  order.paymentMethod || "N/A"
                }</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Transaction ID:</span>
                <span class="detail-value">${
                  order.paymentId || "N/A"
                }</span>
              </div>
            </div>
          </div>

          <h4>Order Items</h4>
          ${itemsTable}

          <div class="total-section">
            <div class="total-row">
              <span class="total-label">Subtotal:</span>
              <span class="total-value">$${order.subtotal?.toFixed(2) || "0.00"}</span>
            </div>
            <div class="total-row">
              <span class="total-label">Shipping:</span>
              <span class="total-value">$${order.shippingCost?.toFixed(2) || "0.00"}</span>
            </div>
            <div class="total-row">
              <span class="total-label">Tax:</span>
              <span class="total-value">$${order.tax?.toFixed(2) || "0.00"}</span>
            </div>
            <div class="total-row">
              <span class="total-label">Discount:</span>
              <span class="total-value">-$${order.discount?.toFixed(2) || "0.00"}</span>
            </div>
            <div class="total-row grand-total">
              <span class="total-label">Grand Total:</span>
              <span class="total-value">$${order.totalAmount?.toFixed(2) || "0.00"}</span>
            </div>
          </div>
        `;
      }

      // Update order status
      async function updateOrderStatus(orderId) {
        currentOrderId = orderId;
        
        // First get current order to pre-select status
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/orders/${orderId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              showStatusUpdateModal(data.order);
            }
          }
        } catch (error) {
          console.error("Error loading order for update:", error);
        }
      }

      // Show status update modal
      function showStatusUpdateModal(order) {
        const content = document.getElementById("statusUpdateContent");
        content.innerHTML = `
          <p>Update status for order: <strong>${order.orderId || order._id}</strong></p>
          <p>Current status: <span class="status-badge status-${order.status}">${order.status}</span></p>
          
          <div class="status-options">
            <div class="status-option">
              <input type="radio" id="status-pending" name="orderStatus" value="pending" ${
                order.status === "pending" ? "checked" : ""
              }>
              <label for="status-pending" class="status-badge status-pending">Pending</label>
            </div>
            <div class="status-option">
              <input type="radio" id="status-processing" name="orderStatus" value="processing" ${
                order.status === "processing" ? "checked" : ""
              }>
              <label for="status-processing" class="status-badge status-processing">Processing</label>
            </div>
            <div class="status-option">
              <input type="radio" id="status-shipped" name="orderStatus" value="shipped" ${
                order.status === "shipped" ? "checked" : ""
              }>
              <label for="status-shipped" class="status-badge status-shipped">Shipped</label>
            </div>
            <div class="status-option">
              <input type="radio" id="status-delivered" name="orderStatus" value="delivered" ${
                order.status === "delivered" ? "checked" : ""
              }>
              <label for="status-delivered" class="status-badge status-delivered">Delivered</label>
            </div>
            <div class="status-option">
              <input type="radio" id="status-cancelled" name="orderStatus" value="cancelled" ${
                order.status === "cancelled" ? "checked" : ""
              }>
              <label for="status-cancelled" class="status-badge status-cancelled">Cancelled</label>
            </div>
          </div>
          
          <div class="modal-actions">
            <button class="btn-reset" onclick="closeModal('statusUpdateModal')">
              Cancel
            </button>
            <button class="btn-filter" onclick="saveOrderStatus()">
              <i class="fas fa-save"></i> Update Status
            </button>
          </div>
        `;
        
        showModal("statusUpdateModal");
      }

      // Save order status
      async function saveOrderStatus() {
        try {
          const status = document.querySelector('input[name="orderStatus"]:checked')?.value;
          if (!status) {
            alert("Please select a status");
            return;
          }

          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/orders/${currentOrderId}/status`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status }),
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              alert("Order status updated successfully");
              closeModal("statusUpdateModal");
              loadOrders(currentPage, currentStatus);
              loadOrdersSummary();
            } else {
              alert("Error: " + data.message);
            }
          } else {
            alert("Error updating order status");
          }
        } catch (error) {
          console.error("Error updating order status:", error);
          alert("Error updating order status");
        }
      }

      // Modal functions
      function showModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Setup event listeners
      function setupEventListeners() {
        // Status filter buttons
        const statusButtons = document.querySelectorAll(".status-filter-btn");
        statusButtons.forEach(button => {
          button.addEventListener("click", function() {
            const status = this.getAttribute("data-status");
            loadOrders(1, status);
          });
        });

        // Reset filter button
        const resetFilterBtn = document.getElementById("resetFilterBtn");
        if (resetFilterBtn) {
          resetFilterBtn.addEventListener("click", function() {
            loadOrders(1, "");
          });
        }

        // Close modal buttons
        const closeModalBtn = document.getElementById("closeModal");
        if (closeModalBtn) {
          closeModalBtn.addEventListener("click", function () {
            closeModal("orderDetailsModal");
          });
        }

        const closeStatusModal = document.getElementById("closeStatusModal");
        if (closeStatusModal) {
          closeStatusModal.addEventListener("click", function () {
            closeModal("statusUpdateModal");
          });
        }

        // Close modals when clicking outside
        window.addEventListener("click", function (event) {
          const modals = document.querySelectorAll(".modal");
          modals.forEach((modal) => {
            if (event.target === modal) {
              modal.style.display = "none";
            }
          });
        });
      }

      // Logout function
      function logout() {
        localStorage.removeItem("adminToken");
        localStorage.removeItem("adminLoggedIn");
        localStorage.removeItem("adminId");
        localStorage.removeItem("adminName");
        window.location.href = "admin-login.html";
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Add logout event listeners
        const logoutBtn = document.getElementById("logoutBtn");
        const logoutBtnHeader = document.getElementById("logoutBtnHeader");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });
        }
        if (logoutBtnHeader) {
          logoutBtnHeader.addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });
        }

        // Display admin name if available
        const adminName = localStorage.getItem("adminName");
        if (adminName) {
          const adminNameElement = document.getElementById("adminNameDisplay");
          if (adminNameElement) {
            adminNameElement.textContent = adminName;
          }
        }

        // Load orders summary
        loadOrdersSummary();

        // Load all orders initially
        loadOrders(1, "");
        setupEventListeners();
      });
    </script>
  </body>
</html>