<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShopStyle - Admin Products</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Source+Code+Pro:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">

    <style>
      body {
        font-family: "Open Sans", sans-serif;
        background-color: #f5f7fa;
        margin: 0;
      }

      /* Sidebar */
      .admin-sidebar {
        width: 250px;
        background: #2c3e50;
        color: white;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-brand {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #34495e;
        background: #1a252f;
        font-weight: 700;
      }

      .sidebar-brand h2 {
        font-size: 22px;
        margin: 0;
        color: white;
      }

      .sidebar-brand i {
        color: #e74c3c;
        margin-right: 8px;
      }

      .sidebar-menu li a {
        color: #bdc3c7;
        padding: 15px 20px;
        display: block;
        text-decoration: none;
        border-left: 3px solid transparent;
      }

      .sidebar-menu li a:hover,
      .sidebar-menu li a.active {
        background: #34495e;
        color: white;
        border-left: 3px solid #e74c3c;
      }

      .admin-main {
        margin-left: 250px;
        padding: 30px;
        min-height: 100vh;
        transition: all 0.3s ease;
      }

      @media (max-width: 768px) {
        .admin-sidebar {
          width: 70px;
        }
        .admin-main {
          margin-left: 70px;
        }
        .sidebar-brand span,
        .sidebar-menu li a span {
          display: none;
        }
      }

      .admin-form-container {
        max-width: 1000px;
        margin: auto;
      }

      /* Image Preview Styling */
      .image-preview-item .btn-close {
        opacity: 0.7;
        background-size: 0.6rem;
        width: 1.2rem;
        height: 1.2rem;
        background-color: rgba(255, 255, 255, 0.9) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .image-preview-item .btn-close:hover {
        opacity: 1;
        background-color: #dc3545 !important;
        color: white;
      }

      .image-preview-item {
        transition: transform 0.2s;
      }

      .image-preview-item:hover {
        transform: scale(1.03);
      }

      .image-preview-item .card {
        border: 2px solid #dee2e6;
        transition: border-color 0.2s;
      }

      .image-preview-item .card:hover {
        border-color: #0d6efd;
      }

      .preview-image {
        height: 100px;
        object-fit: cover;
        width: 100%;
      }

      .file-info {
        font-size: 0.75rem;
      }
    </style>
  </head>

  <body>
    <!-- SIDEBAR -->
    <div class="admin-sidebar">
      <div class="sidebar-brand">
        <h2><i class="fas fa-user-shield"></i> <span>ShopStyle Admin</span></h2>
      </div>

      <ul class="sidebar-menu list-unstyled">
        <li>
          <a href="admin-dashboard.html"
            ><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a
          >
        </li>
        <li>
          <a href="admin-showusers.html"
            ><i class="fas fa-users"></i> <span>Users</span></a
          >
        </li>
        <li>
          <a href="admin-orders.html"
            ><i class="fas fa-shopping-cart"></i> <span>Orders</span></a
          >
        </li>
        <li>
          <a href="admin-products.html" class="active"
            ><i class="fas fa-box"></i> <span>Products</span></a
          >
        </li>
        <li>
          <a href="admin-categories.html"
            ><i class="fas fa-tags"></i> <span>Categories</span></a
          >
        </li>
        <li>
          <a href="admin-coupon.html"
            ><i class="fas fa-warehouse"></i> <span>Coupons</span></a
          >
        </li>
        <li>
          <a href="admin-reports.html"
            ><i class="fas fa-chart-bar"></i> <span>Reports</span></a
          >
        </li>
        <li>
          <a href="#" id="logoutBtn"
            ><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a
          >
        </li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="admin-main">
      <div class="admin-header mb-3">
        <h1 class="fw-bold">Add Product</h1>
      </div>

      <div class="admin-form-container">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h4 class="mb-0">Add New Product</h4>
          </div>

          <div class="card-body">
            <!-- FORM WITH JS SUBMISSION -->
            <form id="addProductForm" enctype="multipart/form-data">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Product Name</label>
                  <input
                    type="text"
                    name="name"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Brand</label>
                  <input
                    type="text"
                    name="brand"
                    class="form-control"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  name="description"
                  rows="3"
                  class="form-control"
                  required
                ></textarea>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Price</label>
                  <input
                    type="number"
                    name="price"
                    class="form-control"
                    step="0.01"
                    min="0"
                    required
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select name="status" class="form-select" required>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="discontinued">Discontinued</option>
                    <option value="out_of_stock">Out of Stock</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Availability</label>
                  <select name="isAvailable" class="form-select" required>
                    <option value="true">Available (true)</option>
                    <option value="false">Not Available (false)</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Category</label>
                  <select
                    id="categorySelect"
                    name="category"
                    class="form-select"
                    required
                  >
                    <option value="">Select Category</option>
                    <!-- Options will be populated by JavaScript -->
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Subcategory</label>
                  <select
                    id="subcategorySelect"
                    name="subcategory"
                    class="form-select"
                    required
                    disabled
                  >
                    <option value="">Select Category First</option>
                    <!-- Options will be populated by JavaScript -->
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Product Images</label>
                <input
                  type="file"
                  id="imageInput"
                  name="image"
                  class="form-control"
                  accept="image/jpeg,image/png,image/jpg"
                  multiple
                  required
                />
                <small class="form-text text-muted">
                  Select up to 5 images (JPEG, PNG format). Click the X button to remove individual images.
                </small>
              </div>

              <div class="row mb-4">
                <div class="col-12">
                  <div id="imagePreview" class="d-flex flex-wrap gap-3 mt-3" style="min-height: 120px;"></div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-plus-circle me-2"></i> Add Product
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
 <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
              const notyf = new Notyf({
    duration: 3000, // 3 seconds
    position: {
      x: 'right',
      y: 'top',
    },
    types: [
      {
        type: 'success',
        background: '#28a745',
        icon: {
          className: 'fas fa-check-circle',
          tagName: 'i',
          color: '#fff'
        }
      },
      {
        type: 'error',
        background: '#dc3545',
        icon: {
          className: 'fas fa-exclamation-circle',
          tagName: 'i',
          color: '#fff'
        }
      },
      {
        type: 'warning',
        background: '#ffc107',
        icon: {
          className: 'fas fa-exclamation-triangle',
          tagName: 'i',
          color: '#fff'
        }
      },
      {
        type: 'info',
        background: '#17a2b8',
        icon: {
          className: 'fas fa-info-circle',
          tagName: 'i',
          color: '#fff'
        }
      }
    ]
  });
    
  // Global variables
  let selectedFiles = [];
  let previewIndexMap = new Map(); // To track preview indexes

  // Image preview with cross button functionality
  document.getElementById('imageInput').addEventListener('change', function(e) {
    const previewContainer = document.getElementById('imagePreview');
    previewContainer.innerHTML = '';
    previewIndexMap.clear();
    
    const files = Array.from(e.target.files);
    
    // Validate file count
    if (files.length > 5) {
      notyf.warning('Maximum 5 images allowed');
      this.value = '';
      return;
    }
    
    // Validate file types and sizes
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    // Reset selectedFiles
    selectedFiles = [];
    
    files.forEach((file, originalIndex) => {
      // Type validation
      if (!validTypes.includes(file.type)) {
        notyf.warning(`File ${file.name} is not a valid image type (JPEG/PNG only)`);
        this.value = '';
        return;
      }
      
      // Size validation
      if (file.size > maxSize) {
        notyf.warning(`File ${file.name} is too large (max 5MB)`);
        this.value = '';
        return;
      }
      
      // Add to selectedFiles array
      const currentIndex = selectedFiles.length;
      selectedFiles.push(file);
      
      // Store the mapping between preview element and file index
      const previewId = `preview-${Date.now()}-${currentIndex}`;
      
      // Create preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview-item';
        previewDiv.id = previewId;
        previewDiv.innerHTML = `
          <div class="card position-relative" style="width: 140px;">
            <button type="button" 
                    class="btn-close position-absolute top-0 end-0 m-1" 
                    onclick="removeImageById('${previewId}')" 
                    aria-label="Remove image"
                    style="z-index: 10;">
            </button>
            <img src="${e.target.result}" 
                 class="card-img-top preview-image" 
                 alt="${file.name}">
            <div class="card-body p-2">
              <small class="text-muted d-block text-truncate" style="max-width: 120px;">
                ${file.name}
              </small>
              <small class="text-muted file-info">
                ${(file.size / 1024).toFixed(1)} KB
              </small>
            </div>
          </div>
        `;
        previewContainer.appendChild(previewDiv);
        // Store mapping between preview ID and file index
        previewIndexMap.set(previewId, currentIndex);
      };
      reader.readAsDataURL(file);
    });
  });

  // Function to remove individual image by preview ID
  function removeImageById(previewId) {
    const index = previewIndexMap.get(previewId);
    if (index !== undefined) {
      removeImage(index);
    }
  }

  // Function to remove individual image by index
  function removeImage(index) {
    if (index >= 0 && index < selectedFiles.length) {
      // Remove from array
      selectedFiles.splice(index, 1);
      
      // Update preview
      updateImagePreview();
      
      // Update file input
      updateFileInput();
    }
  }

  // Function to update image preview
  function updateImagePreview() {
    const previewContainer = document.getElementById('imagePreview');
    previewContainer.innerHTML = '';
    previewIndexMap.clear();
    
    if (selectedFiles.length === 0) {
      // Clear file input
      document.getElementById('imageInput').value = '';
      return;
    }
    
    selectedFiles.forEach((file, index) => {
      const previewId = `preview-${Date.now()}-${index}`;
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview-item';
        previewDiv.id = previewId;
        previewDiv.innerHTML = `
          <div class="card position-relative" style="width: 140px;">
            <button type="button" 
                    class="btn-close position-absolute top-0 end-0 m-1" 
                    onclick="removeImageById('${previewId}')" 
                    aria-label="Remove image"
                    style="z-index: 10;">
            </button>
            <img src="${e.target.result}" 
                 class="card-img-top preview-image" 
                 alt="${file.name}">
            <div class="card-body p-2">
              <small class="text-muted d-block text-truncate" style="max-width: 120px;">
                ${file.name}
              </small>
              <small class="text-muted file-info">
                ${(file.size / 1024).toFixed(1)} KB
              </small>
            </div>
          </div>
        `;
        previewContainer.appendChild(previewDiv);
        previewIndexMap.set(previewId, index);
      };
      reader.readAsDataURL(file);
    });
  }

  // Function to update file input
  function updateFileInput() {
    // Create a new DataTransfer object
    const dataTransfer = new DataTransfer();
    
    // Add remaining files
    selectedFiles.forEach(file => {
      dataTransfer.items.add(file);
    });
    
    // Update file input
    document.getElementById('imageInput').files = dataTransfer.files;
  }

  // Enhanced form submission with validation
  document.getElementById("addProductForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Validate price
    const price = parseFloat(this.price.value);
    if (isNaN(price) || price < 0 || price > 10000000) {
      notyf.warning('Price must be between 0 and 10,000,000');
      return;
    }

    // Validate images
    if (selectedFiles.length === 0) {
      notyf.warning('Please select at least one product image');
      return;
    }

    // Validate category and subcategory
    if (!this.category.value) {
      notyf.warning('Please select a category');
      return;
    }
    if (!this.subcategory.value) {
      notyf.warning('Please select a subcategory');
      return;
    }

    const token = localStorage.getItem("adminToken");

    if (!token) {
      notyf.error("Error: No admin token found. Please log in again.");
      setTimeout(() => {
    window.location.href = 'admin-login.html';
  }, 1500);
      return;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Adding Product...';
    submitBtn.disabled = true;

    try {
      // Create FormData
      const formData = new FormData();
      
      // Add all form fields
      formData.append('name', this.name.value);
      formData.append('description', this.description.value);
      formData.append('price', this.price.value);
      formData.append('category', this.category.value);
      formData.append('subcategory', this.subcategory.value);
      formData.append('brand', this.brand.value);
      formData.append('status', this.status.value);
      formData.append('isAvailable', this.isAvailable.value);
      
      // Add image files
      selectedFiles.forEach(file => {
        formData.append('image', file);
      });

      // Log form data for debugging
      console.log("Form data:");
      for (let [key, value] of formData.entries()) {
        console.log(`${key}:`, value instanceof File ? `${value.name} (${value.size} bytes)` : value);
      }

      const response = await fetch("/api/admin/products/addProduct", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          // Don't set Content-Type for FormData
        },
        body: formData,
      });

      const result = await response.json();
      console.log("API Response:", result);

      if (result.success) {
        notyf.success(`✅ ${result.message}\nImages uploaded: ${result.imageCount || 0}`);
        this.reset();
        selectedFiles = [];
        previewIndexMap.clear();
        document.getElementById('imagePreview').innerHTML = '';
        
        // Reset subcategory dropdown
        document.getElementById('subcategorySelect').disabled = true;
        document.getElementById('subcategorySelect').innerHTML = 
          '<option value="">Select Category First</option>';
        
      } else {
        let errorMessage = result.message || "Failed to add product";
        if (result.errors && result.errors.length > 0) {
          errorMessage += "\n" + result.errors.join("\n");
        }
        notyf.error("❌ " + errorMessage);
      }
    } catch (error) {
      console.error("Submission error:", error);
      notyf.error("❌ Network error: " + error.message);
    } finally {
      // Restore button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });

  // Enhanced category loading
  async function loadCategories() {
    try {
      const token = localStorage.getItem("adminToken");
      
      if (!token) {
        console.error("No token found for category loading");
        return;
      }

      const response = await fetch(
        "/api/admin/products/getCategories",
        {
          headers: {
            Authorization: "Bearer " + token,
          },
        }
      );

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      console.log("Categories API response:", result);

      if (result.success && result.categories && result.categories.length > 0) {
        const categorySelect = document.getElementById("categorySelect");
        categorySelect.innerHTML = '<option value="">Select Category</option>';

        result.categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category._id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });
      } else {
        console.warn("No categories found or API returned unsuccessful");
      }
    } catch (error) {
      console.error("Error loading categories:", error);
      const categorySelect = document.getElementById("categorySelect");
      categorySelect.innerHTML = '<option value="">Error loading categories</option>';
    }
  }

  // Enhanced subcategory loading
  async function loadSubcategories(categoryId) {
    try {
      const token = localStorage.getItem("adminToken");
      
      if (!categoryId) {
        const subcategorySelect = document.getElementById("subcategorySelect");
        subcategorySelect.disabled = true;
        subcategorySelect.innerHTML = '<option value="">Select Category First</option>';
        return;
      }

      const response = await fetch(
        `/api/admin/products/getSubcategories/${categoryId}`,
        {
          headers: {
            Authorization: "Bearer " + token,
          },
        }
      );

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      console.log("Subcategories API response:", result);

      const subcategorySelect = document.getElementById("subcategorySelect");

      if (result.success) {
        subcategorySelect.disabled = false;
        subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';

        result.subcategories.forEach((subcategory) => {
          const option = document.createElement("option");
          option.value = subcategory._id;
          option.textContent = subcategory.name;
          subcategorySelect.appendChild(option);
        });
      } else {
        subcategorySelect.disabled = false;
        subcategorySelect.innerHTML = '<option value="">No subcategories available</option>';
      }
    } catch (error) {
      console.error("Error loading subcategories:", error);
      const subcategorySelect = document.getElementById("subcategorySelect");
      subcategorySelect.disabled = true;
      subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
    }
  }

  // Check authentication on page load
  document.addEventListener("DOMContentLoaded", function() {
    const token = localStorage.getItem("adminToken");
    const isLoggedIn = localStorage.getItem("adminLoggedIn") === 'true';
    
    if (!token || !isLoggedIn) {
      notyf.error("Please login first");
     setTimeout(() => {
    window.location.href = 'admin-login.html';
  }, 1500);
      return;
    }
    
    loadCategories();
  });

  // Event listener for category change
  document.getElementById("categorySelect").addEventListener("change", function () {
    if (this.value) {
      loadSubcategories(this.value);
    } else {
      const subcategorySelect = document.getElementById("subcategorySelect");
      subcategorySelect.disabled = true;
      subcategorySelect.innerHTML = '<option value="">Select Category First</option>';
    }
  });

  // Logout functionality
  document.getElementById('logoutBtn').addEventListener('click', function(e) {
    e.preventDefault();
    if (confirm('Are you sure you want to logout?')) {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = 'admin-login.html';
    }
  });
</script>
  </body>
</html>