<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopStyle - Admin Subcategories</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Source+Code+Pro:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* Admin Layout */
        .admin-container {
            min-height: 100vh;
        }
        
        /* Sidebar */
        .admin-sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .sidebar-brand {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
            background: #1a252f;
        }
        
        .sidebar-brand h2 {
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-brand i {
            margin-right: 10px;
            color: #e74c3c;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li a {
            color: #bdc3c7;
            padding: 15px 20px;
            display: block;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu li a:hover, .sidebar-menu li a.active {
            background: #34495e;
            color: white;
            border-left: 3px solid #e74c3c;
        }
        
        .sidebar-menu li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 250px;
            transition: all 0.3s;
        }
        
        .admin-header {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-user span {
            margin-right: 15px;
            color: #2c3e50;
        }
        
        .logout-btn, .addSubcategory-btn, .viewAll-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .addSubcategory-btn {
            background: #27ae60;
        }
        
        .viewAll-btn {
            background: #3498db;
        }
        
        .logout-btn:hover, .addSubcategory-btn:hover, .viewAll-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .admin-content {
            padding: 30px;
        }
        
        /* Categories Container */
        .categories-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-top: 20px;
            padding: 25px;
        }

        /* Category Tabs (Horizontal) */
        .category-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .category-tab {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-tab:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .category-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .category-tab .count-badge {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .category-tab.active .count-badge {
            background: white;
            color: #3498db;
        }

        /* Subcategories Section */
        .subcategories-section {
            display: none;
        }

        .subcategories-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .category-header h2 {
            color: #2c3e50;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-header h2 i {
            color: #3498db;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        /* Subcategories Grid */
        .subcategories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subcategory-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }

        .subcategory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .subcategory-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .subcategory-card p {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .subcategory-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .subcategory-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .subcategory-actions {
            display: flex;
            gap: 8px;
        }

        /* Action Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 28px;
            color: #2c3e50;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .stat-card i {
            font-size: 40px;
            opacity: 0.7;
        }

        .card-primary { border-left: 4px solid #3498db; }
        .card-success { border-left: 4px solid #27ae60; }
        .card-warning { border-left: 4px solid #f39c12; }

        .text-primary { color: #3498db; }
        .text-success { color: #27ae60; }
        .text-warning { color: #f39c12; }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .loading i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #e74c3c;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 70px;
            }
            
            .admin-sidebar .sidebar-brand h2 span,
            .admin-sidebar .sidebar-menu li a span {
                display: none;
            }
            
            .admin-sidebar .sidebar-menu li a i {
                margin-right: 0;
                font-size: 18px;
            }
            
            .admin-main {
                margin-left: 70px;
            }
            
            .admin-content {
                padding: 15px;
            }

            .category-tabs {
                flex-wrap: wrap;
            }

            .subcategories-grid {
                grid-template-columns: 1fr;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .admin-user {
                flex-direction: column;
                gap: 5px;
            }

            .logout-btn, .addSubcategory-btn, .viewAll-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-brand">
                <h2><i class="fas fa-user-shield"></i> <span>ShopStyle Admin</span></h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="admin-dashboard.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="admin-showusers.html"><i class="fas fa-users"></i> <span>Users</span></a></li>
                <li><a href="admin-orders.html"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                <li><a href="admin-products.html"><i class="fas fa-box"></i> <span>Products</span></a></li>
                <li><a href="admin-categories.html"><i class="fas fa-tags"></i> <span>Categories</span></a></li>
                <!-- <li><a href="admin-subcategories.html" class="active"><i class="fas fa-sitemap"></i> <span>Subcategories</span></a></li> -->
                <li><a href="admin-inventory.html"><i class="fas fa-warehouse"></i> <span>Inventory</span></a></li>
                <li><a href="admin-reports.html"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <div class="admin-header">
                <h1 id="pageTitle">Subcategories Management</h1>
                <div class="admin-user">
                    <button class="viewAll-btn" id="viewAllBtn">
                        <i class="fas fa-list"></i> View All Subcategories
                    </button>
                    <button class="addSubcategory-btn" id="addSubcategoryBtn">
                        <i class="fas fa-plus"></i> Add Subcategory
                    </button>
                    <button class="logout-btn" id="logoutBtnHeader">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="admin-content">
                <!-- Stats Cards -->
                <div class="stats-cards">
                    <div class="stat-card card-primary">
                        <div>
                            <h3 id="totalCategories">0</h3>
                            <p>Total Categories</p>
                        </div>
                        <i class="fas fa-tags text-primary"></i>
                    </div>
                    <div class="stat-card card-success">
                        <div>
                            <h3 id="totalSubcategories">0</h3>
                            <p>Total Subcategories</p>
                        </div>
                        <i class="fas fa-sitemap text-success"></i>
                    </div>
                    <div class="stat-card card-warning">
                        <div>
                            <h3 id="activeSubcategories">0</h3>
                            <p>Active Subcategories</p>
                        </div>
                        <i class="fas fa-check-circle text-warning"></i>
                    </div>
                </div>

                <!-- Categories Tabs -->
                <div class="categories-container">
                    <div class="category-tabs" id="categoryTabs">
                        <!-- Category tabs will be loaded here -->
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading categories...
                        </div>
                    </div>

                    <!-- Subcategories Content -->
                    <div id="subcategoriesContent">
                        <!-- Initially show instructions -->
                        <div class="empty-state" id="initialState">
                            <i class="fas fa-sitemap"></i>
                            <h3>Select a Category</h3>
                            <p>Click on a category tab above to view its subcategories</p>
                        </div>
                        
                        <!-- Subcategories will be loaded here based on selected category -->
                        <div id="subcategoriesContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Subcategory Modal -->
    <div class="modal" id="subcategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Subcategory</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm">
                    <div class="form-group">
                        <label for="subcategoryName">Subcategory Name *</label>
                        <input type="text" id="subcategoryName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="subcategoryDescription">Description</label>
                        <textarea id="subcategoryDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="subcategoryCategory">Parent Category *</label>
                        <select id="subcategoryCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <!-- Categories will be populated by JavaScript -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" id="saveSubcategoryBtn">Save Subcategory</button>
            </div>
        </div>
    </div>

    <script>
    // Global variables
    let categories = [];
    let allSubcategories = [];
    let currentCategoryId = null;
    let isEditMode = false;
    let currentEditId = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        
        // Get category from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get('categoryId');
        const categoryName = urlParams.get('categoryName');
        const action = urlParams.get('action');
        
        if (categoryId && categoryName) {
            // Coming from categories page - show only this category's subcategories
            showSingleCategoryView(categoryId, decodeURIComponent(categoryName));
            
            // If action is 'add', open the add modal
            if (action === 'add') {
                setTimeout(() => {
                    openAddModal(categoryId);
                }, 1000);
            }
        } else {
            // No category specified - show all categories tabs
            loadCategoriesForTabs();
        }
        
        setupEventListeners();
    });

    // Check authentication
    function checkAuth() {
        const token = localStorage.getItem('adminToken');
        const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
        
        if (!token || !isLoggedIn) {
            alert('Please login first');
            window.location.href = 'admin-login.html';
            return;
        }
    }

    // Show single category view (when coming from categories page)
    function showSingleCategoryView(categoryId, categoryName) {
        // Hide initial state
        document.getElementById('initialState').style.display = 'none';
        
        // Create a header for the selected category
        const container = document.getElementById('subcategoriesContainer');
        container.innerHTML = `
            <div class="subcategories-section active">
                <div class="category-header">
                    <h2><i class="fas fa-tags"></i> ${escapeHtml(categoryName)} - Subcategories</h2>
                    <button class="btn btn-success" onclick="openAddModal('${categoryId}')">
                        <i class="fas fa-plus"></i> Add Subcategory
                    </button>
                </div>
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading subcategories...
                </div>
            </div>
        `;
        
        currentCategoryId = categoryId;
        loadSubcategoriesByCategory(categoryId);
        
        // Also load categories for stats and dropdown
        loadCategoriesForStats();
    }

    // Load categories for tabs (when not coming from categories page)
    async function loadCategoriesForTabs() {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/admin/category/all', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load categories');
            
            const result = await response.json();
            
            if (result.success) {
                categories = result.categories || result.data || [];
                displayCategoryTabs();
                loadAllSubcategories();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categoryTabs').innerHTML = 
                '<div class="error">Failed to load categories</div>';
        }
    }

    // Load categories for stats and dropdown
    async function loadCategoriesForStats() {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/admin/category/all', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load categories');
            
            const result = await response.json();
            
            if (result.success) {
                categories = result.categories || result.data || [];
                loadAllSubcategories();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Load all subcategories for stats
    async function loadAllSubcategories() {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/admin/category/subcategories', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load subcategories');
            
            const result = await response.json();
            
            if (result.success) {
                allSubcategories = result.subcategories || [];
                updateStats();
            }
        } catch (error) {
            console.error('Error loading subcategories:', error);
        }
    }

    // Display category tabs horizontally
    function displayCategoryTabs() {
        const tabsContainer = document.getElementById('categoryTabs');
        
        if (categories.length === 0) {
            tabsContainer.innerHTML = '<div class="no-data">No categories found</div>';
            return;
        }

        // Clear loading message
        tabsContainer.innerHTML = '';
        
        // Add tabs dynamically
        categories.forEach(category => {
            const subcategoryCount = allSubcategories.filter(sub => sub.category === category._id).length;
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.dataset.categoryId = category._id;
            tab.innerHTML = `
                <span>${escapeHtml(category.name)}</span>
                <span class="count-badge">${subcategoryCount}</span>
            `;
            
            tab.addEventListener('click', () => selectCategory(category._id));
            tabsContainer.appendChild(tab);
        });
    }

    // Select a category and load its subcategories
    async function selectCategory(categoryId) {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.categoryId === categoryId) {
                tab.classList.add('active');
            }
        });

        currentCategoryId = categoryId;
        loadSubcategoriesByCategory(categoryId);
    }

    // Load subcategories for a specific category
    async function loadSubcategoriesByCategory(categoryId) {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`/api/admin/category/subcategories/${categoryId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load subcategories');
            
            const result = await response.json();
            displaySubcategories(result.subcategories || []);
            
        } catch (error) {
            console.error('Error loading subcategories:', error);
            showError('Failed to load subcategories');
        }
    }

    // Display subcategories for selected category
    function displaySubcategories(subcategories) {
        const container = document.getElementById('subcategoriesContainer');
        const category = categories.find(c => c._id === currentCategoryId);
        
        // Hide initial state
        document.getElementById('initialState').style.display = 'none';
        
        if (subcategories.length === 0) {
            container.innerHTML = `
                <div class="subcategories-section active">
                    <div class="category-header">
                        <h2><i class="fas fa-tags"></i> ${category ? escapeHtml(category.name) : 'Category'} - Subcategories</h2>
                        <button class="btn btn-success" onclick="openAddModal('${currentCategoryId}')">
                            <i class="fas fa-plus"></i> Add Subcategory
                        </button>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Subcategories Found</h3>
                        <p>This category doesn't have any subcategories yet.</p>
                        <button class="btn btn-success mt-3" onclick="openAddModal('${currentCategoryId}')">
                            <i class="fas fa-plus"></i> Add First Subcategory
                        </button>
                    </div>
                </div>
            `;
            return;
        }

        let subcategoriesHtml = `
            <div class="subcategories-section active">
                <div class="category-header">
                    <h2><i class="fas fa-tags"></i> ${category ? escapeHtml(category.name) : 'Category'} - Subcategories</h2>
                    <button class="btn btn-success" onclick="openAddModal('${currentCategoryId}')">
                        <i class="fas fa-plus"></i> Add Subcategory
                    </button>
                </div>
                <div class="subcategories-grid">
        `;

        subcategories.forEach(subcategory => {
            const statusClass = subcategory.isActive ? 'status-active' : 'status-inactive';
            const statusText = subcategory.isActive ? 'Active' : 'Inactive';
            
            subcategoriesHtml += `
                <div class="subcategory-card" data-subcategory-id="${subcategory._id}">
                    <h3>${escapeHtml(subcategory.name)}</h3>
                    <p>${escapeHtml(subcategory.description || 'No description available')}</p>
                    <div class="subcategory-meta">
                        <span class="subcategory-status ${statusClass}">${statusText}</span>
                        <div class="subcategory-actions">
                            <button class="btn btn-sm btn-warning" onclick="editSubcategory('${subcategory._id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubcategory('${subcategory._id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        subcategoriesHtml += `
                </div>
            </div>
        `;

        container.innerHTML = subcategoriesHtml;
    }

    // View all subcategories
    async function viewAllSubcategories() {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/admin/category/subcategories', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load subcategories');
            
            const result = await response.json();
            displayAllSubcategories(result.subcategories || []);
            
        } catch (error) {
            console.error('Error loading all subcategories:', error);
            showError('Failed to load subcategories');
        }
    }

    // Display all subcategories
    function displayAllSubcategories(subcategories) {
        const container = document.getElementById('subcategoriesContainer');
        
        // Hide initial state
        document.getElementById('initialState').style.display = 'none';
        
        if (subcategories.length === 0) {
            container.innerHTML = `
                <div class="subcategories-section active">
                    <div class="category-header">
                        <h2><i class="fas fa-list"></i> All Subcategories</h2>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Subcategories Found</h3>
                        <p>No subcategories have been created yet.</p>
                    </div>
                </div>
            `;
            return;
        }

        // Get categories for grouping
        const categoriesMap = {};
        categories.forEach(cat => {
            categoriesMap[cat._id] = cat.name;
        });

        // Group subcategories by category
        const grouped = {};
        subcategories.forEach(sub => {
            const categoryName = categoriesMap[sub.category] || 'Unknown Category';
            if (!grouped[categoryName]) grouped[categoryName] = [];
            grouped[categoryName].push(sub);
        });

        let allSubcategoriesHtml = `
            <div class="subcategories-section active">
                <div class="category-header">
                    <h2><i class="fas fa-list"></i> All Subcategories (${subcategories.length})</h2>
                </div>
        `;

        // Display each category's subcategories
        for (const [categoryName, categorySubs] of Object.entries(grouped)) {
            allSubcategoriesHtml += `
                <div class="category-group" style="margin-bottom: 30px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                        <i class="fas fa-folder"></i> ${escapeHtml(categoryName)}
                    </h3>
                    <div class="subcategories-grid">
            `;

            categorySubs.forEach(subcategory => {
                const statusClass = subcategory.isActive ? 'status-active' : 'status-inactive';
                const statusText = subcategory.isActive ? 'Active' : 'Inactive';
                
                allSubcategoriesHtml += `
                    <div class="subcategory-card" data-subcategory-id="${subcategory._id}">
                        <h3>${escapeHtml(subcategory.name)}</h3>
                        <p>${escapeHtml(subcategory.description || 'No description available')}</p>
                        <div class="subcategory-meta">
                            <span class="subcategory-status ${statusClass}">${statusText}</span>
                            <div class="subcategory-actions">
                                <button class="btn btn-sm btn-info" onclick="selectCategory('${subcategory.category}')">
                                    <i class="fas fa-eye"></i> View Category
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editSubcategory('${subcategory._id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            allSubcategoriesHtml += `
                    </div>
                </div>
            `;
        }

        allSubcategoriesHtml += `</div>`;
        container.innerHTML = allSubcategoriesHtml;
    }

    // Open add subcategory modal
    function openAddModal(categoryId = null) {
        isEditMode = false;
        currentEditId = null;
        
        document.getElementById('modalTitle').textContent = 'Add Subcategory';
        document.getElementById('subcategoryForm').reset();
        
        // Populate category dropdown
        const categorySelect = document.getElementById('subcategoryCategory');
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        
        // Load categories if not already loaded
        if (categories.length === 0) {
            loadCategoriesForModal().then(() => {
                populateCategoryDropdown(categoryId);
            });
        } else {
            populateCategoryDropdown(categoryId);
        }
        
        document.getElementById('subcategoryModal').style.display = 'flex';
    }

    // Load categories for modal dropdown
    async function loadCategoriesForModal() {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch('/api/admin/category/all', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load categories');
            
            const result = await response.json();
            
            if (result.success) {
                categories = result.categories || result.data || [];
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Populate category dropdown
    function populateCategoryDropdown(selectedCategoryId = null) {
        const categorySelect = document.getElementById('subcategoryCategory');
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category._id;
            option.textContent = category.name;
            if (selectedCategoryId && category._id === selectedCategoryId) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
    }

    // Open edit subcategory modal
    async function editSubcategory(subcategoryId) {
        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`/api/admin/category/subcategories/${subcategoryId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load subcategory');
            
            const result = await response.json();
            
            if (result.success && result.subcategory) {
                const subcategory = result.subcategory;
                isEditMode = true;
                currentEditId = subcategoryId;
                
                document.getElementById('modalTitle').textContent = 'Edit Subcategory';
                document.getElementById('subcategoryName').value = subcategory.name;
                document.getElementById('subcategoryDescription').value = subcategory.description || '';
                
                // Load categories if not already loaded
                if (categories.length === 0) {
                    await loadCategoriesForModal();
                }
                
                // Populate category dropdown
                const categorySelect = document.getElementById('subcategoryCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    if (category._id === subcategory.category) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
                
                document.getElementById('subcategoryModal').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error loading subcategory:', error);
            showError('Failed to load subcategory');
        }
    }

    // Save subcategory (add or edit)
    async function saveSubcategory() {
        const name = document.getElementById('subcategoryName').value.trim();
        const description = document.getElementById('subcategoryDescription').value.trim();
        const categoryId = document.getElementById('subcategoryCategory').value;

        if (!name || !categoryId) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const token = localStorage.getItem('adminToken');
            const url = isEditMode 
                ? `/api/admin/category/subcategories/${currentEditId}`
                : '/api/admin/category/subcategories';
            
            const method = isEditMode ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    name,
                    description,
                    categoryId
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert(isEditMode ? 'Subcategory updated successfully!' : 'Subcategory created successfully!');
                closeModal();
                
                // Reload data
                if (currentCategoryId) {
                    loadSubcategoriesByCategory(currentCategoryId);
                }
                
                // Reload all subcategories for stats
                await loadAllSubcategories();
                
                // Update category tabs if showing tabs view
                if (document.getElementById('categoryTabs').children.length > 0) {
                    await loadCategoriesForTabs();
                }
            } else {
                alert('Error: ' + (result.message || 'Operation failed'));
            }
        } catch (error) {
            console.error('Error saving subcategory:', error);
            alert('Error saving subcategory: ' + error.message);
        }
    }

    // Delete subcategory
    async function deleteSubcategory(subcategoryId) {
        if (!confirm('Are you sure you want to delete this subcategory?')) return;

        try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`/api/admin/category/subcategories/${subcategoryId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            const result = await response.json();
            
            if (result.success) {
                alert('Subcategory deleted successfully!');
                
                // Reload data
                if (currentCategoryId) {
                    loadSubcategoriesByCategory(currentCategoryId);
                }
                
                // Reload all subcategories for stats
                await loadAllSubcategories();
                
                // Update category tabs if showing tabs view
                if (document.getElementById('categoryTabs').children.length > 0) {
                    await loadCategoriesForTabs();
                }
            } else {
                alert('Error: ' + (result.message || 'Deletion failed'));
            }
        } catch (error) {
            console.error('Error deleting subcategory:', error);
            alert('Error deleting subcategory: ' + error.message);
        }
    }

    // Close modal
    function closeModal() {
        document.getElementById('subcategoryModal').style.display = 'none';
        document.getElementById('subcategoryForm').reset();
    }

    // Update statistics
    function updateStats() {
        const totalSubcategories = allSubcategories.length;
        const activeSubcategories = allSubcategories.filter(sub => sub.isActive).length;
        
        document.getElementById('totalCategories').textContent = categories.length;
        document.getElementById('totalSubcategories').textContent = totalSubcategories;
        document.getElementById('activeSubcategories').textContent = activeSubcategories;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Show error message
    function showError(message) {
        const container = document.getElementById('subcategoriesContainer');
        container.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error</h3>
                <p>${message}</p>
                <button class="btn btn-primary mt-3" onclick="location.reload()">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Modal close button
        document.querySelector('.close-modal').addEventListener('click', closeModal);
        
        // Save subcategory button
        document.getElementById('saveSubcategoryBtn').addEventListener('click', saveSubcategory);
        
        // Add subcategory button
        document.getElementById('addSubcategoryBtn').addEventListener('click', () => openAddModal());
        
        // View all subcategories button
        document.getElementById('viewAllBtn').addEventListener('click', viewAllSubcategories);
        
        // Logout buttons
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('logoutBtnHeader').addEventListener('click', logout);
        
        // Close modal on background click
        document.getElementById('subcategoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    }

    // Logout function
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'admin-login.html';
        }
    }
</script>
</body>
</html>