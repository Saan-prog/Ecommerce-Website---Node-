<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>ShopStyle - Modern eCommerce</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta content="Modern eCommerce HTML Template" name="keywords" />
  <meta content="Contemporary eCommerce Template" name="description" />

  <!-- Favicon -->
  <link href="img/favicon.ico" rel="icon" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- CSS Libraries -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet" />
  <link href="lib/slick/slick.css" rel="stylesheet" />
  <link href="lib/slick/slick-theme.css" rel="stylesheet" />

  <!-- Template Stylesheet -->
  <link href="css/style.css" rel="stylesheet" />
  <style>
    /* Add spacing between Featured and Recent products */
    .recent-product {
      margin-top: 60px !important;
      padding-top: 40px !important;
      border-top: 1px solid #eee;
    }
    
    /* Product card button styles */
    .product-action-buttons {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    
    .btn-add-to-cart {
      flex: 1;
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      white-space: nowrap;
    }
    
    .btn-add-to-cart:hover {
      background-color: #218838;
      color: white;
      text-decoration: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-buy-now {
      flex: 1;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      white-space: nowrap;
    }
    
    .btn-buy-now:hover {
      background-color: #0069d9;
      color: white;
      text-decoration: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Product card adjustments */
    .product-item {
      padding-bottom: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .product-price {
      margin-bottom: 10px;
    }
    
    /* Adjust product image container */
    .product-image {
      height: 200px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      position: relative;
    }
    
    .product-image img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      transition: transform 0.3s ease;
    }
    
    .product-image:hover img {
      transform: scale(1.05);
    }
    
    /* Newsletter spacing */
    .newsletter {
      margin: 40px 0;
      padding: 40px 0;
      background-color: #f8f9fa;
    }
    
    /* Loading state improvements */
    .loading-state {
      text-align: center;
      padding: 40px 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .product-action-buttons {
        flex-direction: column;
        gap: 8px;
      }
      
      .btn-add-to-cart,
      .btn-buy-now {
        width: 100%;
      }
      
      .recent-product {
        margin-top: 40px !important;
        padding-top: 30px !important;
      }
    }
  </style>
</head>

<body>
  <!-- Top bar Start -->
  <div class="top-bar">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-6">
          <i class="fa fa-envelope"></i>
          support@shopstyle.com
        </div>
        <div class="col-sm-6 text-sm-right">
          <i class="fa fa-phone-alt"></i>
          +1 (234) 567-8900
        </div>
      </div>
    </div>
  </div>
  <!-- Top bar End -->

  <!-- Navigation Bar Start -->
  <div class="nav">
    <div class="container-fluid">
      <nav class="navbar navbar-expand-lg">
        <a class="navbar-brand" href="index.html">
          <!-- <span class="logo-text">ShopStyle</span> -->
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMain">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="product-list.html">Products</a>
            </li>
            <!-- <li class="nav-item protected-menu" style="display: none;">
              <a class="nav-link" href="cart.html" id="cartMenuItem">Cart</a>
            </li> -->
            <li class="nav-item protected-menu" style="display: none;">
              <a class="nav-link" href="checkout.html" id="checkoutMenuItem">Checkout</a>
            </li>
            <li class="nav-item protected-menu" style="display: none;">
              <a class="nav-link" href="order-history.html" id="orderMenuItem">My Orders</a>
            </li>
          </ul>

          <div class="navbar-nav ml-auto align-items-center">
            <div class="nav-item dropdown user-account" id="userAccountDropdown" style="display: none;">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                <i class="fa fa-user-circle mr-1"></i> Account
              </a>
              <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="my-account.html">Dashboard</a>
                <a class="dropdown-item" href="#" id="logoutBtn">Logout</a>
              </div>
            </div>
            <a class="btn btn-sm btn-outline-primary" href="login.html" id="loginBtn">LOGIN</a>
          </div>
        </div>
      </nav>
    </div>
  </div>
  <!-- Navigation Bar End -->

  <!-- Search Bar Start -->
  <div class="bottom-bar">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-2">
          <div class="logo">
            <a href="index.html" class="font-logo">
              <span class="logo-text">ShopStyle</span>
            </a>
          </div>
        </div>
        <div class="col-md-8">
          <div class="search">
            <input type="text" id="searchInput" placeholder="Search for products, brands, and more...">
            <button id="searchBtn"><i class="fa fa-search"></i></button>
          </div>
        </div>
        <div class="col-md-2">
          <div class="user text-right">
            <a href="wishlist.html" class="btn wishlist">
              <i class="fa fa-heart"></i>
              <span id="wishlist-count">(0)</span>
            </a>
            <a href="cart.html" class="btn cart">
              <i class="fa fa-shopping-cart"></i>
              <span id="cart-count">(0)</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Search Bar End -->

  <!-- Main Content Start -->
  <div class="container-fluid">
    <!-- Hero & Categories Section -->
    <div class="row header">
      <div class="col-lg-3">
        <div class="category-sidebar-container">
          <h3 class="category-title">
            <i class="fas fa-bars mr-2"></i>All Categories
          </h3>
          <nav class="navbar bg-light category-sidebar">
            <ul class="navbar-nav w-100" id="categorySidebar">
              <li class="nav-item">
                <div class="category-loading">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading categories...</span>
                  </div>
                  <p class="mt-2 small">Loading categories...</p>
                </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="header-slider normal-slider">
          <div class="header-slider-item">
            <img src="img/slider-1.jpg" alt="Summer Collection" width="100%">
            <div class="header-slider-caption">
              <p>Summer Collection 2024</p>
              <a class="btn btn-sm btn-light" href="product-list.html?category=summer">
                <i class="fa fa-arrow-right mr-2"></i>Shop Now
              </a>
            </div>
          </div>
          <div class="header-slider-item">
            <img src="img/slider-2.jpg" alt="Electronics Sale" width="100%">
            <div class="header-slider-caption">
              <p>Electronics Mega Sale</p>
              <a class="btn btn-sm btn-light" href="product-list.html?category=electronics">
                <i class="fa fa-arrow-right mr-2"></i>Shop Now
              </a>
            </div>
          </div>
          <div class="header-slider-item">
            <img src="img/slider-3.jpg" alt="Fashion Week" width="100%">
            <div class="header-slider-caption">
              <p>Fashion Week Special</p>
              <a class="btn btn-sm btn-light" href="product-list.html?category=fashion">
                <i class="fa fa-arrow-right mr-2"></i>Shop Now
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Brands Section -->
    <div class="brand">
      <div class="container-fluid">
        <div class="brand-slider">
          <div class="brand-item"><img src="img/brand-1.png" alt="Brand 1"></div>
          <div class="brand-item"><img src="img/brand-2.png" alt="Brand 2"></div>
          <div class="brand-item"><img src="img/brand-3.png" alt="Brand 3"></div>
          <div class="brand-item"><img src="img/brand-4.png" alt="Brand 4"></div>
          <div class="brand-item"><img src="img/brand-5.png" alt="Brand 5"></div>
          <div class="brand-item"><img src="img/brand-6.png" alt="Brand 6"></div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <div class="feature">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-3 col-md-6">
            <div class="feature-content">
              <i class="fas fa-shield-alt"></i>
              <h2>Secure Payment</h2>
              <p>100% secure & encrypted transactions</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="feature-content">
              <i class="fas fa-shipping-fast"></i>
              <h2>Fast Delivery</h2>
              <p>Same-day delivery in select cities</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="feature-content">
              <i class="fas fa-undo-alt"></i>
              <h2>Easy Returns</h2>
              <p>30-day return policy, no questions asked</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="feature-content">
              <i class="fas fa-headset"></i>
              <h2>24/7 Support</h2>
              <p>Dedicated customer support team</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Grid -->
    <div class="category">
      <div class="container-fluid">
        <div class="section-header">
          <h1>Shop By Category</h1>
        </div>
        <div class="row">
          <div class="col-md-3">
            <div class="category-item ch-400">
              <img src="img/category-3.jpg" alt="Electronics">
              <a class="category-name" href="product-list.html?category=electronics">
                <p>Electronics & Gadgets</p>
              </a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="category-item ch-250">
              <img src="img/category-4.jpg" alt="Men's Fashion">
              <a class="category-name" href="product-list.html?category=men">
                <p>Men's Fashion</p>
              </a>
            </div>
            <div class="category-item ch-150">
              <img src="img/category-5.jpg" alt="Accessories">
              <a class="category-name" href="product-list.html?category=accessories">
                <p>Accessories</p>
              </a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="category-item ch-150">
              <img src="img/category-6.jpg" alt="Home & Living">
              <a class="category-name" href="product-list.html?category=home">
                <p>Home & Living</p>
              </a>
            </div>
            <div class="category-item ch-250">
              <img src="img/category-7.jpg" alt="Women's Collection">
              <a class="category-name" href="product-list.html?category=women">
                <p>Women's Collection</p>
              </a>
            </div>
          </div>
          <div class="col-md-3">
            <div class="category-item ch-400">
              <img src="img/category-8.jpg" alt="Sports & Outdoors">
              <a class="category-name" href="product-list.html?category=sports">
                <p>Sports & Outdoors</p>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Call to Action -->
    <div class="call-to-action">
      <div class="container">
        <h1>Need Help With Your Order?</h1>
        <a href="tel:+12345678900" class="btn btn-light btn-sm">
          <i class="fa fa-phone mr-2"></i>Call Now: +1 (234) 567-8900
        </a>
      </div>
    </div>

    <!-- Featured Products -->
    <div class="featured-product product">
      <div class="container-fluid">
        <div class="section-header">
          <h1>Featured Products</h1>
        </div>
        <div class="row align-items-center product-slider product-slider-4" id="featuredProducts">
          <div class="col-12">
            <div class="loading-state">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading featured products...</span>
              </div>
              <p class="mt-3">Loading featured products...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Newsletter -->
    <div class="newsletter">
      <div class="container">
        <h1>Stay Updated</h1>
        <p class="mb-4 text-muted">Subscribe to our newsletter for exclusive deals and updates</p>
        <div class="form">
          <input type="email" placeholder="Enter your email address">
          <button>Subscribe</button>
        </div>
      </div>
    </div>

    <!-- Recent Products -->
    <div class="recent-product product">
      <div class="container-fluid">
        <div class="section-header">
          <h1>New Arrivals</h1>
        </div>
        <div class="row align-items-center product-slider product-slider-4" id="recentProducts">
          <div class="col-12">
            <div class="loading-state">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading new arrivals...</span>
              </div>
              <p class="mt-3">Loading new arrivals...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Main Content End -->

  <!-- Footer Start -->
  <div class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-3 col-md-6">
          <div class="footer-widget">
            <h2>ShopStyle</h2>
            <div class="contact-info">
              <p><i class="fa fa-map-marker"></i>123 Business Street, New York, NY 10001</p>
              <p><i class="fa fa-envelope"></i>support@shopstyle.com</p>
              <p><i class="fa fa-phone"></i>+1 (234) 567-8900</p>
            </div>
            <div class="social">
              <a href="#"><i class="fab fa-facebook-f"></i></a>
              <a href="#"><i class="fab fa-twitter"></i></a>
              <a href="#"><i class="fab fa-instagram"></i></a>
              <a href="#"><i class="fab fa-linkedin-in"></i></a>
              <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="footer-widget">
            <h2>Quick Links</h2>
            <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="product-list.html">Products</a></li>
              <li><a href="about.html">About Us</a></li>
              <li><a href="contact.html">Contact Us</a></li>
            </ul>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="footer-widget">
            <h2>Customer Service</h2>
            <ul>
              <li><a href="faq.html">FAQ</a></li>
              <li><a href="shipping.html">Shipping Policy</a></li>
              <li><a href="returns.html">Return Policy</a></li>
              <li><a href="privacy.html">Privacy Policy</a></li>
            </ul>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="footer-widget">
            <h2>My Account</h2>
            <ul>
              <li><a href="my-account.html">My Account</a></li>
              <li><a href="order-history.html">Order History</a></li>
              <li><a href="wishlist.html">Wishlist</a></li>
              <li><a href="newsletter.html">Newsletter</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="row payment align-items-center">
        <div class="col-md-6">
          <div class="payment-method">
            <h3>We Accept:</h3>
            <img src="img/payment-method.png" alt="Payment Methods">
          </div>
        </div>
        <div class="col-md-6">
          <div class="payment-security">
            <h3>Secured By:</h3>
            <img src="img/godaddy.svg" alt="GoDaddy">
            <img src="img/norton.svg" alt="Norton">
            <img src="img/ssl.svg" alt="SSL">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer Bottom -->
  <div class="footer-bottom">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <p>&copy; 2024 ShopStyle. All rights reserved.</p>
        </div>
        <div class="col-md-6 text-right">
          <p>Designed with <i class="fa fa-heart text-danger"></i> for modern eCommerce</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Back to Top -->
  <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/slick/slick.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

  <!-- Template Javascript -->
  <script>
    // ========== NOTYF NOTIFICATION SETUP ==========
    const notyf = new Notyf({
      duration: 3000,
      position: {
        x: 'right',
        y: 'top',
      },
      types: [
        {
          type: 'success',
          background: '#10b981',
          icon: {
            className: 'fas fa-check-circle',
            tagName: 'i',
            color: '#fff'
          }
        },
        {
          type: 'error',
          background: '#ef4444',
          icon: {
            className: 'fas fa-exclamation-circle',
            tagName: 'i',
            color: '#fff'
          }
        },
        {
          type: 'warning',
          background: '#f59e0b',
          icon: {
            className: 'fas fa-exclamation-triangle',
            tagName: 'i',
            color: '#fff'
          }
        },
        {
          type: 'info',
          background: '#3b82f6',
          icon: {
            className: 'fas fa-info-circle',
            tagName: 'i',
            color: '#fff'
          }
        }
      ]
    });

    document.addEventListener("DOMContentLoaded", function () {
      // ============ SEARCH INTEGRATION ============
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');

      if (searchInput && searchBtn) {
        searchInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            handleSearch();
          }
        });

        searchBtn.addEventListener('click', function (e) {
          e.preventDefault();
          handleSearch();
        });
      }

      function handleSearch() {
        const query = searchInput.value.trim();

        if (!query) {
          notyf.error('Please enter something to search');
          return;
        }
        window.location.href = `product-list.html?search=${encodeURIComponent(query)}`;
      }

      // ========== AUTHENTICATION HANDLING ==========
      const token = localStorage.getItem("token");
      const isLoggedIn = token !== null && token !== undefined && token !== "";

      const userAccount = document.getElementById("userAccountDropdown");
      const loginBtn = document.getElementById("loginBtn");
      const protectedMenus = document.querySelectorAll('.protected-menu');

      if (isLoggedIn) {
        if (userAccount) userAccount.style.display = "block";
        if (loginBtn) loginBtn.style.display = "none";
        protectedMenus.forEach(menu => {
          if (menu) menu.style.display = "block";
        });

        updateCartCountDisplay();
      } else {
        if (userAccount) userAccount.style.display = "none";
        if (loginBtn) loginBtn.style.display = "inline-block";
        protectedMenus.forEach(menu => {
          if (menu) menu.style.display = "none";
        });
      }

      // Logout functionality
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", function (e) {
          e.preventDefault();

          localStorage.removeItem("token");
          localStorage.removeItem("userId");
          localStorage.removeItem("userName");
          localStorage.removeItem("userEmail");

          notyf.success('Logged out successfully');
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        });
      }

      // ========== LOAD DYNAMIC CONTENT ==========
      loadCategories();
      loadFeaturedProducts();
      loadRecentProducts();

      // Initialize sliders
      initializeSliders();
    });

    // ========== LOAD CATEGORIES ==========
    async function loadCategories() {
      try {
        const response = await fetch('/api/user/category/all');

        if (!response.ok) {
          throw new Error(`Failed to fetch categories: ${response.status}`);
        }

        const data = await response.json();
        const categorySidebar = document.getElementById('categorySidebar');

        if (data.success && data.data && data.data.length > 0) {
          renderCategories(data.data);
        } else {
          categorySidebar.innerHTML = `
            <li class="nav-item">
              <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p class="mt-3">No categories available</p>
              </div>
            </li>
          `;
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        const categorySidebar = document.getElementById('categorySidebar');
        if (categorySidebar) {
          categorySidebar.innerHTML = `
            <li class="nav-item">
              <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p class="mt-3">Failed to load categories</p>
              </div>
            </li>
          `;
        }
      }
    }

    function renderCategories(categories) {
      const categorySidebar = document.getElementById('categorySidebar');
      let categoriesHTML = '';

      const iconMap = {
        'Fashion': 'fa-tshirt',
        'Electronics': 'fa-laptop',
        'Mobile': 'fa-mobile-alt',
        'Clothing': 'fa-tshirt',
        'Men': 'fa-male',
        "Men's Fashion": 'fa-male',
        'Women': 'fa-female',
        "Women's Fashion": 'fa-female',
        'Kids': 'fa-child',
        'Baby': 'fa-baby',
        "New Born Fashion": 'fa-baby',
        "Teen's Fashion": 'fa-user-graduate',
        'Teen': 'fa-user-graduate',
        "Toddler's Fashion": 'fa-child',
        'Toddler': 'fa-child',
        "All Teen's Fashion": 'fa-users',
        "Girl's clothing": 'fa-female',
        "Boy's clothing": 'fa-male',
        'Beauty': 'fa-spa',
        'Accessories': 'fa-glasses',
        'Sports': 'fa-running',
        'Home': 'fa-home',
        'Kitchen': 'fa-utensils',
        'Furniture': 'fa-couch',
        'Books': 'fa-book',
        'Toys': 'fa-gamepad',
        'Gadgets': 'fa-microchip',
        'Watches': 'fa-clock',
        'Shoes': 'fa-shoe-prints',
        'Bags': 'fa-shopping-bag',
        'Jewelry': 'fa-gem',
        'Health': 'fa-heartbeat',
        'Automotive': 'fa-car',
        'Music': 'fa-music',
        'Computer': 'fa-desktop',
        'Audio': 'fa-headphones',
        'Camera': 'fa-camera',
        'Gaming': 'fa-gamepad',
        'Tools': 'fa-tools',
        'Pet': 'fa-paw',
        'Garden': 'fa-seedling',
        'Office': 'fa-briefcase',
        'Travel': 'fa-suitcase',
        'Food': 'fa-utensils',
        'Drink': 'fa-wine-glass',
        'Stationery': 'fa-pen',
        'Art': 'fa-paint-brush',
        'Craft': 'fa-palette',
        'Collectibles': 'fa-star',
        'Antiques': 'fa-history'
      };

      // Sort categories alphabetically
      categories.sort((a, b) => {
        const nameA = (a.name || '').toUpperCase();
        const nameB = (b.name || '').toUpperCase();
        return nameA.localeCompare(nameB);
      });

      // Add each category
      categories.forEach(category => {
        const categoryId = category._id || category.id || '';
        const categoryName = category.name || 'Unnamed Category';
        const iconClass = getCategoryIcon(categoryName, iconMap);

        const hasSubcategories = category.subcategories && category.subcategories.length > 0;
        const subcategoryCount = hasSubcategories ? category.subcategories.length : 0;

        if (hasSubcategories) {
          categoriesHTML += `
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" 
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa ${iconClass} mr-2"></i>${categoryName}
                <i class="fa fa-chevron-right ml-auto"></i>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="product-list.html?category=${categoryId}">
                  <i class="fa fa-eye mr-2"></i>View All
                </a>
                <div class="dropdown-divider"></div>
                ${category.subcategories.map(sub => `
                  <a class="dropdown-item" href="product-list.html?subcategory=${sub._id}">
                    <i class="fa fa-angle-right mr-2"></i>${sub.name || 'Subcategory'}
                  </a>
                `).join('')}
              </div>
            </li>
          `;
        } else {
          categoriesHTML += `
            <li class="nav-item">
              <a class="nav-link" href="product-list.html?category=${categoryId}">
                <i class="fa ${iconClass} mr-2"></i>${categoryName}
              </a>
            </li>
          `;
        }
      });

      if (categorySidebar) {
        categorySidebar.innerHTML = categoriesHTML;
      }
    }

    function getCategoryIcon(categoryName, iconMap) {
      const normalizedName = categoryName.trim();

      if (iconMap[normalizedName]) {
        return iconMap[normalizedName];
      }

      for (const [key, value] of Object.entries(iconMap)) {
        if (normalizedName.toLowerCase().includes(key.toLowerCase()) ||
          key.toLowerCase().includes(normalizedName.toLowerCase())) {
          return value;
        }
      }

      return 'fa-tag';
    }

    // ========== LOAD FEATURED PRODUCTS ==========
    async function loadFeaturedProducts() {
      try {
        const response = await fetch('/api/user/products?featured=true&limit=8');

        if (!response.ok) {
          throw new Error('Failed to fetch featured products');
        }

        const data = await response.json();
        const featuredContainer = document.getElementById('featuredProducts');

        if (data.success && data.products && data.products.length > 0) {
          renderProducts(data.products, featuredContainer, 'featured');
        } else {
          featuredContainer.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p class="mt-3">No featured products available</p>
                <a href="product-list.html" class="btn btn-primary btn-sm mt-2">Browse All Products</a>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading featured products:', error);
        const featuredContainer = document.getElementById('featuredProducts');
        if (featuredContainer) {
          featuredContainer.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p class="mt-3">Failed to load featured products</p>
              </div>
            </div>
          `;
        }
      }
    }

    // ========== LOAD RECENT PRODUCTS ==========
    async function loadRecentProducts() {
      try {
        const response = await fetch('/api/user/products?sort=-createdAt&limit=8');

        if (!response.ok) {
          throw new Error('Failed to fetch recent products');
        }

        const data = await response.json();
        const recentContainer = document.getElementById('recentProducts');

        if (data.success && data.products && data.products.length > 0) {
          renderProducts(data.products, recentContainer, 'recent');
        } else {
          recentContainer.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p class="mt-3">No new arrivals available</p>
                <a href="product-list.html" class="btn btn-primary btn-sm mt-2">Browse All Products</a>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading recent products:', error);
        const recentContainer = document.getElementById('recentProducts');
        if (recentContainer) {
          recentContainer.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p class="mt-3">Failed to load new arrivals</p>
              </div>
            </div>
          `;
        }
      }
    }

    // ========== RENDER PRODUCTS ==========
    function renderProducts(products, container, type) {
      if (!container) return;

      let productsHTML = '';

      products.forEach(product => {
        const productId = product._id || product.id || '';
        const productName = product.name || 'Product Name';
        const productPrice = parseFloat(product.price) || 0;
        const productRating = product.rating || 0;
        const productImage = getProductImageUrl(product.image || product.images || []);
        
        // Truncate long product names
        const displayName = productName.length > 50 ? productName.substring(0, 50) + '...' : productName;

        let ratingStars = '';
        const fullStars = Math.floor(productRating);
        const hasHalfStar = productRating % 1 >= 0.5;

        for (let i = 0; i < 5; i++) {
          if (i < fullStars) {
            ratingStars += '<i class="fa fa-star text-warning"></i>';
          } else if (i === fullStars && hasHalfStar) {
            ratingStars += '<i class="fa fa-star-half-alt text-warning"></i>';
          } else {
            ratingStars += '<i class="far fa-star text-warning"></i>';
          }
        }

        productsHTML += `
          <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="product-item fade-in">
              <div class="product-title">
                <a href="product-detail.html?id=${productId}" title="${productName}">${displayName}</a>
                <div class="ratting">
                  ${ratingStars}
                </div>
              </div>
              <div class="product-image">
                <a href="product-detail.html?id=${productId}">
                  <img src="${productImage}" 
                       alt="${productName}"
                       onerror="this.onerror=null; this.src='img/product-1.jpg'">
                </a>
                <div class="product-action">
                  <a href="#" onclick="handleAddToCartHome(event, '${productId}')" title="Add to Cart">
                    <i class="fa fa-cart-plus"></i>
                  </a>
                  <a href="wishlist.html" title="Add to Wishlist">
                    <i class="fa fa-heart"></i>
                  </a>
                  <a href="product-detail.html?id=${productId}" title="Quick View">
                    <i class="fa fa-eye"></i>
                  </a>
                </div>
              </div>
              <div class="product-price">
                <h3><span>₹</span>${productPrice.toFixed(2)}</h3>
                ${product.originalPrice ? `<del><span>₹</span>${parseFloat(product.originalPrice).toFixed(2)}</del>` : ''}
              </div>
              <div class="product-action-buttons">
                <button class="btn-add-to-cart" onclick="handleAddToCartHome(event, '${productId}')">
                  <i class="fa fa-shopping-cart"></i> Add to Cart
                </button>
                <button class="btn-buy-now" onclick="handleBuyNow(event, '${productId}')">
                  <i class="fa fa-bolt"></i> Buy Now
                </button>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = productsHTML;

      // Reinitialize slick slider
      if (typeof $ !== 'undefined' && container.classList.contains('product-slider-4')) {
        // Destroy existing slick instance if it exists
        if ($(container).hasClass('slick-initialized')) {
          $(container).slick('unslick');
        }
        
        // Initialize new slick instance
        $(container).slick({
          dots: false,
          infinite: true,
          slidesToShow: 4,
          slidesToScroll: 1,
          autoplay: true,
          autoplaySpeed: 4000,
          arrows: true,
          prevArrow: '<button type="button" class="slick-prev"><i class="fa fa-chevron-left"></i></button>',
          nextArrow: '<button type="button" class="slick-next"><i class="fa fa-chevron-right"></i></button>',
          responsive: [
            {
              breakpoint: 1200,
              settings: { slidesToShow: 3 }
            },
            {
              breakpoint: 992,
              settings: { slidesToShow: 2 }
            },
            {
              breakpoint: 576,
              settings: { slidesToShow: 1 }
            }
          ]
        });
      }
    }

    // ========== BUY NOW FUNCTIONALITY ==========
    async function handleBuyNow(event, productId) {
      event.preventDefault();
      event.stopPropagation();

      const token = localStorage.getItem('token');

      if (!token) {
        notyf.error('Please login to purchase items');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return;
      }

      try {
        // First add product to cart
        const cartResponse = await fetch('/api/user/cart/addtocart', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productId,
            quantity: 1,
            size: 'M'
          })
        });

        const cartData = await cartResponse.json();

        if (cartData.success) {
          // Update cart count display
          if (cartData.cart?.totalItems) {
            localStorage.setItem('cartCount', cartData.cart.totalItems.toString());
            updateCartCountDisplay();
          }
          
          // Redirect directly to checkout
          notyf.success('Added to cart! Redirecting to checkout...');
          setTimeout(() => {
            window.location.href = 'cart.html';
          }, 1000);
        } else {
          notyf.error('Failed to add to cart: ' + cartData.message);
        }
      } catch (error) {
        console.error('Error:', error);
        notyf.error('Error adding product to cart');
      }
    }

    // ========== ADD TO CART ==========
    async function handleAddToCartHome(event, productId) {
      event.preventDefault();
      event.stopPropagation();

      const token = localStorage.getItem('token');

      if (!token) {
        notyf.error('Please login to add items to cart');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      try {
        const cartResponse = await fetch('/api/user/cart/addtocart', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productId,
            quantity: 1,
            size: 'M'
          })
        });

        const cartData = await cartResponse.json();

        if (cartData.success) {
          if (cartData.cart?.totalItems) {
            localStorage.setItem('cartCount', cartData.cart.totalItems.toString());
            updateCartCountDisplay();
          }
          notyf.success('Added to cart!');
        } else {
          notyf.error('Failed to add to cart: ' + cartData.message);
        }
      } catch (error) {
        console.error('Error:', error);
        notyf.error('Error adding product to cart');
      }
    }

    function getProductImageUrl(imageData) {
      const defaultImage = 'img/product-1.jpg';
      if (!imageData) return defaultImage;

      let imagePath = imageData;
      if (Array.isArray(imageData)) {
        if (imageData.length === 0) return defaultImage;
        imagePath = imageData[0];
      }

      if (typeof imagePath === 'string' && imagePath.trim()) {
        let path = imagePath.trim();
        while (path.startsWith('uploads/')) {
          path = path.replace('uploads/', '');
        }

        if (path.startsWith('http') || path.startsWith('/')) {
          return path;
        } else if (path.includes('.')) {
          return `/uploads/${path}`;
        }
      }
      return defaultImage;
    }

    function updateCartCountDisplay() {
      try {
        const cartCount = localStorage.getItem('cartCount') || '0';
        document.querySelectorAll('#cart-count').forEach(el => {
          el.textContent = `(${cartCount})`;
        });
      } catch (error) {
        console.error('Error updating cart count:', error);
      }
    }

    function initializeSliders() {
      if (typeof $ !== 'undefined') {
        // Header Slider
        $('.header-slider').slick({
          autoplay: true,
          dots: true,
          infinite: true,
          speed: 500,
          fade: true,
          cssEase: 'linear',
          autoplaySpeed: 5000,
          arrows: false
        });

        // Brand Slider
        $('.brand-slider').slick({
          autoplay: true,
          dots: false,
          infinite: true,
          slidesToShow: 5,
          slidesToScroll: 1,
          autoplaySpeed: 3000,
          responsive: [
            {
              breakpoint: 992,
              settings: { slidesToShow: 4 }
            },
            {
              breakpoint: 768,
              settings: { slidesToShow: 3 }
            },
            {
              breakpoint: 576,
              settings: { slidesToShow: 2 }
            }
          ]
        });

        // Product Sliders will be initialized after loading products
      }
    }
  </script>
</body>

</html>