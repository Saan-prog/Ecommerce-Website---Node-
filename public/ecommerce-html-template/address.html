<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Manage Addresses - ShopStyle</title>
    <!-- Include your existing CSS and JS libraries -->

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Source+Code+Pro:700,900&display=swap"
      rel="stylesheet"
    />

    <!-- CSS Libraries -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="lib/slick/slick.css" rel="stylesheet" />
    <link href="lib/slick/slick-theme.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
    <style>
      .nav .login-btn {
        color: #fff;
        background-color: #ff6f61;
        border: none;
        padding: 6px 15px;
        margin-left: 10px;
        border-radius: 3px;
        font-weight: 500;
        font-size: 14px;
        transition: 0.3s;
      }

      .nav .login-btn:hover {
        background-color: #e85c50;
        color: #fff;
      }
      .user-account {
        display: none;
      }
      .protected-menu {
        display: none;
      }
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
      .navbar-nav .dropdown-menu {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
      }
      .navbar-nav .dropdown-item {
        color: #495057;
        padding: 8px 20px;
      }
      .navbar-nav .dropdown-item:hover {
        background-color: #e9ecef;
        color: #007bff;
      }
      .navbar-nav .dropdown-divider {
        border-top: 1px solid #dee2e6;
        margin: 5px 0;
      }

      /* Manage Addresses Main Container */
      .manage-addresses-container {
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        margin-top: 20px;
        margin-bottom: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .manage-addresses-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .manage-addresses-header h2 {
        color: #333;
        font-weight: 600;
        margin: 0;
      }

      .manage-addresses-header h2 i {
        color: #ee714a;
      }

      /* Address Rows (Table-like layout) */
      .address-row {
        display: flex;
        align-items: center;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .address-row:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .address-row.selected {
        border-color: #28a745;
        border-width: 2px;
        background-color: #f0fff4;
      }

      .address-row.default {
        border-color: #ee714a;
        border-width: 2px;
        background-color: #fff9f7;
      }

      .address-row.selected.default {
        border-color: #28a745;
        background: linear-gradient(135deg, #f0fff4 0%, #fff9f7 100%);
      }

      /* Selection Radio */
      .address-selection {
        flex: 0 0 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .address-selection .form-check {
        margin: 0;
      }

      .address-selection .form-check-input {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .address-selection .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
      }

      /* Address Details */
      .address-details {
        flex: 1;
        padding: 0 20px;
      }

      .address-details-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .address-name {
        font-weight: 600;
        color: #333;
        font-size: 16px;
        margin: 0;
      }

      .address-type-badge {
        margin-left: 10px;
      }

      .address-type-badge .badge {
        font-size: 11px;
        padding: 4px 8px;
      }

      .address-info {
        color: #666;
        line-height: 1.5;
      }

      .address-info p {
        margin-bottom: 5px;
      }

      .address-info i {
        color: #ee714a;
        width: 20px;
        margin-right: 5px;
      }

      /* Address Actions */
      .address-actions {
        flex: 0 0 150px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .address-actions .btn {
        font-size: 12px;
        padding: 6px 12px;
        width: 100%;
      }

      .btn-set-default {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #212529;
      }

      .btn-set-default:hover {
        background-color: #e0a800;
        border-color: #d39e00;
        color: #212529;
      }

      .btn-edit {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: white;
      }

      .btn-edit:hover {
        background-color: #138496;
        border-color: #117a8b;
        color: white;
      }

      .btn-delete {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background-color: #c82333;
        border-color: #bd2130;
        color: white;
      }

      /* Action Buttons Container */
      .action-buttons-container {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .add-address-btn {
        background: linear-gradient(135deg, #b37de8 0%, #ee714a 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .add-address-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        color: white;
      }

      .proceed-checkout-btn {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .proceed-checkout-btn:hover {
        background-color: #218838;
        border-color: #1e7e34;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        color: white;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        background-color: white;
        border-radius: 10px;
        border: 2px dashed #ddd;
      }

      .empty-state i {
        color: #ccc;
        font-size: 60px;
        margin-bottom: 20px;
      }

      .empty-state h4 {
        color: #666;
        margin-bottom: 10px;
      }

      .empty-state p {
        color: #999;
        margin-bottom: 25px;
      }

      /* Loading State */
      .loading-state {
        text-align: center;
        padding: 40px;
      }

      .loading-state p {
        color: #666;
        margin-top: 15px;
      }

      /* Selection Status */
      .selection-status {
        background-color: #e8f5e9;
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .no-selection-msg {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      /* Success Message Styles - FIXED */
      .success-message-container {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 99999;
        min-width: 350px;
        max-width: 400px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
        display: none;
      }

      .success-message-container.show {
        display: block;
        animation: slideInRight 0.5s ease-out;
      }

      .success-message-container.hide {
        animation: slideOutRight 0.5s ease-out forwards;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .success-message-content {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .success-message-text {
        flex: 1;
        font-weight: 500;
        font-size: 16px;
      }

      .success-message-icon {
        font-size: 24px;
        margin-right: 15px;
      }

      .success-message-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        margin-left: 15px;
      }

      /* Modal Styles */
      .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        color: #333;
        font-weight: 600;
      }

      .modal-footer .btn-primary {
        background-color: #ee714a;
        border-color: #ee714a;
      }

      .modal-footer .btn-primary:hover {
        background-color: #e85c50;
        border-color: #e85c50;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .address-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .address-selection {
          margin-bottom: 15px;
          flex: 0 0 auto;
        }

        .address-details {
          padding: 0;
          margin-bottom: 15px;
          width: 100%;
        }

        .address-actions {
          flex: 0 0 auto;
          width: 100%;
          flex-direction: row;
          justify-content: flex-end;
        }

        .address-actions .btn {
          flex: 1;
        }

        .action-buttons-container {
          flex-direction: column;
        }

        .success-message-container {
          top: 80px;
          left: 10px;
          right: 10px;
          min-width: auto;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Your existing header, nav, top bar, etc. -->
    <!-- Top bar Start -->
    <div class="top-bar">
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-6">
            <i class="fa fa-envelope"></i>
            support@email.com
          </div>
          <div class="col-sm-6">
            <i class="fa fa-phone-alt"></i>
            +012-345-6789
          </div>
        </div>
      </div>
    </div>
    <!-- Top bar End -->

    <!-- Nav Bar Start -->
    <div class="nav">
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md bg-dark navbar-dark">
          <a href="#" class="navbar-brand">ShopStyle</a>
          <button
            type="button"
            class="navbar-toggler"
            data-toggle="collapse"
            data-target="#navbarCollapse"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div
            class="collapse navbar-collapse justify-content-between"
            id="navbarCollapse"
          >
            <div class="navbar-nav mr-auto">
              <a href="index.html" class="nav-item nav-link active">Home</a>
              <a href="product-list.html" class="nav-item nav-link">Products</a>
              <a
                href="product-detail.html"
                class="nav-item nav-link"
                style="display: none"
                >Product Detail</a
              >
              <!-- Protected menu items -->
              <a
                href="cart.html"
                class="nav-item nav-link protected-menu"
                id="cartMenuItem"
                >Cart</a
              >
              <a
                href="checkout.html"
                class="nav-item nav-link protected-menu"
                id="checkoutMenuItem"
                >Checkout</a
              >
            </div>
            <div class="navbar-nav ml-auto align-items-center">
              <!-- User Account dropdown (only visible after login) -->
              <div
                class="nav-item dropdown user-account"
                id="userAccountDropdown"
              >
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-toggle="dropdown"
                >
                  <i class="fa fa-user-circle"></i> My Account
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                  <!-- <a href="my-account.html" class="dropdown-item">Dashboard</a>
                  <a href="manage-addresses.html" class="dropdown-item">Manage Addresses</a>
                  <a href="order-history.html" class="dropdown-item">Order History</a>
                  <div class="dropdown-divider"></div> -->
                  <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                </div>
              </div>

              <!-- Login button (only visible before login) -->
              <a href="login.html" class="btn login-btn" id="loginBtn">LOGIN</a>
            </div>
          </div>
        </nav>
      </div>
    </div>
    <!-- Nav Bar End -->

    <!-- Bottom Bar Start -->
    <div class="bottom-bar">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-3">
            <div class="logo">
              <a href="index.html">
                <img src="img/logo.png" alt="Logo" />
              </a>
            </div>
          </div>
          <div class="col-md-6">
            <div class="search">
              <input type="text" placeholder="Search" />
              <button><i class="fa fa-search"></i></button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="user">
              <a href="wishlist.html" class="btn wishlist">
                <i class="fa fa-heart"></i>
                <span class="wishlist-count">(0)</span>
              </a>
              <a href="cart.html" class="btn cart cart-link">
                <i class="fa fa-shopping-cart"></i>
                <span class="cart-count">(0)</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Bottom Bar Ends -->

    <!-- Breadcrumb -->
    <div class="breadcrumb-wrap">
      <div class="container-fluid">
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item">
            <a href="my-account.html">My Account</a>
          </li>
          <li class="breadcrumb-item active">Manage Addresses</li>
        </ul>
      </div>
    </div>

    <!-- Success Message Container - FIXED POSITION -->
    <div id="successMessageContainer" class="success-message-container">
      <div class="success-message-content">
        <div class="success-message-icon">
          <i class="fa fa-check-circle"></i>
        </div>
        <div class="success-message-text" id="successMessageText">
          Address added successfully!
        </div>
        <button class="success-message-close" onclick="hideSuccessMessage()">
          &times;
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
      <div class="manage-addresses-container">
        <div class="manage-addresses-header">
          <h2><i class="fa fa-map-marker-alt mr-2"></i>Manage Addresses</h2>
          <button
            class="btn add-address-btn"
            data-toggle="modal"
            data-target="#addressModal"
          >
            <i class="fa fa-plus mr-2"></i>Add New Address
          </button>
        </div>

        <!-- Selection Status -->
        <div id="selectionStatus" style="display: none">
          <div class="selection-status">
            <div>
              <h6 class="mb-1">
                <i class="fa fa-check-circle text-success mr-2"></i>Address
                Selected for Checkout
              </h6>
              <p class="mb-0" id="selectedAddressInfo"></p>
            </div>
          </div>
        </div>

        <!-- No Selection Message -->
        <div id="noSelectionMessage" class="no-selection-msg" style="display: none">
          <i class="fa fa-exclamation-triangle mr-2"></i>
          No address selected. Please select an address for checkout.
        </div>

        <!-- Addresses List -->
        <div id="addressesContainer">
          <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <p>Loading your addresses...</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons-container" id="actionButtons" style="display: none">
          <a href="checkout.html" class="btn proceed-checkout-btn">
            <i class="fa fa-shopping-cart mr-2"></i>Proceed to Checkout
          </a>
          <button
            class="btn add-address-btn"
            data-toggle="modal"
            data-target="#addressModal"
          >
            <i class="fa fa-plus mr-2"></i>Add Another Address
          </button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none">
          <i class="fa fa-map-marker-alt"></i>
          <h4>No Addresses Found</h4>
          <p class="text-muted">
            You haven't added any addresses yet. Add your first address to get
            started.
          </p>
          <button
            class="btn add-address-btn"
            data-toggle="modal"
            data-target="#addressModal"
          >
            <i class="fa fa-plus mr-2"></i>Add Your First Address
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Address Modal -->
    <div class="modal fade" id="addressModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Add New Address</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="addressForm">
              <input type="hidden" id="addressId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Full Name *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="fullName"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Phone Number *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="phone"
                      required
                    />
                    <small class="form-text text-muted"
                      >10-digit mobile number</small
                    >
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>House/Building/Apartment *</label>
                <input type="text" class="form-control" id="house" required />
              </div>

              <div class="form-group">
                <label>Street/Locality</label>
                <input type="text" class="form-control" id="street" />
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>City *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="city"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>State *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="state"
                      required
                    />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Pin Code *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="pinCode"
                      required
                    />
                    <small class="form-text text-muted"
                      >6-digit postal code</small
                    >
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Country</label>
                    <input
                      type="text"
                      class="form-control"
                      id="country"
                      value="India"
                      readonly
                    />
                    <small class="form-text text-muted"
                      >Currently we only deliver to India</small
                    >
                  </div>
                </div>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="isDefault"
                  />
                  <label class="form-check-label" for="isDefault">
                    Set as default address
                  </label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveAddressBtn">
              Save Address
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer Start -->
    <div class="footer">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Get in Touch</h2>
              <div class="contact-info">
                <p>
                  <i class="fa fa-map-marker"></i>123 E Store, Los Angeles, USA
                </p>
                <p><i class="fa fa-envelope"></i>email@example.com</p>
                <p><i class="fa fa-phone"></i>+123-456-7890</p>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Follow Us</h2>
              <div class="contact-info">
                <div class="social">
                  <a href=""><i class="fab fa-twitter"></i></a>
                  <a href=""><i class="fab fa-facebook-f"></i></a>
                  <a href=""><i class="fab fa-linkedin-in"></i></a>
                  <a href=""><i class="fab fa-instagram"></i></a>
                  <a href=""><i class="fab fa-youtube"></i></a>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Company Info</h2>
              <ul>
                <li><a href="#">About Us</a></li>
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Terms & Condition</a></li>
              </ul>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Purchase Info</h2>
              <ul>
                <li><a href="#">Pyament Policy</a></li>
                <li><a href="#">Shipping Policy</a></li>
                <li><a href="#">Return Policy</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="row payment align-items-center">
          <div class="col-md-6">
            <div class="payment-method">
              <h2>We Accept:</h2>
              <img src="img/payment-method.png" alt="Payment Method" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="payment-security">
              <h2>Secured By:</h2>
              <img src="img/godaddy.svg" alt="Payment Security" />
              <img src="img/norton.svg" alt="Payment Security" />
              <img src="img/ssl.svg" alt="Payment Security" />
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer End -->

    <!-- Footer Bottom Start -->
    <div class="footer-bottom">
      <div class="container">
        <div class="row">
          <div class="col-md-6 copyright">
            <p>
              Copyright &copy; <a href="#">ShopStyle</a>. All Rights Reserved
            </p>
          </div>

          <div class="col-md-6 template-by">
            <p>Designed By <a href="https://htmlcodex.com">HTML Codex</a></p>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer Bottom End -->

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

       <script>
      let addresses = [];
      let selectedAddressId = null;
      let redirectTimer = null;

      // Load addresses when page loads
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded");
        checkAuthAndUpdateUI();
        loadAddresses();
        setupEventListeners();

        // Check if there's a previously selected address
        selectedAddressId = localStorage.getItem("selectedAddressId");
      });

      function setupEventListeners() {
        // Save address button
        document
          .getElementById("saveAddressBtn")
          .addEventListener("click", saveAddress);

        // Modal reset when closed
        $("#addressModal").on("hidden.bs.modal", function () {
          resetForm();
        });

        // Logout functionality
        document
          .getElementById("logoutBtn")
          .addEventListener("click", logoutUser);

        // Add address button
        document
          .querySelector(".add-address-btn")
          .addEventListener("click", function () {
            document.getElementById("modalTitle").textContent =
              "Add New Address";
            document.getElementById("addressId").value = "";
            $("#addressModal").modal("show");
          });
      }

      // Check authentication and update UI
      function checkAuthAndUpdateUI() {
        const token = localStorage.getItem("token");
        const isLoggedIn = !!token;

        if (isLoggedIn) {
          // Hide login button, show user account
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("userAccountDropdown").style.display =
            "block";

          // Show protected menu items
          document.querySelectorAll(".protected-menu").forEach((item) => {
            item.style.display = "block";
          });

          // Load cart count
          loadCartCount();
        } else {
          // Show login button, hide user account
          document.getElementById("loginBtn").style.display = "inline-block";
          document.getElementById("userAccountDropdown").style.display = "none";

          // Hide protected menu items
          document.querySelectorAll(".protected-menu").forEach((item) => {
            item.style.display = "none";
          });
        }
      }

      // Load cart count from API
      async function loadCartCount() {
        const token = localStorage.getItem("token");
        if (!token) {
          console.log("No token found, skipping cart count");
          return;
        }

        try {
          console.log("ðŸ›’ Loading cart count...");
          const response = await fetch("/api/user/cart/getAll", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            console.log("ðŸ›’ Cart data:", data);

            let cartCount = 0;

            if (data.success && data.cart && data.cart.items) {
              // Calculate total items in cart
              cartCount = data.cart.items.reduce(
                (total, item) => total + (item.quantity || 0),
                0
              );
            } else if (data.success && data.cartItems) {
              // Alternative data structure
              cartCount = data.cartItems.length || 0;
            } else if (data.totalItems) {
              // Another alternative
              cartCount = data.totalItems;
            }

            updateCartCountUI(cartCount);
          } else {
            console.log("ðŸ›’ Failed to load cart, status:", response.status);
            updateCartCountUI(0);
          }
        } catch (error) {
          console.error("ðŸ›’ Error loading cart count:", error);
          updateCartCountUI(0);
        }
      }

      // Update cart count UI
      function updateCartCountUI(count) {
        const cartCountElement = document.querySelector(".cart-count");

        if (cartCountElement) {
          cartCountElement.textContent = `(${count})`;
        }
      }

      // Logout function
      function logoutUser() {
        const logoutConfirmed = showConfirmMessage(
          "Are you sure you want to logout?", 
          "Confirm Logout"
        );
        
        if (logoutConfirmed) {
          localStorage.removeItem("token");
          localStorage.removeItem("userName");
          localStorage.removeItem("userId");
          localStorage.removeItem("selectedAddressId");

          // Clear cart count
          updateCartCountUI(0);

          // Update UI
          checkAuthAndUpdateUI();

          // Redirect to home page
          window.location.href = "index.html";
        }
      }

      async function loadAddresses() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          console.log("ðŸ” Loading addresses...");
          const response = await fetch("/api/user/addresses", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          console.log("ðŸ“¡ Response status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("âœ… API Response data:", data);
            addresses = data.addresses || data.data || [];
            renderAddresses();
          } else {
            console.log("âŒ Response not OK");
            throw new Error("Failed to load addresses");
          }
        } catch (error) {
          console.error("Error loading addresses:", error);
          showMessage("Error loading addresses", "danger");
        }
      }

      // Handle radio button selection
      function handleAddressSelection(addressId) {
        selectedAddressId = addressId;
        localStorage.setItem("selectedAddressId", addressId);
        
        const address = addresses.find(addr => addr._id === addressId);
        if (address) {
          // Update selection status
          updateSelectionStatus(address);
          
          // Update radio buttons
          updateRadioButtons();
          
          // Save to backend (optional)
          saveSelectedAddress(addressId);
        }
      }

      // Update radio buttons state
      function updateRadioButtons() {
        document.querySelectorAll('.address-radio').forEach(radio => {
          radio.checked = radio.value === selectedAddressId;
        });
        
        // Update row classes
        document.querySelectorAll('.address-row').forEach(row => {
          const addressId = row.dataset.addressId;
          if (addressId === selectedAddressId) {
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        });
      }

      // Update selection status display
      function updateSelectionStatus(address) {
        const selectionStatus = document.getElementById('selectionStatus');
        const noSelectionMessage = document.getElementById('noSelectionMessage');
        const actionButtons = document.getElementById('actionButtons');
        const selectedAddressInfo = document.getElementById('selectedAddressInfo');
        
        if (address) {
          selectedAddressInfo.textContent = 
            `${address.fullName} â€¢ ${address.phone} â€¢ ${address.city}, ${address.state}`;
          selectionStatus.style.display = 'block';
          noSelectionMessage.style.display = 'none';
          actionButtons.style.display = 'flex';
        } else {
          selectionStatus.style.display = 'none';
          noSelectionMessage.style.display = 'block';
          actionButtons.style.display = 'flex';
        }
      }

      // Optional: Save selected address to backend
      async function saveSelectedAddress(addressId) {
        const token = localStorage.getItem("token");
        try {
          await fetch("/api/user/selected-address", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ addressId }),
          });
        } catch (error) {
          console.error("Error saving selected address:", error);
        }
      }

      function renderAddresses() {
        const container = document.getElementById("addressesContainer");
        const emptyState = document.getElementById("emptyState");
        const actionButtons = document.getElementById("actionButtons");

        console.log("ðŸŽ¨ Rendering addresses...", addresses);

        if (addresses.length === 0) {
          console.log("ðŸ“­ No addresses to display");
          container.style.display = "none";
          emptyState.style.display = "block";
          actionButtons.style.display = "none";
          return;
        }

        console.log(
          "ðŸ–¼ï¸ Creating address rows for",
          addresses.length,
          "addresses"
        );

        container.style.display = "block";
        emptyState.style.display = "none";
        actionButtons.style.display = "flex";

        // Check if we have a selected address, if not use the default
        if (
          !selectedAddressId ||
          !addresses.find((addr) => addr._id === selectedAddressId)
        ) {
          const defaultAddress = addresses.find((addr) => addr.isDefault);
          if (defaultAddress) {
            selectedAddressId = defaultAddress._id;
            localStorage.setItem("selectedAddressId", selectedAddressId);
          }
        }

        // Get selected address details
        const selectedAddress = selectedAddressId
          ? addresses.find((addr) => addr._id === selectedAddressId)
          : null;

        // Update selection status
        updateSelectionStatus(selectedAddress);

        // Create address rows
        container.innerHTML = addresses
          .map(
            (address) => `
            <div class="address-row ${
              selectedAddressId === address._id ? "selected" : ""
            } ${address.isDefault ? "default" : ""}" data-address-id="${
              address._id
            }">
              <div class="address-selection">
                <div class="form-check">
                  <input 
                    class="form-check-input address-radio" 
                    type="radio" 
                    name="addressSelection" 
                    value="${address._id}" 
                    ${selectedAddressId === address._id ? "checked" : ""}
                    onchange="handleAddressSelection('${address._id}')"
                  >
                </div>
              </div>
              
              <div class="address-details">
                <div class="address-details-header">
                  <h6 class="address-name">${address.fullName}</h6>
                  ${
                    address.isDefault
                      ? '<span class="address-type-badge"><span class="badge badge-success"><i class="fa fa-star mr-1"></i>Default</span></span>'
                      : ""
                  }
                </div>
                
                <div class="address-info">
                  <p><i class="fa fa-home"></i> ${address.house}</p>
                  ${
                    address.street
                      ? `<p><i class="fa fa-road"></i> ${address.street}</p>`
                      : ""
                  }
                  <p><i class="fa fa-city"></i> ${address.city}, ${
              address.state
            } - ${address.pinCode}</p>
                  <p><i class="fa fa-phone"></i> ${address.phone}</p>
                </div>
              </div>
              
              <div class="address-actions">
                ${
                  !address.isDefault
                    ? `<button class="btn btn-set-default" onclick="setDefaultAddress('${address._id}')">
                        <i class="fa fa-star mr-1"></i>Set Default
                      </button>`
                    : ""
                }
                <button class="btn btn-edit" onclick="editAddress('${
                  address._id
                }')">
                  <i class="fa fa-edit mr-1"></i>Edit
                </button>
                <button class="btn btn-delete" onclick="deleteAddress('${
                  address._id
                }')">
                  <i class="fa fa-trash mr-1"></i>Delete
                </button>
              </div>
            </div>
          `
          )
          .join("");

        console.log("âœ… Finished rendering addresses");
      }

      function editAddress(addressId) {
        const address = addresses.find((addr) => addr._id === addressId);
        if (!address) return;

        document.getElementById("modalTitle").textContent = "Edit Address";
        document.getElementById("addressId").value = address._id;
        document.getElementById("fullName").value = address.fullName;
        document.getElementById("phone").value = address.phone;
        document.getElementById("pinCode").value = address.pinCode;
        document.getElementById("street").value = address.street || "";
        document.getElementById("house").value = address.house;
        document.getElementById("city").value = address.city;
        document.getElementById("state").value = address.state;
        document.getElementById("country").value = address.country || "India";
        document.getElementById("isDefault").checked = address.isDefault;

        $("#addressModal").modal("show");
      }

      // Validate phone number
      function validatePhoneNumber(phone) {
        const phoneRegex = /^[0-9]{10}$/;
        return phoneRegex.test(phone);
      }

      // Validate pin code
      function validatePinCode(pinCode) {
        return pinCode.length === 6 && /^\d+$/.test(pinCode);
      }

async function saveAddress() {
  const token = localStorage.getItem("token");
  const addressId = document.getElementById("addressId").value;
  const isEdit = !!addressId;

  const addressData = {
    fullName: document.getElementById("fullName").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    pinCode: document.getElementById("pinCode").value.trim(),
    street: document.getElementById("street").value.trim(),
    house: document.getElementById("house").value.trim(),
    city: document.getElementById("city").value.trim(),
    state: document.getElementById("state").value.trim(),
    country: document.getElementById("country").value.trim(),
    isDefault: document.getElementById("isDefault").checked,
  };

  // Basic validation
  if (
    !addressData.fullName ||
    !addressData.phone ||
    !addressData.pinCode ||
    !addressData.house ||
    !addressData.city ||
    !addressData.state
  ) {
    showMessage("Please fill all required fields", "warning");
    return;
  }

  // Phone validation
  if (!validatePhoneNumber(addressData.phone)) {
    showMessage("Please enter a valid 10-digit phone number", "warning");
    return;
  }

  // Pin code validation
  if (!validatePinCode(addressData.pinCode)) {
    showMessage("Please enter a valid 6-digit pin code", "warning");
    return;
  }

  try {
    const url = isEdit
      ? `/api/user/addresses/${addressId}`
      : "/api/user/addresses";
    const method = isEdit ? "PUT" : "POST";

    console.log("ðŸ“¤ Saving address:", {
      url,
      method,
      isEdit,
      addressData
    });

    // Show loading state
    const saveBtn = document.getElementById("saveAddressBtn");
    const originalBtnText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    const response = await fetch(url, {
      method: method,
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(addressData),
    });

    console.log("ðŸ“¥ Save response status:", response.status);

    // Restore button state
    saveBtn.innerHTML = originalBtnText;
    saveBtn.disabled = false;

    // Try to parse response
    let responseData;
    try {
      responseData = await response.json();
      console.log("ðŸ“¥ Save response data:", responseData);
    } catch (jsonError) {
      console.log("ðŸ“¥ No JSON response or parse error:", jsonError);
      responseData = {};
    }

    if (response.ok) {
      // Close modal
      $("#addressModal").modal("hide");
      resetForm();
      
      // Show success message
      const message = isEdit ? "Address updated successfully!" : "Address added successfully!";
      console.log("âœ… Showing success message:", message);
      
      // Show success message
      showSuccessMessage(message);
      
      // Clear any existing redirect timer
      if (redirectTimer) {
        clearTimeout(redirectTimer);
      }
      
      // Set redirect timer
      redirectTimer = setTimeout(() => {
        console.log("ðŸ”„ Redirecting to address.html");
        window.location.href = "address.html";
      }, 2000); // 2 seconds delay
      
      // Reload addresses
      loadAddresses();
      
    } else {
      // Handle error response
      const errorMessage = responseData.message || 
                          responseData.error || 
                          `Failed to ${isEdit ? 'update' : 'add'} address. Status: ${response.status}`;
      console.error("âŒ Save error:", errorMessage);
      showMessage(errorMessage, "danger");
      
      // If it's a 401 error (unauthorized), redirect to login
      if (response.status === 401) {
        showMessage("Session expired. Please login again.", "warning");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2000);
      }
    }
  } catch (error) {
    console.error("ðŸ’¥ Network/Request error:", error);
    showMessage("Network error. Please check your connection.", "danger");
    
    // Restore button state in case of error
    const saveBtn = document.getElementById("saveAddressBtn");
    saveBtn.innerHTML = "Save Address";
    saveBtn.disabled = false;
  }
}

// Show success message (non-alert)
function showSuccessMessage(message) {
  console.log("ðŸš€ Attempting to show success message:", message);
  
  const messageContainer = document.getElementById("successMessageContainer");
  const messageText = document.getElementById("successMessageText");
  
  if (!messageContainer) {
    console.error("âŒ Success message container not found!");
    showMessage(message, "success"); // Fallback to regular message
    return;
  }
  
  if (!messageText) {
    console.error("âŒ Success message text element not found!");
    showMessage(message, "success"); // Fallback to regular message
    return;
  }
  
  // Update message text
  messageText.textContent = message;
  
  // Remove any existing animation classes
  messageContainer.classList.remove("hide", "show");
  
  // Force reflow
  void messageContainer.offsetWidth;
  
  // Show with animation
  messageContainer.style.display = "block";
  messageContainer.classList.add("show");
  
  console.log("âœ… Success message should be visible now");
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    hideSuccessMessage();
  }, 3000);
}

// Hide success message
function hideSuccessMessage() {
  const messageContainer = document.getElementById("successMessageContainer");
  if (!messageContainer) return;
  
  messageContainer.classList.remove("show");
  messageContainer.classList.add("hide");
  
  // Hide after animation
  setTimeout(() => {
    messageContainer.classList.remove("hide");
    messageContainer.style.display = "none";
  }, 500);
}

async function deleteAddress(addressId) {
  const address = addresses.find((addr) => addr._id === addressId);
  if (!address) return;

  // Show custom confirmation dialog instead of alert
  if (!await showConfirmMessage(`Are you sure you want to delete the address for ${address.fullName}?`, "Confirm Deletion")) {
    return;
  }

  const token = localStorage.getItem("token");
  try {
    const response = await fetch(`/api/user/addresses/${addressId}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    });

    if (response.ok) {
      // If deleted address was selected, clear selection
      if (selectedAddressId === addressId) {
        selectedAddressId = null;
        localStorage.removeItem("selectedAddressId");
        showMessage(
          `Address "${address.fullName}" deleted and unselected`,
          "info"
        );
      } else {
        showMessage("Address deleted successfully", "success");
      }

      loadAddresses();
    } else {
      throw new Error("Failed to delete address");
    }
  } catch (error) {
    console.error("Error deleting address:", error);
    showMessage("Error deleting address", "danger");
  }
}

async function setDefaultAddress(addressId) {
  const address = addresses.find((addr) => addr._id === addressId);
  if (!address) return;

  const token = localStorage.getItem("token");
  try {
    const response = await fetch(`/api/user/addresses/${addressId}`, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ isDefault: true }),
    });

    if (response.ok) {
      // If no address is currently selected, select this one as it becomes default
      if (!selectedAddressId) {
        selectedAddressId = addressId;
        localStorage.setItem("selectedAddressId", addressId);
        showMessage(
          `Address set as default and selected: ${address.fullName}`,
          "success"
        );
      } else {
        showMessage("Address set as default successfully", "success");
      }

      loadAddresses();
    } else {
      throw new Error("Failed to set default address");
    }
  } catch (error) {
    console.error("Error setting default address:", error);
    showMessage("Error setting default address", "danger");
  }
}

function resetForm() {
  document.getElementById("addressForm").reset();
  document.getElementById("addressId").value = "";
  document.getElementById("country").value = "India";
}

function showMessage(message, type) {
  const alertDiv = document.createElement("div");
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
      ${message}
      <button type="button" class="close" data-dismiss="alert">
          <span>&times;</span>
      </button>
  `;

  document
    .querySelector(".manage-addresses-container")
    .insertBefore(
      alertDiv,
      document.querySelector(".manage-addresses-container").firstChild
    );

  setTimeout(() => {
    if (alertDiv.parentElement) {
      alertDiv.remove();
    }
  }, 5000);
}

// Custom confirmation dialog function
function showConfirmMessage(message, title = "Confirm") {
  return new Promise((resolve) => {
    // Remove any existing confirmation modal
    const existingModal = document.getElementById("customConfirmModal");
    if (existingModal) {
      existingModal.remove();
    }

    // Create confirmation modal
    const modalHtml = `
      <div class="modal fade" id="customConfirmModal" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${title}</h5>
              <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('customConfirmModal').remove(); resolve(false);">
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>${message}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="document.getElementById('customConfirmModal').remove(); resolve(false);">
                Cancel
              </button>
              <button type="button" class="btn btn-primary" onclick="document.getElementById('customConfirmModal').remove(); resolve(true);">
                Confirm
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // Show modal
    $('#customConfirmModal').modal('show');

    // Clean up when modal is hidden
    $('#customConfirmModal').on('hidden.bs.modal', function () {
      if (document.getElementById('customConfirmModal')) {
        document.getElementById('customConfirmModal').remove();
        resolve(false);
      }
    });
  });
}
    </script>
  </body>
</html>