<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Addresses - ShopStyle</title>
    <!-- Include your existing CSS and JS libraries -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <style>
        .address-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .address-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .address-card.default {
            border-color: #ee714a;
            background-color: #fff9f7;
        }
        .action-buttons .btn {
            margin-right: 8px;
            margin-bottom: 5px;
        }
        .add-address-btn {
            background: linear-gradient(135deg, #b37de8 0%, #ee714a 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Your existing header, nav, top bar, etc. -->

    <!-- Breadcrumb -->
    <div class="breadcrumb-wrap">
        <div class="container-fluid">
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="my-account.html">My Account</a></li>
                <li class="breadcrumb-item active">Manage Addresses</li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fa fa-map-marker-alt mr-2"></i>Manage Addresses</h2>
                    <button class="btn add-address-btn" data-toggle="modal" data-target="#addressModal">
                        <i class="fa fa-plus mr-2"></i>Add New Address
                    </button>
                </div>

                <!-- Addresses List -->
                <div id="addressesContainer" class="row">
                    <!-- Address cards will be loaded here dynamically -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p>Loading addresses...</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center" style="display: none;">
                    <i class="fa fa-map-marker-alt fa-3x text-muted mb-3"></i>
                    <h4>No Addresses Found</h4>
                    <p class="text-muted">You haven't added any addresses yet.</p>
                    <button class="btn add-address-btn" data-toggle="modal" data-target="#addressModal">
                        <i class="fa fa-plus mr-2"></i>Add Your First Address
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Address</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <input type="hidden" id="addressId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="text" class="form-control" id="phone" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>House/Building/Apartment *</label>
                        <input type="text" class="form-control" id="house" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Street/Locality</label>
                        <input type="text" class="form-control" id="street">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>City *</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>State *</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Pin Code *</label>
                                <input type="text" class="form-control" id="pinCode" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" class="form-control" id="country" value="India" readonly>
                                <small class="form-text text-muted">Currently we only deliver to India</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isDefault">
                            <label class="form-check-label" for="isDefault">
                                Set as default address
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddressBtn">Save Address</button>
            </div>
        </div>
    </div>
</div>

    <!-- Your existing footer -->

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let addresses = [];

        // Load addresses when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAddresses();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Save address button
            document.getElementById('saveAddressBtn').addEventListener('click', saveAddress);
            
            // Modal reset when closed
            $('#addressModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        }

        async function loadAddresses() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                console.log('ðŸ” Loading addresses...');
                const response = await fetch('/api/user/addresses', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('ðŸ“¡ Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… API Response data:', data); // Debug log
                    console.log('ðŸ“¦ Addresses array:', data.addresses || data.data);
                    addresses = data.addresses || data.data || [];
                    console.log('ðŸ‘¨â€ðŸ’¼ Final addresses to render:', addresses);
                    renderAddresses();
                } else {
                    console.log('âŒ Response not OK');
                    throw new Error('Failed to load addresses');
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
                showMessage('Error loading addresses', 'danger');
            }
        }

        function renderAddresses() {
            const container = document.getElementById('addressesContainer');
            const emptyState = document.getElementById('emptyState');

            console.log('ðŸŽ¨ Rendering addresses...', addresses);

            if (addresses.length === 0) {
                console.log('ðŸ“­ No addresses to display');
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

             console.log('ðŸ–¼ï¸ Creating address cards for', addresses.length, 'addresses');

            container.style.display = 'block';
            emptyState.style.display = 'none';

            container.innerHTML = addresses.map(address => `
                <div class="col-md-6 col-lg-4">
                    <div class="address-card ${address.isDefault ? 'default' : ''}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            ${address.isDefault ? 
                                '<span class="badge badge-success"><i class="fa fa-star mr-1"></i>Default</span>' : 
                                '<span class="badge badge-primary">Address</span>'
                            }
                        </div>
                        
                        <h6 class="font-weight-bold">${address.fullName}</h6>
                        <p class="mb-1">${address.house}</p>
                        <p class="mb-1">${address.street}, ${address.city}</p>
                        <p class="mb-1">${address.state} - ${address.pincode}</p>
                        <p class="mb-2"><i class="fa fa-phone mr-1"></i>${address.phone}</p>
                        
                        <div class="action-buttons">
                            ${!address.isDefault ? 
                                `<button class="btn btn-sm btn-outline-primary" onclick="setDefaultAddress('${address._id}')">
                                    <i class="fa fa-star mr-1"></i>Set Default
                                </button>` : 
                                ''
                            }
                            <button class="btn btn-sm btn-outline-secondary" onclick="editAddress('${address._id}')">
                                <i class="fa fa-edit mr-1"></i>Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress('${address._id}')">
                                <i class="fa fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
             console.log('âœ… Finished rendering addresses');
        }

        function getAddressTypeBadge(type) {
            const badges = {
                'home': 'primary',
                'work': 'info', 
                'other': 'secondary'
            };
            return badges[type] || 'secondary';
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Address';
            document.getElementById('addressId').value = '';
            $('#addressModal').modal('show');
        }
        // --------------------------------Edit Address --------------------------
    function editAddress(addressId) {
    const address = addresses.find(addr => addr._id === addressId);
    if (!address) return;

    document.getElementById('modalTitle').textContent = 'Edit Address';
    document.getElementById('addressId').value = address._id;
    document.getElementById('fullName').value = address.fullName;
    document.getElementById('phone').value = address.phone; // Changed from mobile
    document.getElementById('pinCode').value = address.pinCode; // Changed from pincode
    document.getElementById('street').value = address.street || ''; // Changed from locality
    document.getElementById('house').value = address.house; // New field - this was causing the error
    document.getElementById('city').value = address.city;
    document.getElementById('state').value = address.state;
    document.getElementById('country').value = address.country || 'India';
    document.getElementById('isDefault').checked = address.isDefault;

    $('#addressModal').modal('show');
}

    async function saveAddress() {
    const token = localStorage.getItem('token');
    console.log(token);
    const addressId = document.getElementById('addressId').value;
    const isEdit = !!addressId;

    // Use the correct field names that match your HTML
    const addressData = {
        fullName: document.getElementById('fullName').value,
        phone: document.getElementById('phone').value, // Changed from mobile
        pinCode: document.getElementById('pinCode').value, // Changed from pincode
        street: document.getElementById('street').value, // Changed from locality
        house: document.getElementById('house').value, // This field was missing
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        country: document.getElementById('country').value,
        isDefault: document.getElementById('isDefault').checked
    };

    // Basic validation - update field names here too
    if (!addressData.fullName || !addressData.phone || !addressData.pinCode || 
        !addressData.house || !addressData.city || !addressData.state) {
        showMessage('Please fill all required fields', 'warning');
        return;
    }

    try {
        // Also update the API endpoints here
        const url = isEdit ? `/api/user/addresses/${addressId}` : '/api/user/addresses';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(addressData)
        });

        if (response.ok) {
            $('#addressModal').modal('hide');
            showMessage(`Address ${isEdit ? 'updated' : 'added'} successfully`, 'success');
            loadAddresses();
        } else {
            const error = await response.json();
            throw new Error(error.message || 'Failed to save address');
        }
    } catch (error) {
        console.error('Error saving address:', error);
        showMessage(error.message, 'danger');
    }
}
        async function deleteAddress(addressId) {
            if (!confirm('Are you sure you want to delete this address?')) return;

            const token = localStorage.getItem('token');
            console.log("token");
            try {
                const response = await fetch(`/api/user/addresses/${addressId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showMessage('Address deleted successfully', 'success');
                    loadAddresses(); // Reload the list
                } else {
                    throw new Error('Failed to delete address');
                }
            } catch (error) {
                console.error('Error deleting address:', error);
                showMessage('Error deleting address', 'danger');
            }
        }

        async function setDefaultAddress(addressId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/user/addresses/${addressId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isDefault: true })
                });

                if (response.ok) {
                    showMessage('Default address updated successfully', 'success');
                    loadAddresses(); // Reload the list
                } else {
                    throw new Error('Failed to set default address');
                }
            } catch (error) {
                console.error('Error setting default address:', error);
                showMessage('Error setting default address', 'danger');
            }
        }

        function resetForm() {
            document.getElementById('addressForm').reset();
            document.getElementById('addressId').value = '';
        }

        function showMessage(message, type) {
            // Create a temporary alert message
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            `;
            
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Update the add address button to use our function
        document.querySelector('.add-address-btn').addEventListener('click', openAddModal);
    </script>
</body>
</html>