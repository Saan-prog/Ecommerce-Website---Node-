<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Orders - ShopStyle</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS Libraries -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <style>
        /* Order History Page Styles - Clean Version */
        .order-history {
            padding: 30px 0;
            min-height: 70vh;
        }

        /* Page Header - Smaller and Cleaner */
        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            color: #2c3e50;
            font-weight: 700;
            margin: 0;
            font-size: 28px;
            font-family: 'Inter', sans-serif;
        }

        .page-subtitle {
            color: #7f8c8d;
            margin-top: 5px;
            font-size: 15px;
        }

        /* Table Styles - Clean and Larger */
        .orders-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid #eaeaea;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        /* Table Header - Clean without orange */
        .orders-table thead {
            background: #f8f9fa;
            color: #495057;
            border-bottom: 2px solid #eaeaea;
        }

        .orders-table th {
            padding: 18px 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
            border: none;
            font-family: 'Inter', sans-serif;
        }

        /* Table Body - Clean without hover effects */
        .orders-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .orders-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .orders-table tbody tr:last-child {
            border-bottom: none;
        }

        .orders-table td {
            padding: 20px;
            vertical-align: middle;
            border: none;
            color: #333;
            font-size: 14px;
        }

        /* Order ID Column */
        .order-id-cell {
            font-family: 'Inter', monospace;
            font-weight: 600;
            color: #3395ff;
        }

        .order-id-cell .small-text {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        /* Items Column */
        .order-items-cell {
            max-width: 250px;
        }

        .order-items-preview {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .item-image {
            width: 90px;
            height: 90px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #eaeaea;
            flex-shrink: 0;
        }

        .item-details {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            font-family: 'Inter', sans-serif;
        }

        .item-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .more-items {
            font-size: 12px;
            color: #3395ff;
            margin-top: 5px;
            cursor: pointer;
            display: inline-block;
            transition: color 0.2s ease;
        }

        .more-items:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }

        /* Multi-product image grid */
        .item-images-grid {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .item-image-small {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #eaeaea;
            transition: transform 0.2s ease;
        }

        .item-image-small:hover {
            transform: scale(1.1);
            z-index: 1;
            position: relative;
        }

        /* Amount Column */
        .order-amount {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        /* Status Column - Cleaner badges */
        .order-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.2px;
        }

        .status-created {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
        }

        .status-confirmed {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .status-shipped {
            background: #e0e7ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
        }

        .status-out-for-delivery {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
        }

        .status-delivered {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-cancelled {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Actions Column - Clean buttons */
        .order-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #f8f9fa;
            border-color: #d1d5db;
            color: #374151;
        }

        .action-btn.invoice:hover {
            background: #faf5ff;
            border-color: #e9d5ff;
            color: #7c3aed;
        }

        /* Review button styles */
        .review-info {
            max-width: 300px;
        }

        .add-review-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            font-weight: 500;
        }

        .add-review-btn:hover {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #000;
            text-decoration: none;
        }

        .add-review-btn i {
            font-size: 10px;
            margin-right: 5px;
        }

        .review-added-message {
            font-size: 11px;
            color: #28a745;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #d4edda;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .review-added-message i {
            margin-right: 4px;
        }

        .not-delivered-message {
            font-size: 11px;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e2e3e5;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .not-delivered-message i {
            margin-right: 4px;
        }

        /* Multi-item review styles - UPDATED */
        .product-review-column {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .product-review-column::-webkit-scrollbar {
            width: 4px;
        }

        .product-review-column::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .product-review-column::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .product-review-column::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .product-review-item {
            display: flex !important;
            flex-direction: column !important;
            margin-bottom: 10px !important;
            padding: 10px !important;
            border-bottom: 1px solid #eee !important;
            border-radius: 8px !important;
            background: #f9f9f9 !important;
            transition: background-color 0.2s ease !important;
        }

        .product-review-item:hover {
            background-color: #f0f0f0 !important;
        }

        .product-review-item:last-child {
            border-bottom: none !important;
            margin-bottom: 0 !important;
        }

        /* Show all items modal styles */
        .order-items-modal .item-detail {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }

        .order-items-modal .item-detail:last-child {
            border-bottom: none;
        }

        .order-items-modal .item-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            margin-right: 15px;
        }

        .order-items-modal .item-info {
            flex: 1;
        }

        .order-items-modal .item-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .order-items-modal .item-meta {
            font-size: 12px;
            color: #666;
        }

        /* Quantity badge */
        .quantity-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #3395ff;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Empty State */
        .empty-orders {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #eaeaea;
            margin-top: 20px;
        }

        .empty-orders-icon {
            font-size: 60px;
            color: #e5e7eb;
            margin-bottom: 20px;
        }

        .empty-orders h3 {
            color: #4b5563;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 22px;
            font-family: 'Inter', sans-serif;
        }

        .empty-orders p {
            color: #6b7280;
            margin-bottom: 25px;
            font-size: 15px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary-custom {
            background: #3395ff;
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary-custom:hover {
            background: #1d4ed8;
            color: white;
            text-decoration: none;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3395ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Payment Success Message - Clean version */
        .payment-success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .payment-success-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .payment-success-icon {
            color: #15803d;
            font-size: 20px;
        }

        .payment-success-text {
            flex: 1;
        }

        .payment-success-text h5 {
            color: #15803d;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 16px;
        }

        .payment-success-text p {
            color: #166534;
            margin-bottom: 0;
            font-size: 14px;
        }

        .payment-success-close {
            background: none;
            border: none;
            color: #15803d;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .payment-success-close:hover {
            opacity: 1;
        }

        /* Review Success Message */
        .review-success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInDown 0.5s ease-out;
        }

        .review-success-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .review-success-icon {
            color: #059669;
            font-size: 20px;
        }

        .review-success-text h5 {
            color: #059669;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 16px;
        }

        .review-success-text p {
            color: #047857;
            margin-bottom: 0;
            font-size: 14px;
        }

        .review-success-close {
            background: none;
            border: none;
            color: #059669;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .review-success-close:hover {
            opacity: 1;
        }

        /* Table row styling for better readability */
        .orders-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* Improved button styles */
        .btn {
            transition: all 0.2s ease;
        }

        .btn:focus {
            box-shadow: none;
        }

        /* Modal header styling */
        .modal-header {
            background: linear-gradient(135deg, #FF6F61 0%, #e6554f 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-weight: 600;
            color: white;
        }

        .modal-header .close {
            color: white;
            opacity: 0.8;
        }

        .modal-header .close:hover {
            opacity: 1;
        }

        /* Star Rating Styles */
        .star-rating {
            display: flex;
            gap: 10px;
            font-size: 32px;
            cursor: pointer;
            justify-content: center;
            margin: 15px 0;
        }

        .star-rating .star {
            color: #ddd;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }

        .star-rating .star i {
            transition: all 0.2s ease;
        }

        .star-rating .star.selected i {
            color: #FFD700;
        }

        .star-rating .star:hover i {
            color: #FFA500;
        }

        .star-rating .star:hover ~ .star i {
            color: #ddd;
        }

        /* Rating labels */
        .rating-labels {
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            color: #666;
        }

        .rating-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            min-height: 24px;
            margin-top: 10px;
            text-align: center;
        }

        /* Star icon shine effect */
        @keyframes starShine {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .star-rating .star.selected i {
            animation: starShine 0.3s ease;
        }

        /* Character count */
        .char-count {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #ff9800;
        }

        .char-count.danger {
            color: #f44336;
        }

        /* Review error message */
        .review-error {
            display: none;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            font-size: 14px;
        }

        /* Size badge */
        .size-badge {
            font-size: 11px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 2px;
        }

        /* Review Completed Status */
        .review-completed-status {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            font-size: 11px;
            color: #28a745;
            font-weight: 500;
        }

        .review-completed-status i {
            font-size: 12px;
        }

        .review-pending-status {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            font-size: 11px;
            color: #6c757d;
        }

        .review-pending-status i {
            font-size: 10px;
        }

        /* Responsive Styles */
        @media (max-width: 991.98px) {
            .orders-table-container {
                overflow-x: auto;
            }

            .orders-table {
                min-width: 900px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .order-actions {
                flex-direction: column;
                gap: 6px;
            }

            .action-btn {
                width: 34px;
                height: 34px;
            }

            .page-title {
                font-size: 24px;
            }
            
            .star-rating {
                font-size: 28px;
                gap: 6px;
            }
            
            .item-image-small {
                width: 35px;
                height: 35px;
            }
            
            .product-review-item {
                padding: 10px;
            }
        }

        @media (max-width: 767.98px) {
            .order-history {
                padding: 20px 0;
            }

            .page-title {
                font-size: 22px;
            }

            .orders-table th,
            .orders-table td {
                padding: 15px 12px;
                font-size: 13px;
            }

            .item-image {
                width: 70px;
                height: 70px;
            }

            .empty-orders h3 {
                font-size: 20px;
            }

            .empty-orders p {
                font-size: 14px;
            }

            .star-rating {
                font-size: 24px;
                gap: 4px;
            }

            .rating-labels {
                font-size: 10px;
            }
        }

        @media (max-width: 575.98px) {
            .page-header {
                text-align: center;
            }

            .page-title {
                font-size: 20px;
            }

            .page-subtitle {
                font-size: 13px;
            }

            .orders-table th,
            .orders-table td {
                padding: 12px 8px;
                font-size: 12px;
            }

            .order-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .empty-orders {
                padding: 40px 15px;
            }

            .empty-orders h3 {
                font-size: 18px;
            }

            .empty-orders p {
                font-size: 13px;
                padding: 0 10px;
            }

            .btn-primary-custom {
                padding: 8px 20px;
                font-size: 14px;
            }

            .payment-success-message,
            .review-success-message {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .payment-success-content,
            .review-success-content {
                flex-direction: column;
                text-align: center;
            }

            .star-rating {
                font-size: 22px;
            }

            .rating-labels {
                font-size: 9px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-3" id="loadingMessage">Processing...</p>
        </div>
    </div>

    <!-- Top bar Start -->
    <div class="top-bar">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <i class="fa fa-envelope"></i>
                    support@shopstyle.com
                </div>
                <div class="col-sm-6 text-sm-right">
                    <i class="fa fa-phone-alt"></i>
                    +1 (234) 567-8900
                </div>
            </div>
        </div>
    </div>
    <!-- Top bar End -->

    <!-- Navigation Bar Start -->
    <div class="nav">
        <div class="container-fluid">
            <nav class="navbar navbar-expand-lg">
                
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="product-list.html">Products</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="checkout.html">Checkout</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="order-history.html">My Orders</a>
                        </li>
                    </ul>

                    <div class="navbar-nav ml-auto align-items-center">
                        <div class="nav-item dropdown user-account" id="userAccountDropdown" style="display: none;">
                            <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                                <i class="fa fa-user-circle mr-1"></i> Account
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="my-account.html">Dashboard</a>
                                <a class="dropdown-item" href="#" id="logoutBtn">Logout</a>
                            </div>
                        </div>
                        <a class="btn btn-sm btn-outline-primary" href="login.html" id="loginBtn">LOGIN</a>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navigation Bar End -->

    <!-- Search Bar Start -->
    <div class="bottom-bar">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="logo">
                        <a class="navbar-brand" href="index.html">
                            <span class="logo-text">ShopStyle</span>
                        </a>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="search">
                        <input type="text" id="searchInput" placeholder="Search for products, brands, and more...">
                        <button id="searchBtn"><i class="fa fa-search"></i></button>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="user text-right">
                        <a href="wishlist.html" class="btn wishlist">
                            <i class="fa fa-heart"></i>
                            <span id="wishlist-count">(0)</span>
                        </a>
                        <a href="cart.html" class="btn cart">
                            <i class="fa fa-shopping-cart"></i>
                            <span id="cart-count">(0)</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Search Bar End -->

    <!-- Breadcrumb Start -->
    <div class="breadcrumb-wrap">
        <div class="container-fluid">
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">My Orders</li>
            </ul>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Order History Start -->
    <div class="order-history">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">My Orders</h1>
                <p class="page-subtitle" id="ordersCount">Loading...</p>
            </div>

            <!-- Payment Success Message -->
            <div id="paymentConfirmationMessage"></div>

            <!-- Review Success Message -->
            <div id="reviewConfirmationMessage"></div>

            <!-- Orders Table -->
            <div id="ordersContainer">
                <!-- Loading State -->
                <div class="loading-state" id="loadingMessage">
                    <div class="loading-spinner"></div>
                    <p>Loading your orders...</p>
                </div>

                <!-- Empty State -->
                <div class="empty-orders" id="emptyOrdersMessage" style="display: none;">
                    <div class="empty-orders-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h3>No Orders Yet</h3>
                    <p>You haven't placed any orders yet. Start shopping to see your orders here.</p>
                    <a href="product-list.html" class="btn btn-primary-custom">
                        <i class="fas fa-shopping-bag"></i> Start Shopping
                    </a>
                </div>

                <!-- Orders Table (will be loaded dynamically) -->
            </div>
        </div>
    </div>
    <!-- Order History End -->

    <!-- Review Modal (will be dynamically added) -->
    <div id="reviewModalContainer"></div>

    <!-- Footer Start -->
    <div class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="footer-widget">
                        <h2>ShopStyle</h2>
                        <div class="contact-info">
                            <p><i class="fa fa-map-marker"></i>123 Business Street, New York, NY 10001</p>
                            <p><i class="fa fa-envelope"></i>support@shopstyle.com</p>
                            <p><i class="fa fa-phone"></i>+1 (234) 567-8900</p>
                        </div>
                        <div class="social">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-widget">
                        <h2>Quick Links</h2>
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li><a href="product-list.html">Products</a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-widget">
                        <h2>Customer Service</h2>
                        <ul>
                            <li><a href="faq.html">FAQ</a></li>
                            <li><a href="shipping.html">Shipping Policy</a></li>
                            <li><a href="returns.html">Return Policy</a></li>
                            <li><a href="privacy.html">Privacy Policy</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-widget">
                        <h2>My Account</h2>
                        <ul>
                            <li><a href="my-account.html">My Account</a></li>
                            <li><a href="order-history.html">Order History</a></li>
                            <li><a href="wishlist.html">Wishlist</a></li>
                            <li><a href="newsletter.html">Newsletter</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row payment align-items-center">
                <div class="col-md-6">
                    <div class="payment-method">
                        <h3>We Accept:</h3>
                        <img src="img/payment-method.png" alt="Payment Methods">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="payment-security">
                        <h3>Secured By:</h3>
                        <img src="img/godaddy.svg" alt="GoDaddy">
                        <img src="img/norton.svg" alt="Norton">
                        <img src="img/ssl.svg" alt="SSL">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2024 ShopStyle. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-right">
                    <p>Designed with <i class="fa fa-heart text-danger"></i> for modern eCommerce</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
        // ========== NOTYF NOTIFICATION SETUP ==========
        const notyf = new Notyf({
            duration: 3000,
            position: {
                x: 'right',
                y: 'top',
            },
            types: [
                {
                    type: 'success',
                    background: '#10b981',
                    icon: {
                        className: 'fas fa-check-circle',
                        tagName: 'i',
                        color: '#fff'
                    }
                },
                {
                    type: 'error',
                    background: '#ef4444',
                    icon: {
                        className: 'fas fa-exclamation-circle',
                        tagName: 'i',
                        color: '#fff'
                    }
                },
                {
                    type: 'warning',
                    background: '#f59e0b',
                    icon: {
                        className: 'fas fa-exclamation-triangle',
                        tagName: 'i',
                        color: '#fff'
                    }
                },
                {
                    type: 'info',
                    background: '#3b82f6',
                    icon: {
                        className: 'fas fa-info-circle',
                        tagName: 'i',
                        color: '#fff'
                    }
                }
            ]
        });

        // ========== GLOBAL VARIABLES ==========
        let selectedRating = 0;
        let userReviewsCache = [];

        // ========== MAIN INITIALIZATION ==========
        document.addEventListener("DOMContentLoaded", function () {
            // Search integration
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');

            if (searchInput && searchBtn) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });

                searchBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    handleSearch();
                });
            }

            function handleSearch() {
                const query = searchInput.value.trim();

                if (!query) {
                    notyf.error('Please enter something to search');
                    return;
                }
                window.location.href = `product-list.html?search=${encodeURIComponent(query)}`;
            }

            // ========== AUTHENTICATION HANDLING ==========
            const token = localStorage.getItem("token");
            const isLoggedIn = token !== null && token !== undefined && token !== "";

            const userAccount = document.getElementById("userAccountDropdown");
            const loginBtn = document.getElementById("loginBtn");

            if (isLoggedIn) {
                if (userAccount) userAccount.style.display = "block";
                if (loginBtn) loginBtn.style.display = "none";
                updateCartCountDisplay();
            } else {
                if (userAccount) userAccount.style.display = "none";
                if (loginBtn) loginBtn.style.display = "inline-block";
                notyf.error("Please login to view your orders");
                setTimeout(() => {
                    window.location.href = "login.html?redirect=order-history.html";
                }, 1500);
                return;
            }

            // Logout functionality
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", function (e) {
                    e.preventDefault();

                    localStorage.removeItem("token");
                    localStorage.removeItem("userId");
                    localStorage.removeItem("userName");
                    localStorage.removeItem("userEmail");

                    notyf.success('Logged out successfully');
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 1500);
                });
            }

            // ========== LOAD ORDERS ==========
            showPaymentConfirmation();
            showReviewConfirmation();
            updateCartCount();
            loadOrders();
        });

        // ========== HELPER FUNCTIONS ==========
        function showLoading(message = "Processing...") {
            const loadingOverlay = document.getElementById("loadingOverlay");
            const loadingMessage = document.getElementById("loadingMessage");
            if (loadingMessage) loadingMessage.textContent = message;
            if (loadingOverlay) loadingOverlay.style.display = "flex";
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById("loadingOverlay");
            if (loadingOverlay) loadingOverlay.style.display = "none";
        }

        function updateCartCountDisplay() {
            try {
                const cartCount = localStorage.getItem('cartCount') || '0';
                document.querySelectorAll('#cart-count').forEach(el => {
                    el.textContent = `(${cartCount})`;
                });
            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

        function showPaymentConfirmation() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment') === 'success';
            const orderId = urlParams.get('orderId');
            const storedPaymentSuccess = localStorage.getItem('paymentSuccess');
            const storedOrderId = localStorage.getItem('latestOrderId');
            const confirmedOrderId = orderId || storedOrderId;

            if (paymentSuccess || storedPaymentSuccess === 'true') {
                const messageContainer = document.getElementById('paymentConfirmationMessage');
                let messageHTML = `
                    <div class="payment-success-message">
                        <div class="payment-success-content">
                            <div class="payment-success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="payment-success-text">
                                <h5>Payment Successful!</h5>
                                <p>Thank you for your order! Your payment has been confirmed${confirmedOrderId ? ` for Order #${confirmedOrderId}` : ''}.</p>
                            </div>
                            <button class="payment-success-close" onclick="closePaymentMessage()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                messageContainer.innerHTML = messageHTML;

                if (paymentSuccess && window.history.replaceState) {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }

                setTimeout(function () {
                    localStorage.removeItem('paymentSuccess');
                    localStorage.removeItem('latestOrderId');
                }, 10000);
            }
        }

        function showReviewConfirmation() {
            const reviewSuccess = localStorage.getItem('reviewSuccess');
            const reviewedProduct = localStorage.getItem('reviewedProduct');

            if (reviewSuccess === 'true') {
                const messageContainer = document.getElementById('reviewConfirmationMessage');
                let messageHTML = `
                    <div class="review-success-message">
                        <div class="review-success-content">
                            <div class="review-success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="review-success-text">
                                <h5>Review Submitted Successfully!</h5>
                                <p>Thank you for your review${reviewedProduct ? ` for "${reviewedProduct}"` : ''}.</p>
                            </div>
                            <button class="review-success-close" onclick="closeReviewMessage()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                messageContainer.innerHTML = messageHTML;

                setTimeout(function () {
                    localStorage.removeItem('reviewSuccess');
                    localStorage.removeItem('reviewedProduct');
                    const msgContainer = document.getElementById('reviewConfirmationMessage');
                    if (msgContainer) msgContainer.innerHTML = '';
                }, 10000);
            }
        }

        function closePaymentMessage() {
            const messageContainer = document.getElementById('paymentConfirmationMessage');
            if (messageContainer) messageContainer.innerHTML = '';
            localStorage.removeItem('paymentSuccess');
            localStorage.removeItem('latestOrderId');
        }

        function closeReviewMessage() {
            const messageContainer = document.getElementById('reviewConfirmationMessage');
            if (messageContainer) messageContainer.innerHTML = '';
            localStorage.removeItem('reviewSuccess');
            localStorage.removeItem('reviewedProduct');
        }

        function updateCartCount() {
            const token = localStorage.getItem("token");
            if (token) {
                fetch('/api/user/cart/getAll', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Cart endpoint not found');
                    return response.json();
                })
                .then(data => {
                    if (data && data.items) {
                        const itemCount = data.items.reduce((total, item) => total + (item.quantity || 0), 0);
                        const cartCountElements = document.querySelectorAll('#cart-count');
                        cartCountElements.forEach(el => {
                            el.textContent = `(${itemCount})`;
                        });
                    }
                })
                .catch(error => {
                    console.log('Error fetching cart count:', error);
                    const cartCountElements = document.querySelectorAll('#cart-count');
                    cartCountElements.forEach(el => {
                        el.textContent = '(0)';
                    });
                });
            }
        }

        // ========== FETCH USER REVIEWS ==========
        async function fetchUserReviews() {
            const token = localStorage.getItem("token");
            if (!token) {
                console.log("No token found for fetching reviews");
                return [];
            }
            
            try {
                const response = await fetch("/api/user/reviews/get", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userReviewsCache = data.reviews || [];
                    console.log("Fetched user reviews:", userReviewsCache.length);
                    return userReviewsCache;
                }
            } catch (error) {
                console.error("Error fetching reviews from API:", error);
            }
            
            // Fallback to localStorage
            const localStorageReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            userReviewsCache = localStorageReviews;
            return localStorageReviews;
        }

        // ========== ORDER FUNCTIONS ==========
        async function loadOrders() {
            const token = localStorage.getItem("token");
            const ordersContainer = document.getElementById("ordersContainer");
            const loadingMessage = document.getElementById("loadingMessage");
            const ordersCount = document.getElementById("ordersCount");

            if (!token) {
                notyf.error("Please login to view orders");
                window.location.href = "login.html";
                return;
            }

            showLoading("Loading your orders...");

            try {
                // Fetch orders and reviews in parallel
                const [ordersResponse, userReviews] = await Promise.all([
                    fetch("/api/user/cart/order/getAll", {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    }),
                    fetchUserReviews()
                ]);

                if (ordersResponse.ok) {
                    const data = await ordersResponse.json();
                    hideLoading();
                    
                    if (loadingMessage) loadingMessage.style.display = "none";

                    if (data.orders && data.orders.length > 0) {
                        // Store orders globally for item details modal
                        window.allOrders = data.orders;
                        
                        if (ordersCount) ordersCount.textContent = `${data.orders.length} orders found`;
                        displayOrdersTable(data.orders, userReviews);
                    } else {
                        showEmptyState();
                    }
                } else {
                    throw new Error("Failed to fetch orders");
                }
            } catch (error) {
                hideLoading();
                if (loadingMessage) loadingMessage.style.display = "none";
                if (ordersCount) ordersCount.textContent = "Error loading orders";
                console.error("Order Load Error:", error);
                notyf.error("Failed to load orders. Please try again.");
            }
        }

        function displayOrdersTable(orders, userReviews = []) {
            const ordersContainer = document.getElementById("ordersContainer");
            
            // Also check localStorage as fallback
            const submittedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            
            // Combine both sources of reviews
            const allUserReviews = [...userReviews, ...submittedReviews];
            console.log("All user reviews for display:", allUserReviews.length);

            let tableHTML = `
                <div class="orders-table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Items</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Product Reviews</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>`;

            orders.forEach(order => {
                const isDelivered = order.status && order.status.toLowerCase() === 'delivered';
                const orderId = order._id;
                const orderNumber = order.orderNumber || order.orderId;
                const items = order.items || [];
                const orderDate = new Date(order.orderDate || order.createdAt).toLocaleDateString('en-IN');
                
                if (items.length === 0) return;

                // Generate HTML for multiple items
                let itemsHTML = '';
                let reviewSectionHTML = '<div class="product-review-column">';
                
                // FOR ITEMS COLUMN - Show multiple product images
                if (items.length === 1) {
                    // Single item - show larger image
                    const item = items[0];
                    const productName = item.name || item.product?.name || 'Product';
                    const productImage = item.image || item.product?.image || 'img/product-placeholder.png';
                    
                    itemsHTML += `
                        <div class="order-items-preview">
                            <img src="${productImage}" class="item-image" onerror="this.src='img/product-placeholder.png'">
                            <div class="item-details">
                                <div class="item-name">${productName}</div>
                            </div>
                        </div>`;
                } else {
                    // Multiple items - show image grid
                    itemsHTML += `
                        <div class="order-items-preview">
                            <div class="item-images-grid">
                    `;
                    
                    // Show up to 4 images
                    const itemsToShow = Math.min(items.length, 4);
                    for (let i = 0; i < itemsToShow; i++) {
                        const item = items[i];
                        const productImage = item.image || item.product?.image || 'img/product-placeholder.png';
                        
                        itemsHTML += `
                            <img src="${productImage}" 
                                 class="item-image-small" 
                                 onerror="this.src='img/product-placeholder.png'"
                                 title="${item.name || item.product?.name || 'Product'}">
                        `;
                    }
                    
                    itemsHTML += `
                            </div>
                            <div class="item-details" style="margin-top: 10px;">
                                <div class="item-name">${items.length} items</div>
                                <div class="more-items" onclick="showAllItems('${orderId}')">View all items</div>
                            </div>
                        </div>`;
                }
                
                // FOR REVIEW COLUMN - Separate review button for each product in multiple rows
                items.forEach((item, index) => {
                    const productId = item.productId || item.product?._id || null;
                    const productName = item.name || item.product?.name || 'Product';
                    const productImage = item.image || item.product?.image || 'img/product-placeholder.png';
                    const itemSize = item.size || 'N/A';
                    const quantity = item.quantity || 1;
                    
                    // Check if this specific product in this order has been reviewed
                    const hasReviewed = allUserReviews.some(r => {
                        // Match by productId AND orderId AND size (if size matters)
                        const productMatch = r.productId === productId || 
                                           (r.product && r.product._id === productId);
                        
                        const orderMatch = r.orderId === orderId || 
                                          (orderNumber && r.orderId === orderNumber);
                        
                        // If size is specified, check if it matches (optional)
                        const sizeMatch = !itemSize || itemSize === 'N/A' || !r.size || r.size === itemSize;
                        
                        return productMatch && orderMatch && sizeMatch;
                    });
                    
                    console.log(`Product ${productName} in order ${orderId} review status:`, hasReviewed);
                    
                    reviewSectionHTML += `
                        <div class="product-review-item">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="position: relative; width: 40px; height: 40px; flex-shrink: 0;">
                                    <img src="${productImage}" 
                                         style="width: 100%; height: 100%; border-radius: 4px; object-fit: cover; border: 1px solid #eaeaea;"
                                         onerror="this.src='img/product-placeholder.png'"
                                         alt="${productName}">
                                    <div class="quantity-badge">${quantity}</div>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 12px; font-weight: 500; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${productName}
                                    </div>
                                    ${itemSize && itemSize !== 'N/A' ? `
                                        <div style="font-size: 10px; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 10px; display: inline-block;">
                                            Size: ${itemSize}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${isDelivered ? 
                                    (hasReviewed ? 
                                        `<div class="review-completed-status">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Review Completed</span>
                                        </div>` :
                                        `<button class="add-review-btn" 
                                                onclick="openReviewModal('${productId}', '${orderId}', '${encodeURIComponent(productName)}', '${encodeURIComponent(itemSize)}')">
                                            <i class="fas fa-star"></i> Write Review
                                        </button>`
                                    ) :
                                    `<div class="review-pending-status">
                                        <i class="fas fa-clock"></i>
                                        <span>Review after delivery</span>
                                    </div>`
                                }
                            </div>
                        </div>`;
                });

                reviewSectionHTML += '</div>';

                tableHTML += `
                    <tr>
                        <td class="order-id-cell">
                            ${orderNumber || 'ORD-' + (orderId ? orderId.toString().slice(-6) : '')}
                            <span class="small-text">${orderDate}</span>
                        </td>
                        <td class="order-items-cell">
                            ${itemsHTML}
                        </td>
                        <td><div class="order-amount">${order.summary?.total || order.total || '0.00'}</div></td>
                        <td><span class="order-status-badge ${getStatusClass(order.status)}">${order.status || 'Pending'}</span></td>
                        <td style="width: 350px;">
                            <div class="review-info">
                                ${reviewSectionHTML}
                            </div>
                        </td>
                        <td>
                            <div class="order-actions">
                                <button class="action-btn invoice" onclick="downloadInvoice('${orderId}')" title="Download Invoice">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });

            tableHTML += `</tbody></table></div>`;
            ordersContainer.innerHTML = tableHTML;
        }

        function getStatusClass(status) {
            if (!status) return 'status-created';
            status = status.toLowerCase();
            if (status.includes('deliver')) return 'status-delivered';
            if (status.includes('ship')) return 'status-shipped';
            if (status.includes('cancel')) return 'status-cancelled';
            if (status.includes('confirm')) return 'status-confirmed';
            return 'status-created';
        }

        function showEmptyState() {
            const emptyOrdersMessage = document.getElementById("emptyOrdersMessage");
            const ordersContainer = document.getElementById("ordersContainer");
            
            if (emptyOrdersMessage) {
                emptyOrdersMessage.style.display = "block";
            }
            
            if (ordersContainer) {
                ordersContainer.innerHTML = `
                    <div class="empty-orders">
                        <div class="empty-orders-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <h3>No Orders Yet</h3>
                        <p>You haven't placed any orders yet. Start shopping to see your orders here.</p>
                        <a href="product-list.html" class="btn btn-primary-custom">
                            <i class="fas fa-shopping-bag"></i> Start Shopping
                        </a>
                    </div>
                `;
            }
        }

        // ========== SHOW ALL ITEMS MODAL ==========
        function showAllItems(orderId) {
            // Find the order from window.allOrders
            const order = window.allOrders?.find(o => o._id === orderId);
            if (!order) {
                notyf.error("Order details not found");
                return;
            }
            
            const items = order.items || [];
            
            if (items.length === 0) {
                notyf.error("No items found in this order");
                return;
            }
            
            let itemsHTML = '<div class="order-items-modal">';
            
            items.forEach((item, index) => {
                const productName = item.name || item.product?.name || 'Product';
                const productImage = item.image || item.product?.image || 'img/product-placeholder.png';
                const quantity = item.quantity || 1;
                const price = item.price || item.product?.price || 0;
                const size = item.size || 'N/A';
                const total = quantity * price;
                
                itemsHTML += `
                    <div class="item-detail">
                        <img src="${productImage}" alt="${productName}" class="item-image" onerror="this.src='img/product-placeholder.png'">
                        <div class="item-info">
                            <div class="item-name">${productName}</div>
                            <div class="item-meta">
                                Quantity: ${quantity} | Size: ${size}<br>
                                Price: ${price.toFixed(2)} each | Total: ${total.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            itemsHTML += '</div>';
            
            // Create and show modal
            const modalId = 'itemsModal-' + Date.now();
            const modalHTML = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-boxes mr-2"></i>
                                    Order Items (${items.length})
                                </h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                                ${itemsHTML}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existingModal = document.querySelector('#itemsModal');
            if (existingModal) existingModal.remove();
            
            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modalElement = document.getElementById(modalId);
            
            // Show modal
            $(`#${modalId}`).modal('show');
            
            // Remove modal after hiding
            $(`#${modalId}`).on('hidden.bs.modal', function () {
                $(this).remove();
            });
        }

        // ========== REVIEW MODAL FUNCTIONS ==========
        function openReviewModal(productId, orderId, productName, productSize = '') {
            // Remove existing modal if any
            const existingModal = document.querySelector('#reviewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Decode product name and size
            productName = decodeURIComponent(productName);
            productSize = decodeURIComponent(productSize);

            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="reviewModalLabel">
                                    <i class="fas fa-star mr-2"></i>Write a Review
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <!-- Product Info -->
                                <div class="product-info-review mb-4">
                                    <h6>Product: <span class="text-primary">${productName}</span></h6>
                                    ${productSize && productSize !== 'N/A' ? `<small class="text-muted">Size: ${productSize}</small><br>` : ''}
                                    <small class="text-muted">Order: ${orderId}</small>
                                </div>
                                
                                <!-- Rating Section -->
                                <div class="rating-section mb-4">
                                    <label class="form-label">Rating <span class="text-danger">*</span></label>
                                    <div class="star-rating" id="starRatingContainer">
                                        <span class="star" data-value="1" title="Very Bad">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <span class="star" data-value="2" title="Bad">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <span class="star" data-value="3" title="Average">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <span class="star" data-value="4" title="Good">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <span class="star" data-value="5" title="Excellent">
                                            <i class="fas fa-star"></i>
                                        </span>
                                    </div>
                                    <div class="rating-text mt-2" id="ratingTextModal">Select your rating</div>
                                    <div class="rating-labels mt-2">
                                        <small>Very Bad</small>
                                        <small>Bad</small>
                                        <small>Average</small>
                                        <small>Good</small>
                                        <small>Excellent</small>
                                    </div>
                                    <input type="hidden" id="selectedRating" value="0">
                                </div>
                                
                                <!-- Comment Section -->
                                <div class="form-group">
                                    <label for="reviewCommentModal" class="form-label">Your Review <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="reviewCommentModal" rows="4" 
                                              placeholder="Share your experience with this product..." 
                                              maxlength="500"></textarea>
                                    <div class="char-count" id="charCount">0/500 characters</div>
                                </div>
                                
                                <!-- Error Message -->
                                <div class="review-error" id="reviewError"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitReview('${productId}', '${orderId}', '${encodeURIComponent(productName)}', '${encodeURIComponent(productSize)}')">
                                    <i class="fas fa-paper-plane mr-2"></i> Submit Review
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.getElementById('reviewModalContainer').innerHTML = modalHTML;

            // Initialize star rating after modal is added to DOM
            setTimeout(() => {
                initializeStarRating();
            }, 100);

            // Show modal
            $('#reviewModal').modal('show');
        }

        function initializeStarRating() {
            const stars = document.querySelectorAll('#starRatingContainer .star');
            const ratingText = document.getElementById('ratingTextModal');
            const selectedRatingInput = document.getElementById('selectedRating');
            const reviewComment = document.getElementById('reviewCommentModal');
            const charCount = document.getElementById('charCount');
            
            // Rating descriptions
            const ratingDescriptions = {
                1: "Very Bad - Terrible experience",
                2: "Bad - Below expectations",
                3: "Average - Met basic expectations",
                4: "Good - Happy with purchase",
                5: "Excellent - Exceeded expectations"
            };
            
            // Function to update stars based on rating value
            function updateStars(ratingValue) {
                stars.forEach(star => {
                    const starValue = parseInt(star.getAttribute('data-value'));
                    if (starValue <= ratingValue) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
                
                // Update text and hidden input
                if (ratingText) {
                    ratingText.textContent = ratingDescriptions[ratingValue] || "Select your rating";
                }
                if (selectedRatingInput) {
                    selectedRatingInput.value = ratingValue;
                }
                selectedRating = ratingValue;
            }
            
            // Initialize with no selection
            updateStars(0);
            
            // Add click event to each star
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const ratingValue = parseInt(this.getAttribute('data-value'));
                    updateStars(ratingValue);
                });
                
                // Add hover effect
                star.addEventListener('mouseenter', function() {
                    const ratingValue = parseInt(this.getAttribute('data-value'));
                    stars.forEach(s => {
                        const sValue = parseInt(s.getAttribute('data-value'));
                        if (sValue <= ratingValue) {
                            s.querySelector('i').style.color = '#FFA500';
                        } else {
                            s.querySelector('i').style.color = '#ddd';
                        }
                    });
                });
                
                star.addEventListener('mouseleave', function() {
                    stars.forEach(s => {
                        const sValue = parseInt(s.getAttribute('data-value'));
                        const icon = s.querySelector('i');
                        if (sValue <= selectedRating) {
                            icon.style.color = s.classList.contains('selected') ? '#FFD700' : '#ddd';
                        } else {
                            icon.style.color = '#ddd';
                        }
                    });
                });
            });
            
            // Character count for review comment
            if (reviewComment && charCount) {
                reviewComment.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = `${length}/500 characters`;
                    
                    if (length > 450) {
                        charCount.classList.add('warning');
                        charCount.classList.remove('danger');
                    } else if (length > 480) {
                        charCount.classList.remove('warning');
                        charCount.classList.add('danger');
                    } else {
                        charCount.classList.remove('warning', 'danger');
                    }
                });
            }
        }

        async function submitReview(productId, orderId, productName, productSize = '') {
            // Check if user is logged in
            const token = localStorage.getItem("token");
            if (!token) {
                notyf.error("Session expired. Please login again.");
                window.location.href = "login.html?redirect=order-history.html";
                return;
            }
            
            // Decode product name and size
            productName = decodeURIComponent(productName);
            productSize = decodeURIComponent(productSize);
            
            // Hide any previous error
            const errorDiv = document.getElementById('reviewError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // Get rating
            if (!selectedRating || selectedRating === 0) {
                showReviewError('Please select a rating by clicking on the stars.');
                return;
            }
            
            // Get comment
            const comment = document.getElementById('reviewCommentModal').value.trim();
            if (!comment) {
                showReviewError('Please write a review before submitting.');
                return;
            }
            
            if (comment.length < 10) {
                showReviewError('Please write a more detailed review (at least 10 characters).');
                return;
            }
            
            // Prepare review data
            const reviewData = {
                productId: productId,
                orderId: orderId,
                rating: selectedRating,
                comment: comment,
                size: productSize // Include size
            };
            
            console.log("Submitting review data:", reviewData);
            
            // Show loading state
            const submitBtn = document.querySelector('#reviewModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                // Send to backend API
                const response = await fetch("/api/user/cart/order/reviews/add", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(reviewData)
                });
                
                const data = await response.json();
                console.log("Review submission response:", data);
                
                if (response.ok && data.success) {
                    // Success
                    $('#reviewModal').modal('hide');
                    
                    // Store in localStorage to track reviewed items
                    const submittedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
                    
                    // Remove any existing review for this product+order+size combination
                    const existingIndex = submittedReviews.findIndex(r => 
                        r.productId === productId && 
                        r.orderId === orderId &&
                        r.size === productSize
                    );
                    
                    const newReview = {
                        productId: productId,
                        orderId: orderId,
                        reviewedAt: new Date().toISOString(),
                        productName: productName,
                        size: productSize,
                        rating: selectedRating
                    };
                    
                    if (existingIndex > -1) {
                        submittedReviews[existingIndex] = newReview;
                    } else {
                        submittedReviews.push(newReview);
                    }
                    
                    localStorage.setItem('userReviews', JSON.stringify(submittedReviews));
                    
                    // Update the cache
                    userReviewsCache = submittedReviews;
                    
                    // Immediately update the UI without reloading the whole page
                    updateReviewButtonStatus(productId, orderId, productSize, productName);
                    
                    // Show success message
                    localStorage.setItem('reviewSuccess', 'true');
                    localStorage.setItem('reviewedProduct', productName);
                    
                    // Show success notification
                    notyf.success('Review submitted successfully!');
                    
                    // Refresh the review success message
                    showReviewConfirmation();
                    
                } else {
                    // Error
                    showReviewError(data.message || 'Failed to submit review. Please try again.');
                }
            } catch (error) {
                console.error('Review submission error:', error);
                showReviewError('Network error. Please check your connection and try again.');
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function updateReviewButtonStatus(productId, orderId, productSize, productName) {
            console.log("Updating review button status for:", productId, orderId, productSize);
            
            // Find all review buttons and update the matching one
            document.querySelectorAll('.add-review-btn').forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr) {
                    // Check if this button is for the same product and order
                    const matchesProduct = onclickAttr.includes(productId);
                    const matchesOrder = onclickAttr.includes(orderId);
                    const matchesSize = !productSize || productSize === 'N/A' || onclickAttr.includes(encodeURIComponent(productSize));
                    
                    if (matchesProduct && matchesOrder && matchesSize) {
                        // Find the parent review item
                        const reviewItem = button.closest('.product-review-item');
                        if (reviewItem) {
                            // Find the action div
                            const actionDiv = reviewItem.querySelector('div[style*="text-align: right"]');
                            if (actionDiv) {
                                // Replace with "Review Completed" status
                                actionDiv.innerHTML = `
                                    <div class="review-completed-status">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Review Completed</span>
                                    </div>
                                `;
                                console.log("Updated review button to 'Review Completed'");
                            }
                        }
                    }
                }
            });
            
            // Also update the localStorage cache
            const submittedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            const exists = submittedReviews.some(r => 
                r.productId === productId && 
                r.orderId === orderId &&
                r.size === productSize
            );
            
            if (!exists) {
                submittedReviews.push({
                    productId: productId,
                    orderId: orderId,
                    reviewedAt: new Date().toISOString(),
                    productName: productName,
                    size: productSize,
                    rating: selectedRating
                });
                localStorage.setItem('userReviews', JSON.stringify(submittedReviews));
            }
        }

        function showReviewError(message) {
            const errorDiv = document.getElementById('reviewError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Scroll to error
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                notyf.error(message);
            }
        }

        // ========== OTHER ORDER FUNCTIONS ==========
        async function viewOrderDetails(orderId) {
            showLoading("Loading order details...");
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/api/user/cart/order/${orderId}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (response.ok) {
                    const orderDetails = await response.json();
                    hideLoading();
                    alert(`Order Details:\n\nOrder ID: ${orderDetails._id}\nStatus: ${orderDetails.status}\nTotal: ${orderDetails.total || '0.00'}\n\nFull details feature coming soon!`);
                } else {
                    hideLoading();
                    notyf.error("Failed to load order details");
                }
            } catch (error) {
                hideLoading();
                console.error("Error fetching order details:", error);
                notyf.error("Error loading order details");
            }
        }

        async function downloadInvoice(orderId) {
            if (!orderId) {
                notyf.error('Invalid order ID');
                return;
            }
            
            showLoading("Generating invoice...");
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/api/user/cart/order/${orderId}/invoice`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `invoice-${orderId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    hideLoading();
                    notyf.success('Invoice downloaded successfully!');
                } else {
                    hideLoading();
                    notyf.error('Invoice not available for this order');
                }
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                notyf.error('Failed to download invoice');
            }
        }
    </script>
</body>
</html>