<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ShopStyle - My Account</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Modern eCommerce HTML Template" name="keywords" />
    <meta content="Contemporary eCommerce Template" name="description" />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- CSS Libraries -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet" />
    <link href="lib/slick/slick.css" rel="stylesheet" />
    <link href="lib/slick/slick-theme.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
    <style>
      /* Modern Account Styling */
      .my-account-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        padding: 30px;
        margin-bottom: 30px;
      }
      
      .account-details-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .form-section {
        margin-bottom: 25px;
      }
      
      .readonly-field {
        background-color: #e9ecef !important;
        cursor: not-allowed;
      }
      
      /* User Welcome Bar */
      .user-welcome-bar {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: rgb(132, 51, 51);
        padding: 15px 0;
        margin-bottom: 30px;
        border-radius: 10px;
      }
      
      /* Navigation Menu */
      .nav-pills .nav-link {
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 10px;
        color: #333;
        border: 1px solid #eaeaea;
        transition: all 0.3s;
      }
      
      .nav-pills .nav-link:hover {
        background-color: #f8f9fa;
        border-color: var(--primary);
      }
      
      .nav-pills .nav-link.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      
      .nav-pills .nav-link i {
        width: 20px;
        text-align: center;
        margin-right: 10px;
      }
      
      /* Form Styling */
      .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
      }
      
      .btn-primary {
        background-color: rgb(14, 157, 61);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s;
      }
      
      .btn-primary:hover {
        background: rgb(14, 205, 78);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.3);
      }
      
      .btn-success {
        background: var(--success);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s;
      }
      
      .btn-success:hover {
        background: var(--success-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(var(--success-rgb), 0.3);
      }
      
      /* Alert Messages */
      .alert {
        border-radius: 8px;
        border: none;
        padding: 15px;
      }
      
      .alert-success {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--success);
        border-left: 3px solid var(--success);
      }
      
      .alert-danger {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--danger);
        border-left: 3px solid var(--danger);
      }
      
      /* Responsive Design */
      @media (max-width: 992px) {
        .my-account-container {
          padding: 20px;
        }
        
        .account-details-section {
          padding: 15px;
        }
        
        .user-welcome-bar h4 {
          font-size: 18px;
        }
      }
      
      @media (max-width: 768px) {
        .my-account-container {
          padding: 15px;
        }
        
        .user-welcome-bar {
          padding: 12px 0;
          margin-bottom: 20px;
        }
        
        .user-welcome-bar .row {
          flex-direction: column;
          text-align: center;
        }
        
        .user-welcome-bar .col-md-4 {
          margin-top: 10px;
        }
        
        .nav-pills .nav-link {
          padding: 10px 15px;
          font-size: 14px;
        }
        
        .form-control {
          font-size: 14px;
        }
        
        .btn-primary, .btn-success {
          padding: 8px 20px;
          font-size: 14px;
          width: 100%;
        }
      }
      
      @media (max-width: 576px) {
        .my-account-container {
          padding: 12px;
        }
        
        .account-details-section {
          padding: 12px;
        }
        
        .user-welcome-bar h4 {
          font-size: 16px;
        }
        
        .nav-pills .nav-link {
          padding: 8px 12px;
          font-size: 13px;
        }
        
        .nav-pills .nav-link i {
          font-size: 14px;
          margin-right: 8px;
        }
        
        h4 {
          font-size: 18px;
        }
      }
      
      /* Loading spinner */
      .btn .fa-spinner {
        margin-right: 5px;
      }
    </style>
  </head>

  <body>
    <!-- Top bar Start -->
    <div class="top-bar">
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-6">
            <i class="fa fa-envelope"></i>
            support@shopstyle.com
          </div>
          <div class="col-sm-6 text-sm-right">
            <i class="fa fa-phone-alt"></i>
            +1 (234) 567-8900
          </div>
        </div>
      </div>
    </div>
    <!-- Top bar End -->

    <!-- Navigation Bar Start -->
    <div class="nav">
      <div class="container-fluid">
        <nav class="navbar navbar-expand-lg">
          <a class="navbar-brand" href="index.html">
            <!-- <span class="logo-text">ShopStyle</span> -->
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="product-list.html">Products</a>
              </li>
              <li class="nav-item protected-menu" style="display: none;">
                <a class="nav-link" href="cart.html" id="cartMenuItem">Cart</a>
              </li>
              <li class="nav-item protected-menu" style="display: none;">
                <a class="nav-link" href="checkout.html" id="checkoutMenuItem">Checkout</a>
              </li>
              <li class="nav-item protected-menu" style="display: none;">
                <a class="nav-link" href="order-history.html" id="orderMenuItem">My Orders</a>
              </li>
            </ul>

            <div class="navbar-nav ml-auto align-items-center">
              <div class="nav-item dropdown user-account" id="userAccountDropdown" style="display: none;">
                <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                  <i class="fa fa-user-circle mr-1"></i> Account
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                  <a class="dropdown-item" href="my-account.html">Dashboard</a>
                  <a class="dropdown-item" href="#" id="logoutBtn">Logout</a>
                </div>
              </div>
              <a class="btn btn-sm btn-outline-primary" href="login.html" id="loginBtn" style="display: none;">LOGIN</a>
            </div>
          </div>
        </nav>
      </div>
    </div>
    <!-- Navigation Bar End -->

    <!-- Search Bar Start -->
    <div class="bottom-bar">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-2">
            <div class="logo">
              <a href="index.html" class="font-logo">
                <span class="logo-text">ShopStyle</span>
              </a>
            </div>
          </div>
          <div class="col-md-8">
            <div class="search">
              <input type="text" id="searchInput" placeholder="Search for products, brands, and more...">
              <button id="searchBtn"><i class="fa fa-search"></i></button>
            </div>
          </div>
          <div class="col-md-2">
            <div class="user text-right">
              <a href="wishlist.html" class="btn wishlist">
                <i class="fa fa-heart"></i>
                <span id="wishlist-count">(0)</span>
              </a>
              <a href="cart.html" class="btn cart">
                <i class="fa fa-shopping-cart"></i>
                <span id="cart-count">(0)</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Search Bar End -->

    <!-- Breadcrumb Start -->
    <div class="breadcrumb-wrap">
      <div class="container-fluid">
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item"><a href="product-list.html">Products</a></li>
          <li class="breadcrumb-item active">My Account</li>
        </ul>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- User Welcome Bar -->
    <div class="user-welcome-bar">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h4 style="margin: 0; font-weight: 600">
              <i class="fa fa-user-circle mr-2"></i>
              Welcome back, <span id="userName">Guest User</span>!
            </h4>
            <small style="opacity: 0.9">
              <i class="fa fa-envelope mr-1"></i>
              <span id="userEmail">Please log in to see your email</span>
            </small>
          </div>
          <div class="col-md-4 text-md-right">
            <span class="badge badge-light" style="color: #333">
              <i class="fa fa-shield-alt mr-1"></i>
              Account Active
            </span>
          </div>
        </div>
      </div>
    </div>
    <!-- User WelcomeBar ends -->

    <!-- My Account Start -->
    <div class="my-account">
      <div class="container-fluid">
        <div class="my-account-container">
          <div class="row">
            <div class="col-lg-3 col-md-4">
              <!-- Navigation menu -->
              <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="dashboard-nav" data-toggle="pill" href="#dashboard-tab" role="tab">
                  <i class="fa fa-tachometer-alt"></i>Dashboard
                </a>
                <a class="nav-link" href="order-history.html">
                  <i class="fa fa-shopping-bag"></i>Orders
                </a>
                <!-- <a class="nav-link" id="payment-nav" data-toggle="pill" href="#payment-tab" role="tab">
                  <i class="fa fa-credit-card"></i>Payment Method
                </a> -->
                <a class="nav-link" href="address.html">
                  <i class="fa fa-map-marker-alt"></i>Address
                </a>
                <a class="nav-link" id="account-nav" data-toggle="pill" href="#account-tab" role="tab">
                  <i class="fa fa-user"></i>Account Details
                </a>
                <a class="nav-link" href="#" id="logoutLink">
                  <i class="fa fa-sign-out-alt"></i>Logout
                </a>
              </div>
            </div>
            <div class="col-lg-9 col-md-8">
              <div class="tab-content">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard-tab" role="tabpanel" aria-labelledby="dashboard-nav">
                  <h4>Dashboard</h4>
                  <p>
                    Welcome to your ShopStyle dashboard! Here you can manage your account settings, 
                    view order history, update your profile, and change your password. 
                    Use the menu on the left to navigate between different sections of your account.
                  </p>
                  <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h5 class="card-title"><i class="fa fa-shopping-cart text-primary mr-2"></i>Recent Orders</h5>
                          <p class="card-text">View and track your recent purchases</p>
                          <a href="order-history.html" class="btn btn-sm btn-outline-primary">View Orders</a>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h5 class="card-title"><i class="fa fa-user text-success mr-2"></i>Profile Settings</h5>
                          <p class="card-text">Update your personal information</p>
                          <a href="#account-tab" class="btn btn-sm btn-outline-success" onclick="switchToAccountTab()">Edit Profile</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Payment Method Tab -->
                <div class="tab-pane fade" id="payment-tab" role="tabpanel" aria-labelledby="payment-nav">
                  <h4>Payment Methods</h4>
                  <div class="alert alert-info">
                    <i class="fa fa-info-circle mr-2"></i>
                    Manage your saved payment methods for faster checkout.
                  </div>
                  <p>No saved payment methods yet. Add your first payment method below.</p>
                  <button class="btn btn-primary" onclick="notyf.info('This feature will be available soon!')">
                    <i class="fa fa-plus mr-2"></i>Add Payment Method
                  </button>
                </div>

                <!-- Account Details Tab -->
                <div class="tab-pane fade" id="account-tab" role="tabpanel" aria-labelledby="account-nav">
                  <div class="account-details-section">
                    <h4>Account Details</h4>
                    <form id="accountDetailsForm">
                      <div class="form-section">
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group">
                              <label for="fullName"><strong>Full Name</strong></label>
                              <input class="form-control" type="text" id="fullName" name="name" placeholder="Your Full Name" required />
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="mobileNumber"><strong>Mobile Number</strong></label>
                              <input class="form-control" type="text" id="mobileNumber" name="phone" placeholder="Your Mobile Number" />
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="emailAddress"><strong>Email Address</strong></label>
                              <input class="form-control readonly-field" type="email" id="emailAddress" placeholder="Your Email" readonly />
                              <small class="form-text text-muted">
                                <i class="fa fa-info-circle"></i> Email cannot be changed
                              </small>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                              <i class="fa fa-save mr-2"></i>Update Profile
                            </button>
                            <div id="updateMessage" class="mt-3 alert" style="display: none"></div>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>

                  <!-- <div class="account-details-section">
                    <h4>Password Change</h4>
                    <form id="passwordChangeForm">
                      <div class="form-section">
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group">
                              <label for="currentPassword"><strong>Current Password</strong></label>
                              <input class="form-control" type="password" id="currentPassword" placeholder="Current Password" />
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="newPassword"><strong>New Password</strong></label>
                              <input class="form-control" type="password" id="newPassword" placeholder="New Password" />
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="confirmPassword"><strong>Confirm Password</strong></label>
                              <input class="form-control" type="password" id="confirmPassword" placeholder="Confirm Password" />
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-success">
                              <i class="fa fa-key mr-2"></i>Save Changes
                            </button>
                            <div id="passwordMessage" class="mt-3 alert" style="display: none"></div>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- My Account End -->

    <!-- Footer Start -->
    <div class="footer">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>ShopStyle</h2>
              <div class="contact-info">
                <p><i class="fa fa-map-marker"></i>123 Business Street, New York, NY 10001</p>
                <p><i class="fa fa-envelope"></i>support@shopstyle.com</p>
                <p><i class="fa fa-phone"></i>+1 (234) 567-8900</p>
              </div>
              <div class="social">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
                <a href="#"><i class="fab fa-youtube"></i></a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Quick Links</h2>
              <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="product-list.html">Products</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="contact.html">Contact Us</a></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>Customer Service</h2>
              <ul>
                <li><a href="faq.html">FAQ</a></li>
                <li><a href="shipping.html">Shipping Policy</a></li>
                <li><a href="returns.html">Return Policy</a></li>
                <li><a href="privacy.html">Privacy Policy</a></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="footer-widget">
              <h2>My Account</h2>
              <ul>
                <li><a href="my-account.html">My Account</a></li>
                <li><a href="order-history.html">Order History</a></li>
                <li><a href="wishlist.html">Wishlist</a></li>
                <li><a href="newsletter.html">Newsletter</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="row payment align-items-center">
          <div class="col-md-6">
            <div class="payment-method">
              <h3>We Accept:</h3>
              <img src="img/payment-method.png" alt="Payment Methods">
            </div>
          </div>
          <div class="col-md-6">
            <div class="payment-security">
              <h3>Secured By:</h3>
              <img src="img/godaddy.svg" alt="GoDaddy">
              <img src="img/norton.svg" alt="Norton">
              <img src="img/ssl.svg" alt="SSL">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <p>&copy; 2024 ShopStyle. All rights reserved.</p>
          </div>
          <div class="col-md-6 text-right">
            <p>Designed with <i class="fa fa-heart text-danger"></i> for modern eCommerce</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/slick/slick.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <!-- Template Javascript -->
    <script>
      // ========== NOTYF NOTIFICATION SETUP ==========
      const notyf = new Notyf({
        duration: 3000,
        position: {
          x: 'right',
          y: 'top',
        },
        types: [
          {
            type: 'success',
            background: '#10b981',
            icon: {
              className: 'fas fa-check-circle',
              tagName: 'i',
              color: '#fff'
            }
          },
          {
            type: 'error',
            background: '#ef4444',
            icon: {
              className: 'fas fa-exclamation-circle',
              tagName: 'i',
              color: '#fff'
            }
          },
          {
            type: 'warning',
            background: '#f59e0b',
            icon: {
              className: 'fas fa-exclamation-triangle',
              tagName: 'i',
              color: '#fff'
            }
          },
          {
            type: 'info',
            background: '#3b82f6',
            icon: {
              className: 'fas fa-info-circle',
              tagName: 'i',
              color: '#fff'
            }
          }
        ]
      });

      // Helper function to switch tabs
      function switchToAccountTab() {
        const accountNav = document.getElementById('account-nav');
        const dashboardNav = document.getElementById('dashboard-nav');
        
        if (dashboardNav) dashboardNav.classList.remove('active');
        if (accountNav) accountNav.classList.add('active');
        
        const dashboardTab = document.getElementById('dashboard-tab');
        const accountTab = document.getElementById('account-tab');
        
        if (dashboardTab) dashboardTab.classList.remove('show', 'active');
        if (accountTab) accountTab.classList.add('show', 'active');
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // ============ SEARCH INTEGRATION ============
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        if (searchInput && searchBtn) {
          searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              handleSearch();
            }
          });

          searchBtn.addEventListener('click', function (e) {
            e.preventDefault();
            handleSearch();
          });
        }

        function handleSearch() {
          const query = searchInput.value.trim();

          if (!query) {
            notyf.error('Please enter something to search');
            return;
          }
          window.location.href = `product-list.html?search=${encodeURIComponent(query)}`;
        }

        // ========== AUTHENTICATION HANDLING ==========
        const token = localStorage.getItem("token");
        const isLoggedIn = token !== null && token !== undefined && token !== "";

        const userAccount = document.getElementById("userAccountDropdown");
        const loginBtn = document.getElementById("loginBtn");
        const protectedMenus = document.querySelectorAll('.protected-menu');

        if (isLoggedIn) {
          if (userAccount) userAccount.style.display = "block";
          if (loginBtn) loginBtn.style.display = "none";
          protectedMenus.forEach(menu => {
            if (menu) menu.style.display = "block";
          });
          loadUserProfile();
        } else {
          if (userAccount) userAccount.style.display = "none";
          if (loginBtn) loginBtn.style.display = "inline-block";
          protectedMenus.forEach(menu => {
            if (menu) menu.style.display = "none";
          });
          notyf.error("Please log in to access your account.");
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1500);
          return;
        }

        // ========== LOGOUT FUNCTIONALITY ==========
        const logoutBtn = document.getElementById("logoutBtn");
        const logoutLink = document.getElementById("logoutLink");
        
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            logoutUser();
          });
        }
        
        if (logoutLink) {
          logoutLink.addEventListener("click", function (e) {
            e.preventDefault();
            logoutUser();
          });
        }

        function logoutUser() {
          localStorage.removeItem("token");
          localStorage.removeItem("userId");
          localStorage.removeItem("userName");
          localStorage.removeItem("userEmail");
          notyf.success('Logged out successfully');
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        }

        // ========== LOAD USER PROFILE ==========
        async function loadUserProfile() {
          const token = localStorage.getItem("token");
          console.log("üîê Token from localStorage:", token);

          if (!token) {
            notyf.error("Please log in first.");
            window.location.href = "login.html";
            return;
          }

          try {
            console.log("üöÄ Starting to fetch user profile...");

            // Call your actual backend API
            const response = await fetch("/api/user/profile", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            });

            console.log("üì° HTTP Status:", response.status);
            console.log("üì° Response OK?", response.ok);

            if (response.ok) {
              const userData = await response.json();
              console.log("‚úÖ REAL API Data received:", userData);

              // ‚úÖ CORRECT: Based on your GET controller structure
              const userName = userData.user?.name || "User";
              const userEmail = userData.user?.email || "No email";
              const userPhone = userData.user?.phone || "";

              console.log(
                "Extracted data - Name:",
                userName,
                "Email:",
                userEmail,
                "Phone:",
                userPhone
              );

              // Update the page with REAL user data
              document.getElementById("userName").textContent = userName;
              document.getElementById("userEmail").textContent = userEmail;
              document.getElementById("fullName").value = userName;
              document.getElementById("mobileNumber").value = userPhone;
              document.getElementById("emailAddress").value = userEmail;

              console.log("üéâ Page updated with real user data!");
            } else if (response.status === 401) {
              // Handle 401 Unauthorized
              console.error("üîë 401 Unauthorized - Token is invalid or expired");

              // Clear the invalid token and redirect to login
              localStorage.removeItem("token");
              notyf.error("Your session has expired. Please log in again.");
              window.location.href = "login.html";
              return;
            } else {
              // Handle other HTTP errors
              console.error("‚ùå API returned error status:", response.status);
              notyf.error("Failed to load profile. Please try again.");
            }
          } catch (error) {
            console.error("üí• Network error:", error);
            notyf.error("Network error. Please check your connection.");
          }
        }

        // ========== PROFILE UPDATE FORM ==========
        document.getElementById("accountDetailsForm").addEventListener("submit", async function (e) {
          e.preventDefault();

          const token = localStorage.getItem("token");
          if (!token) {
            notyf.error("Please log in again.");
            window.location.href = "login.html";
            return;
          }

          const updateBtn = document.getElementById("updateProfileBtn");
          const messageDiv = document.getElementById("updateMessage");

          updateBtn.disabled = true;
          updateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Updating...';

          try {
            const formData = {
              name: document.getElementById("fullName").value.trim(),
              phone: document.getElementById("mobileNumber").value.trim(),
            };

            // Validate form data
            if (!formData.name) {
              throw new Error("Name is required");
            }

            console.log("üîÑ Updating profile with:", formData);

            const updateResponse = await fetch("/api/user/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formData),
            });

            console.log("üì° Update response status:", updateResponse.status);

            if (updateResponse.ok) {
              const updatedData = await updateResponse.json();
              console.log("‚úÖ Profile updated successfully:", updatedData);

              messageDiv.style.display = "block";
              messageDiv.className = "mt-3 alert alert-success";
              messageDiv.textContent = "Profile updated successfully!";

              // Update welcome bar with new name
              document.getElementById("userName").textContent = formData.name;
              
              // Show success notification
              notyf.success("Profile updated successfully!");
            } else {
              if (updateResponse.status === 401) {
                throw new Error("Session expired. Please log in again.");
              }
              const errorData = await updateResponse.json();
              throw new Error(errorData.message || "Failed to update profile");
            }
          } catch (error) {
            console.error("‚ùå Update error:", error);
            messageDiv.style.display = "block";
            messageDiv.className = "mt-3 alert alert-danger";
            messageDiv.textContent = "Error: " + error.message;
            
            // Show error notification
            notyf.error("Failed to update profile: " + error.message);

            if (error.message.includes("Session expired")) {
              localStorage.removeItem("token");
              setTimeout(() => {
                window.location.href = "login.html";
              }, 2000);
            }
          } finally {
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fa fa-save mr-2"></i>Update Profile';

            setTimeout(() => {
              messageDiv.style.display = "none";
            }, 5000);
          }
        });

        // ========== PASSWORD CHANGE FORM ==========
        document.getElementById("passwordChangeForm").addEventListener("submit", async function (e) {
          e.preventDefault();

          const token = localStorage.getItem("token");
          if (!token) {
            notyf.error("Please log in again.");
            window.location.href = "login.html";
            return;
          }

          const saveBtn = this.querySelector('button[type="submit"]');
          const messageDiv = document.getElementById("passwordMessage");
          const currentPassword = document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword = document.getElementById("confirmPassword").value;

          // Validation
          if (!currentPassword || !newPassword || !confirmPassword) {
            messageDiv.style.display = "block";
            messageDiv.className = "mt-3 alert alert-danger";
            messageDiv.textContent = "All fields are required!";
            notyf.error("All password fields are required!");
            return;
          }

          if (newPassword !== confirmPassword) {
            messageDiv.style.display = "block";
            messageDiv.className = "mt-3 alert alert-danger";
            messageDiv.textContent = "Passwords do not match!";
            notyf.error("Passwords do not match!");
            return;
          }

          if (newPassword.length < 6) {
            messageDiv.style.display = "block";
            messageDiv.className = "mt-3 alert alert-danger";
            messageDiv.textContent = "Password must be at least 6 characters!";
            notyf.error("Password must be at least 6 characters!");
            return;
          }

          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Saving...';

          try {
            const passwordData = {
              currentPassword: currentPassword,
              newPassword: newPassword,
            };

            // Call your password update API
            const passwordResponse = await fetch("/api/user/change-password", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(passwordData),
            });

            if (passwordResponse.ok) {
              messageDiv.style.display = "block";
              messageDiv.className = "mt-3 alert alert-success";
              messageDiv.textContent = "Password changed successfully!";
              notyf.success("Password changed successfully!");

              // Clear password fields
              document.getElementById("currentPassword").value = "";
              document.getElementById("newPassword").value = "";
              document.getElementById("confirmPassword").value = "";
            } else {
              const errorData = await passwordResponse.json();
              throw new Error(errorData.message || "Failed to change password");
            }
          } catch (error) {
            console.error("Update error:", error);

            // Handle HTML error responses
            if (error.message.includes("Unexpected token")) {
              messageDiv.style.display = "block";
              messageDiv.className = "mt-3 alert alert-danger";
              messageDiv.textContent = "Server error occurred. Please try again later.";
              notyf.error("Server error occurred. Please try again later.");
            } else {
              messageDiv.style.display = "block";
              messageDiv.className = "mt-3 alert alert-danger";
              messageDiv.textContent = "Error: " + error.message;
              notyf.error("Failed to change password: " + error.message);
            }

            if (error.message.includes("Session expired")) {
              localStorage.removeItem("token");
              setTimeout(() => {
                window.location.href = "login.html";
              }, 2000);
            }
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fa fa-key mr-2"></i>Save Changes';

            setTimeout(() => {
              messageDiv.style.display = "none";
            }, 5000);
          }
        });
      });
    </script>
  </body>
</html>