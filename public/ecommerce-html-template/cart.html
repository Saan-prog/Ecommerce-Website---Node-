<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>E Store - eCommerce HTML Template</title>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="eCommerce HTML Template Free Download" name="keywords">
        <meta content="eCommerce HTML Template Free Download" name="description">

        <!-- Favicon -->
        <link href="img/favicon.ico" rel="icon">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Source+Code+Pro:700,900&display=swap" rel="stylesheet">

        <!-- CSS Libraries -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
        <link href="lib/slick/slick.css" rel="stylesheet">
        <link href="lib/slick/slick-theme.css" rel="stylesheet">

        <!-- Template Stylesheet -->
        <link href="css/style.css" rel="stylesheet">
        <style>
            /* Checkbox styles for cart - positioned with product info */
            .product-checkbox-container {
                position: absolute;
                left: 0;
                top: 0;
                z-index: 10;
                padding: 5px;
            }

            .product-checkbox {
                width: 18px !important;
                height: 18px !important;
                cursor: pointer !important;
                margin: 0 !important;
                position: relative !important;
                z-index: 11 !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                border: 2px solid #666 !important;
                border-radius: 3px !important;
                background-color: white !important;
            }

            .product-checkbox:checked {
                background-color: #ff6a00 !important;
                border-color: #ff6a00 !important;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: center !important;
                background-size: 12px 12px !important;
            }

            .product-checkbox:focus {
                border-color: #ff6a00 !important;
                box-shadow: 0 0 0 0.2rem rgba(255, 106, 0, 0.25) !important;
                outline: none !important;
            }

            /* Make the product container relative for positioning */
            .img.d-flex.align-items-start {
                position: relative !important;
                padding-left: 25px !important;
            }

            /* Adjust product image container */
            .img.d-flex.align-items-start a {
                position: relative;
                z-index: 1;
            }

            /* Remove any checkbox column styling */
            .table td:first-child,
            .table th:first-child {
                width: auto !important;
                min-width: auto !important;
                max-width: auto !important;
                padding-left: 15px !important;
                padding-right: 15px !important;
            }
        </style>
    </head>

    <body>
        <!-- Top bar Start -->
        <div class="top-bar">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-6">
                        <i class="fa fa-envelope"></i>
                        support@email.com
                    </div>
                    <div class="col-sm-6">
                        <i class="fa fa-phone-alt"></i>
                        +012-345-6789
                    </div>
                </div>
            </div>
        </div>
        <!-- Top bar End -->
        
        <!-- Nav Bar Start -->
        <div class="nav">
            <div class="container-fluid">
                <nav class="navbar navbar-expand-md bg-dark navbar-dark">
                    <a href="#" class="navbar-brand">MENU</a>
                    <button
                        type="button"
                        class="navbar-toggler"
                        data-toggle="collapse"
                        data-target="#navbarCollapse"
                    >
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div
                        class="collapse navbar-collapse justify-content-between"
                        id="navbarCollapse"
                    >
                        <div class="navbar-nav mr-auto">
                            <a href="index.html" class="nav-item nav-link">Home</a>
                            <a href="product-list.html" class="nav-item nav-link active">Products</a>
                            <a href="product-detail.html" class="nav-item nav-link" style="display: none;">Product Detail</a>
                            <a href="cart.html" class="nav-item nav-link">Cart</a>
                            <a href="checkout.html" class="nav-item nav-link">Checkout</a>
                            <a href="order-history.html" class="nav-item nav-link protected-menu" id="checkoutMenuItem">My Orders</a>
                            <a href="my-account.html" class="nav-item nav-link" style="display: none;">My Account</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" style="display: none;">More Pages</a>
                                <div class="dropdown-menu">
                                    <a href="wishlist.html" class="dropdown-item">Wishlist</a>
                                    <a href="login.html" class="dropdown-item">Login & Register</a>
                                    <a href="contact.html" class="dropdown-item">Contact Us</a>
                                </div>
                            </div>
                        </div>
                        <div class="navbar-nav ml-auto align-items-center">
                            <!-- User Account dropdown (only visible after login) -->
                            <div class="nav-item dropdown user-account" id="userAccountDropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-user-circle"></i> My Account
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="my-account.html" class="dropdown-item">Dashboard</a>
                                    <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                                </div>
                            </div>

                            <!-- Login dropdown (only visible before login) -->
                            <div class="nav-item dropdown" id="loginDropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Login</a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="login.html" class="dropdown-item">Login</a>
                                    <a href="login.html" class="dropdown-item">Register</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Nav Bar End -->
             
        
        <!-- Bottom Bar Start -->
        <div class="bottom-bar">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="logo">
                            <a href="index.html">
                                <img src="img/logo.png" alt="Logo">
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="search">
                            <input type="text" placeholder="Search">
                            <button><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="user">
                            <a href="wishlist.html" class="btn wishlist">
                                <i class="fa fa-heart"></i>
                                <span>(0)</span>
                            </a>
                            <a href="cart.html" class="btn cart">
                                <i class="fa fa-shopping-cart"></i>
                                <span>(0)</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bottom Bar End -->
        
        <!-- Breadcrumb Start -->
        <div class="breadcrumb-wrap">
            <div class="container-fluid">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item"><a href="#">Products</a></li>
                    <li class="breadcrumb-item active">Cart</li>
                </ul>
            </div>
        </div>
        <!-- Breadcrumb End -->
        
        <!-- Cart Start -->
        <div class="cart-page">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="cart-page-inner">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                            <th>Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody class="align-middle" id="cartItems">
                                        <!-- Dynamic cart items will be inserted here -->
                                        <tr id="emptyCartMessage" style="display: none;">
                                            <td colspan="5" class="text-center">
                                                <h3>Your cart is empty</h3>
                                                <a href="product-list.html" class="btn">Continue Shopping</a>
                                            </td>
                                        </tr>
                                        <tr id="loginMessage" style="display: none;">
                                            <td colspan="5" class="text-center">
                                                <h3>Please log in to view your cart</h3>
                                                <a href="login.html" class="btn">Login</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="cart-page-inner">
                            <div class="row">
                                <div class="col-md-12">
                                    <!-- <div class="coupon">
                                        <input type="text" placeholder="Coupon Code">
                                        <button>Apply Code</button>
                                    </div> -->
                                </div>
                                <div class="col-md-12">
                                    <div class="cart-summary">
                                        <div class="cart-content">
                                            <h1>Cart Summary</h1>
                                            <p>Items<span id="itemCount">0</span></p>
                                            <p>Sub Total<span id="subTotal">$0</span></p>
                                            <p>Shipping Cost<span>₹5</span></p>
                                            <h2>Grand Total<span id="grandTotal">$1</span></h2>
                                        </div>
                                        <div class="cart-btn">
                                            <button onclick="clearCart()">Clear Cart</button>
                                            <button onclick="checkout()">Checkout</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Cart End -->
        
        <!-- Footer Start -->
        <div class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h2>Get in Touch</h2>
                            <div class="contact-info">
                                <p><i class="fa fa-map-marker"></i>123 E Store, Los Angeles, USA</p>
                                <p><i class="fa fa-envelope"></i>email@example.com</p>
                                <p><i class="fa fa-phone"></i>+123-456-7890</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h2>Follow Us</h2>
                            <div class="contact-info">
                                <div class="social">
                                    <a href=""><i class="fab fa-twitter"></i></a>
                                    <a href=""><i class="fab fa-facebook-f"></i></a>
                                    <a href=""><i class="fab fa-linkedin-in"></i></a>
                                    <a href=""><i class="fab fa-instagram"></i></a>
                                    <a href=""><i class="fab fa-youtube"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h2>Company Info</h2>
                            <ul>
                                <li><a href="#">About Us</a></li>
                                <li><a href="#">Privacy Policy</a></li>
                                <li><a href="#">Terms & Condition</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h2>Purchase Info</h2>
                            <ul>
                                <li><a href="#">Pyament Policy</a></li>
                                <li><a href="#">Shipping Policy</a></li>
                                <li><a href="#">Return Policy</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="row payment align-items-center">
                    <div class="col-md-6">
                        <div class="payment-method">
                            <h2>We Accept:</h2>
                            <img src="img/payment-method.png" alt="Payment Method" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="payment-security">
                            <h2>Secured By:</h2>
                            <img src="img/godaddy.svg" alt="Payment Security" />
                            <img src="img/norton.svg" alt="Payment Security" />
                            <img src="img/ssl.svg" alt="Payment Security" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->
        
        <!-- Footer Bottom Start -->
        <div class="footer-bottom">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 copyright">
                        <p>Copyright &copy; <a href="#">Your Site Name</a>. All Rights Reserved</p>
                    </div>

                    <div class="col-md-6 template-by">				
                        <p>Designed By <a href="https://htmlcodex.com">HTML Codex</a></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer Bottom End -->       
        
        <!-- Back to Top -->
        <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <!-- JavaScript Libraries -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
        <script src="lib/easing/easing.min.js"></script>
        <script src="lib/slick/slick.min.js"></script>
        
        <!-- Template Javascript -->
        <script src="js/main.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Debug function to check localStorage
        function debugLocalStorage() {
            console.log('=== LOCALSTORAGE DEBUG ===');
            console.log('cart:', localStorage.getItem('cartId'));
            console.log('cartCount:', localStorage.getItem('cartCount'));
            console.log('token:', localStorage.getItem('token'));
            console.log('==========================');
        }

        debugLocalStorage();

        const token = localStorage.getItem("token");
        const cartItemsContainer = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const loginMessage = document.getElementById('loginMessage');
        const subTotalElement = document.getElementById('subTotal');
        const grandTotalElement = document.getElementById('grandTotal');

        const loginDropdown = document.getElementById("loginDropdown");
        const userAccountDropdown = document.getElementById("userAccountDropdown");

        // Authentication handling
        if (token) {
            loginDropdown.style.display = "none";
            userAccountDropdown.style.display = "block";
            fetchCartFromBackend();
        } else {
            loginDropdown.style.display = "block";
            userAccountDropdown.style.display = "none";
            fetchCartFromLocalStorage();
        }

        // Logout functionality
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", function () {
                localStorage.removeItem("token");
                localStorage.removeItem("cart");
                localStorage.removeItem("cartCount");
                localStorage.removeItem('selectedCheckoutItems');
                localStorage.removeItem('cartId');
                window.location.reload();
            });
        }

        // ========== FIXED FETCH CART FROM BACKEND ==========
     // ========== FIXED FETCH CART FROM BACKEND ==========
async function fetchCartFromBackend() {
    try {
        console.log('Fetching cart from backend with token:', token);
        
        const response = await fetch('/api/user/cart/getAll', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Backend cart data:', data);

        // Handle different response structures
        let cartData;
        let cartId = null;
        
        if (data.cart) {
            cartData = data.cart;
            cartId = data.cart._id; // Get cart ID
        } else if (data.data && data.data._id) {
            cartData = data.data;
            cartId = data.data._id; // Get cart ID
        } else if (data.success && data.data) {
            cartData = {
                items: data.data.items || [],
                total: calculateCartTotal(data.data.items || []),
                totalItems: calculateTotalItems(data.data.items || [])
            };
            cartId = data.data._id; // Get cart ID
        } else if (data.success && data.cartItems) {
            cartData = {
                items: data.cartItems || data.items || [],
                total: data.total || calculateCartTotal(data.cartItems || data.items || []),
                totalItems: data.totalItems || calculateTotalItems(data.cartItems || data.items || [])
            };
            cartId = data._id || data.cartId; // Try to get cart ID
        } else {
            console.error('Unknown cart structure:', data);
            throw new Error('Unknown cart structure');
        }

        console.log('Processed cart data for display:', cartData);
        console.log('Cart ID found:', cartId);
        
        // Store cart ID in localStorage
        if (cartId) {
            localStorage.setItem('cartId', cartId);
            console.log('Cart ID stored in localStorage:', cartId);
        } else {
            console.warn('No cart ID found in response');
        }
        
        displayCart(cartData);
        
        localStorage.setItem('cartCount', cartData.totalItems.toString());
        updateCartCountDisplay();

    } catch (error) {
        console.error('Error fetching cart from backend:', error);
        console.log('Falling back to localStorage cart');
        fetchCartFromLocalStorage();
    }
}
        function calculateCartTotal(items) {
            return items.reduce((sum, item) => {
                const price = parseFloat(item.product?.price) || parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                return sum + (price * quantity);
            }, 0);
        }

        function calculateTotalItems(items) {
            return items.reduce((sum, item) => sum + (parseInt(item.quantity) || 1), 0);
        }

        // ========== FETCH CART FROM LOCALSTORAGE ==========
        function fetchCartFromLocalStorage() {
            try {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                console.log('LocalStorage cart:', cart);
                
                if (cart.length === 0) {
                    showEmptyCart();
                } else {
                    const totalItems = calculateTotalItems(cart);
                    const cartData = {
                        items: cart,
                        total: calculateCartTotal(cart),
                        totalItems: totalItems
                    };
                    console.log('Processed cart data:', cartData);
                    updateItemCountDisplay(totalItems);
                    displayCart(cartData);
                }
                
                updateCartCountDisplay();
            } catch (error) {
                console.error('Error parsing cart from localStorage:', error);
                showEmptyCart();
            }
        }

        function getProductImageUrl(imageArray) {
            const defaultImage = 'img/product-1.jpg';
            
            if (!imageArray || !Array.isArray(imageArray) || imageArray.length === 0) {
                return defaultImage;
            }
            
            const firstImage = imageArray[0];
            
            if (!firstImage || typeof firstImage !== 'string') {
                return defaultImage;
            }
            
            if (firstImage.startsWith('http') || firstImage.startsWith('//')) {
                return firstImage;
            }
            
            if (firstImage.startsWith('/uploads/')) {
                return firstImage;
            }
            
            let cleanImage = firstImage.trim();
            
            // if (cleanImage.startsWith('uploads/uploads/')) {
            //     cleanImage = cleanImage.replace('uploads/uploads/', 'uploads/');
            // }
            
            if (!cleanImage.startsWith('/') && !cleanImage.startsWith('uploads/')) {
                cleanImage = 'uploads/' + cleanImage;
            } else if (cleanImage.startsWith('uploads/') && !cleanImage.startsWith('/uploads/')) {
                cleanImage = '/' + cleanImage;
            }
            
            console.log('Image URL processed:', cleanImage);
            return cleanImage;
        }

        // ========== FIXED DISPLAY CART ==========
    function displayCart(cart) {
    console.log('Displaying cart data:', cart);
    
    if (!cart || !cart.items || cart.items.length === 0) {
        showEmptyCart();
        return;
    }

    if (emptyCartMessage) emptyCartMessage.style.display = 'none';
    if (loginMessage) loginMessage.style.display = 'none';

    cartItemsContainer.innerHTML = cart.items.map(item => {
        console.log('Cart item details:', item);
        
        const product = item.product || item || {};
        const productId = product._id || item._id || 'unknown';
        const itemId = item._id || productId;
        const productName = product.name || product.productName || 'Product Name';
        const productPrice = parseFloat(product.price) || parseFloat(item.price) || 0;
        const productImage = getProductImageUrl(product.image || product.images || item.image);
        const quantity = parseInt(item.quantity) || 1;
        const size = item.size || product.size || 'N/A';

        return `
            <tr>
                <td>
                    <div class="img d-flex align-items-start">
                        <div class="product-checkbox-container">
                            <input type="checkbox" 
                                   class="product-checkbox" 
                                   data-product-id="${productId}"
                                   data-item-id="${itemId}"
                                   data-size="${size}"
                                   data-price="${productPrice}"
                                   data-quantity="${quantity}"
                                   data-name="${productName}"
                                   onchange="updateSelectedItems()"
                                   checked>
                        </div>
                        <a href="product-detail.html?id=${productId}" class="mr-3">
                            <img src="${productImage}" 
                                 alt="${productName}"
                                 style="width: 120px; height: 120px; object-fit: cover;"
                                 onerror="this.onerror=null; this.src='img/product-1.jpg'">
                        </a>
                        <div class="product-info">
                            <p class="mb-1"><strong>${productName}</strong></p>
                            <small class="text-muted">Size: ${size}</small>
                        </div>
                    </div>
                </td>
                <td class="align-middle">₹${productPrice.toFixed(2)}</td>
                <td class="align-middle">
                    <div class="qty">
                        <button class="btn-minus" onclick="updateQuantity('${productId}', '${itemId}', ${quantity - 1}, '${size}')">
                            <i class="fa fa-minus"></i>
                        </button>
                        <input type="text" value="${quantity}" readonly>
                        <button class="btn-plus" onclick="updateQuantity('${productId}', '${itemId}', ${quantity + 1}, '${size}')">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </td>
                <td class="align-middle">₹${(productPrice * quantity).toFixed(2)}</td>
                <td class="align-middle">
                    <button class="btn btn-danger btn-sm" onclick="removeItem('${productId}', '${itemId}', '${size}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    // Initialize selected items
    initializeSelectedItems(cart.items);
    updateSelectedItems();
}

        // Function to initialize all items as selected by default
        function initializeSelectedItems(items) {
            // Store selected items in a global variable
            window.selectedItems = items.map(item => {
                const product = item.product || item;
                return {
                    productId: product._id || item._id,
                    itemId: item._id,
                    size: item.size || product.size || 'N/A',
                    price: parseFloat(product.price) || parseFloat(item.price) || 0,
                    quantity: parseInt(item.quantity) || 1,
                    name: product.name || product.productName || 'Product Name',
                    image:product.image[0]
                };
            });
        }

        // Function to update selected items and recalculate totals
        window.updateSelectedItems = function() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            const selectedItems = [];
            
            checkboxes.forEach(checkbox => {
                selectedItems.push({
                    productId: checkbox.dataset.productId,
                    itemId: checkbox.dataset.itemId,
                    size: checkbox.dataset.size,
                    price: parseFloat(checkbox.dataset.price),
                    quantity: parseInt(checkbox.dataset.quantity),
                    totalPrice: parseFloat(checkbox.dataset.price) * parseInt(checkbox.dataset.quantity),
                    image: checkbox.dataset.image
                });
            });

            // Calculate totals based on selected items only
            const totalItems = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
            const subTotal = selectedItems.reduce((sum, item) => sum + item.totalPrice, 0);
            const shippingCost = selectedItems.length > 0 ? 5 : 0;
            const grandTotal = subTotal + shippingCost;

            // Update displays
            updateItemCountDisplay(totalItems);
            if (subTotalElement) subTotalElement.textContent = `₹${subTotal.toFixed(2)}`;
            if (grandTotalElement) grandTotalElement.textContent = `₹${grandTotal.toFixed(2)}`;

            // Store selected items for checkout
            window.selectedItemsForCheckout = selectedItems;
        };

        function showEmptyCart() {
            if (emptyCartMessage) emptyCartMessage.style.display = 'table-row';
            if (loginMessage) loginMessage.style.display = 'none';
            if (subTotalElement) subTotalElement.textContent = '$0';
            if (grandTotalElement) grandTotalElement.textContent = '$1';
            updateItemCountDisplay(0);
            updateCartCountDisplay();
            
            // Clear selected items
            window.selectedItemsForCheckout = [];
        }

        // ========== UPDATE CART COUNT ==========
        function updateCartCountDisplay() {
            try {
                const cartCount = localStorage.getItem('cartCount') || '0';
                const cartCountElements = document.querySelectorAll('.cart span');
                cartCountElements.forEach(element => {
                    element.textContent = `(${cartCount})`;
                });
            } catch (error) {
                console.error('Error updating cart count display:', error);
                const cartCountElements = document.querySelectorAll('.cart span');
                cartCountElements.forEach(element => {
                    element.textContent = '(0)';
                });
            }
        }

        // ========== UPDATE ITEM COUNT IN SUMMARY ==========
        function updateItemCountDisplay(totalItems) {
            const itemCountElement = document.getElementById('itemCount');
            if (itemCountElement) {
                itemCountElement.textContent = totalItems;
            }
        }

        // ========== FIXED: QUANTITY UPDATE FUNCTIONS ==========
        // Now accepts both productId and itemId
        window.updateQuantity = async function(productId, itemId, newQuantity, size) {
            if (newQuantity < 1) {
                removeItem(productId, itemId, size);
                return;
            }

            const token = localStorage.getItem('token');
            
            if (token) {
                await updateBackendQuantity(productId, newQuantity, size);
            } else {
                updateLocalStorageQuantity(itemId, newQuantity, size);
            }
        };

        // FIXED: Update quantity in backend - use productId not itemId
        async function updateBackendQuantity(productId, newQuantity, size) {
            try {
                console.log('Updating backend quantity for product:', productId, 'quantity:', newQuantity, 'size:', size);
                
                const response = await fetch(`/api/user/cart/updateCart/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quantity: newQuantity,
                        size: size 
                    })
                });

                const data = await response.json();
                console.log('Update response:', data);

                if (data.success) {
                    fetchCartFromBackend();
                } else {
                    alert('Error updating quantity: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Error updating quantity');
            }
        }

        // Update quantity in localStorage - use itemId
        function updateLocalStorageQuantity(itemId, newQuantity, size) {
            try {
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const itemIndex = cart.findIndex(item => 
                    (item._id === itemId || item.product?._id === itemId) && item.size === size
                );

                if (itemIndex > -1) {
                    cart[itemIndex].quantity = newQuantity;
                    if (cart[itemIndex].product && cart[itemIndex].product.price) {
                        cart[itemIndex].totalPrice = cart[itemIndex].product.price * newQuantity;
                    }
                    localStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Update the checkbox data attribute
                    const checkboxes = document.querySelectorAll('.product-checkbox');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.dataset.itemId === itemId && checkbox.dataset.size === size) {
                            checkbox.dataset.quantity = newQuantity;
                        }
                    });
                    
                    updateSelectedItems();
                    updateCartCountDisplay();
                }
            } catch (error) {
                console.error('Error updating localStorage quantity:', error);
                alert('Error updating quantity');
            }
        }

        // ========== FIXED: REMOVE ITEM FUNCTIONS ==========
        // Now accepts both productId and itemId
        window.removeItem = async function(productId, itemId, size) {
            if (!confirm('Are you sure you want to remove this item from your cart?')) return;

            const token = localStorage.getItem('token');
            
            if (token) {
                await removeFromBackend(productId, size);
            } else {
                removeFromLocalStorage(itemId, size);
            }
        };

        // FIXED: Remove from backend - use productId with size query parameter
        async function removeFromBackend(productId, size) {
            try {
                console.log('Removing from backend product:', productId, 'size:', size);
                
                // Backend expects DELETE with productId in URL and size as query parameter
                const response = await fetch(`/api/user/cart/removeCartItem/${productId}?size=${encodeURIComponent(size)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('Remove response:', data);

                if (data.success) {
                    fetchCartFromBackend();
                } else {
                    alert('Error removing item: ' + data.message);
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Error removing item');
            }
        }

        // Remove from localStorage - use itemId
        function removeFromLocalStorage(itemId, size) {
            try {
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                cart = cart.filter(item => !(
                    (item._id === itemId || item.product?._id === itemId) && item.size === size
                ));
                localStorage.setItem('cart', JSON.stringify(cart));
                updateSelectedItems();
                updateCartCountDisplay();
                fetchCartFromLocalStorage();
            } catch (error) {
                console.error('Error removing from localStorage:', error);
                alert('Error removing item');
            }
        }

        // ========== CLEAR CART ==========
        window.clearCart = async function() {
            if (!confirm('Are you sure you want to clear your entire cart?')) return;

            const token = localStorage.getItem('token');
            
            if (token) {
                await clearBackendCart();
            } else {
                clearLocalStorageCart();
            }
        };

        async function clearBackendCart() {
            try {
                const response = await fetch('/api/user/cart', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    fetchCartFromBackend();
                } else {
                    alert('Error clearing cart: ' + data.message);
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                alert('Error clearing cart');
            }
        }

        function clearLocalStorageCart() {
            localStorage.removeItem('cart');
            localStorage.removeItem('cartId');
            localStorage.setItem('cartCount', '0');
            updateItemCountDisplay(0);
            updateCartCountDisplay();
            fetchCartFromLocalStorage();
        }

        // ========== CHECKOUT ==========
  
window.checkout = async function() {
    const token = localStorage.getItem('token');
    const selectedItems = window.selectedItemsForCheckout || [];
    
    if (selectedItems.length === 0) {
        alert('Please select at least one item to checkout!');
        return;
    }
    
    if (!token) {
        alert('Please login to proceed to checkout');
        window.location.href = 'login.html';
        return;
    }
    
    try {
        // 1. Get fresh cart data from backend
        console.log('Fetching fresh cart data for checkout...');
        const response = await fetch('/api/user/cart/getAll', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch cart data');
        }
        
        const cartData = await response.json();
        console.log('Cart data fetched:', cartData);
        
        // 2. Get cart items from response
        const cartItems = cartData.cart?.items || cartData.data?.items || cartData.items || [];
        console.log('Cart items found:', cartItems.length);
        
        // 3. Match selected items with cart items to get COMPLETE data
        const completeSelectedItems = selectedItems.map(selected => {
            // Find the matching cart item
            const cartItem = cartItems.find(item => {
                const itemId = item._id || item.itemId;
                const productId = item.product?._id || item.productId;
                
                return (
                    (selected.productId === productId || selected.itemId === itemId) &&
                    selected.size === item.size
                );
            });
            
            if (cartItem && cartItem.product) {
                console.log('Found matching cart item:', cartItem);
                return {
                    productId: cartItem.product._id || selected.productId,
                    itemId: cartItem._id || selected.itemId, // ✅ FIXED: cartItem._id not item._id
                    size: selected.size,
                    quantity: selected.quantity,
                    price: cartItem.product.price || 0,
                    name: cartItem.product.name || "Product",
                    image: cartItem.product.image || []
                };
            }
            
            // Fallback to selected item if no match found
            console.warn('No matching cart item found for:', selected);
            return {
                ...selected,
                name: selected.name || "Product",
                price: selected.price || 0,
                image: selected.image || []
            };
        });
        
        console.log('Complete selected items for checkout:', completeSelectedItems);
        
        // 4. Save to localStorage
        localStorage.setItem('selectedCheckoutItems', JSON.stringify(completeSelectedItems));
        
        // 5. Also save cart ID if available
        if (cartData._id || cartData.cart?._id) {
            localStorage.setItem('cartId', cartData._id || cartData.cart._id);
        }
        
        console.log('✅ Checkout data saved to localStorage');
        console.log('selectedCheckoutItems:', localStorage.getItem('selectedCheckoutItems'));
        console.log('cartId:', localStorage.getItem('cartId'));
        
        // 6. Navigate to address page
        window.location.href = 'address.html';
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Error preparing checkout. Please try again.');
    }
};
// Initialize cart count
        updateCartCountDisplay();
    });
</script>
    </body>
</html>